import ObjectStreamExceptionimport Serializableimport StreamCorruptedException//@Immutable/** Associates an event that explains latency with a timestamp. ... */stmt...=...long serialVersionUID, ...;// for Spark jobs... == ...new NullPointerException(...)new Annotation(...)/** Microseconds from epoch. ... *//** Usually a short tag indicating an event, like {@code cache.miss} or {@code error} *//** Compares by {@link #timestamp}, then {@link #value}. */int byTimestamp...?...:...... < ...-...timestamp(...)this... != ...compareTo(...)value(...)long timestamp, ...;// See https://github.com/openzipkin/zipkin/issues/1879// clutter below mainly due to difficulty working with Kryo which cannot handle AutoValue subclassString value, ...;super(...)this.timestampthis.value... + ...Annotation that(...)...!......instanceof...... && ...equals(...)int h...*=......^=...... ^ ...... >>> ...hashCode(...)// As this is an immutable object (no default constructor), defer to a serialization proxy.new SerializedForm(...)annotation.timestampannotation.valuecreate(...)IllegalArgumentException enew StreamCorruptedException(...)getMessage(...)/* Copyright 2015-2019 The OpenZipkin Authors ... */import IOExceptionimport Collectionsimport Listimport AtomicReference/** This captures a (usually remote) request and can be used once, either {@link #execute() ... *//** Returns a completed call which has the supplied value. This is useful when input parameters ... */new Constant<V>(...)p0emptyList(...)/** Maps the result of this call into a different shape, as defined by the {@code mapper} function. ... */new Mapping<R,V>(...)/** Maps the result of this call into another, as defined by the {@code flatMapper} function. This ... */new FlatMapping<R,V>(...)/** Attempts to resolve an error. The user must call the callback. *//** Returns a call which can attempt to resolve an exception. This is useful when a remote call ... */new ErrorHandling<V>(...)// Taken from RxJava throwIfFatal, which was taken from scala/** Invokes a request, returning a success value or propagating an error to the caller. Invoking ... *//** Invokes a request asynchronously, signaling the {@code callback} when complete. Invoking this ... */// Implementing might throw an IOException on execute or callback.onError(IOException)// Boolean isn't returned because some implementations may cancel asynchronously./** Requests to cancel this call, even if some implementations may not support it. For example, a ... */// asynchronous bindings, such as rxjava2// isCanceled exists while isExecuted does not because you do not need the latter to implement/** Returns true if {@linkplain #cancel()} was called. ... *//** Returns a copy of this object, so you can make an identical follow-up request. */V v, ...;// not final for mock testingthis.vonSuccess(...)new Constant(...)Constant<> thatthat.vMapper<V,R> mapper, ...;Call<V> delegate, ...;this.mapperthis.delegatemap(...)execute(...)enqueue(...)new (...)new Callback<V>(...) { ... }Throwable tonError(...)new Mapping(...)clone(...)FlatMapper<V,R> flatMapper, ...;Call<R> mapped, ...;this.flatMapperpropagateIfFatal(...)cancel(...)new FlatMapping(...)new Object(...)Object SENTINEL, ...;ErrorHandler<V> errorHandler, ...;// to differentiate from nullthis.errorHandlerIOException ehandleError(...)RuntimeException eError eAtomicReference<> refnew AtomicReference<>(...)Object resultget(...)onErrorReturn(...)set(...)new ErrorHandling(...)boolean canceled, ...;boolean executed, ...;this.executednew IllegalStateException(...)isCanceled(...)new IOException(...)doExecute(...)doEnqueue(...)this.canceleddoCancel(...)... || ...doIsCanceled(...)/* Copyright 2015-2020 The OpenZipkin Authors ... */import Nullable/** A callback of a single result or error. ... *//** Invoked when computation produces its potentially null value successfully. ... *//** Invoked when computation produces a possibly null value successfully. ... */// @Immutable/** Answers the question: Are operations on this component likely to succeed? ... */new CheckResult(...)CheckResult OK, ...;/** Present when not ok */boolean ok, ...;Throwable error, ...;this.okthis.errorimport Closeable/** Components are object graphs used to compose a zipkin service or client. For example, a storage ... */CheckResult.OK/** Closes any network resources created implicitly by the component. ... */import Charsetimport Localeimport DependencyLinkBytesDecoderimport DependencyLinkBytesEncoder/** A dependency link is an edge between two services. */forName(...)Charset UTF_8, ...;// for Spark and Flink jobs// pre-Java 1.8new Builder(...)/** The parent service name (caller), {@link Span#localServiceName()} if instrumented. *//** The chold service name (callee), {@link Span#localServiceName()} if instrumented. *//** Total traced calls made from {@link #parent} to {@link #child} *//** {@linkplan #callCount Count of calls} known to be errors (having one {@linkplain Span#tags() ... */String parent, ...;long callCount, ...;this.parentsource.parentthis.childsource.childthis.callCountsource.callCountthis.errorCountsource.errorCount/** @see */toLowerCase(...)Locale.ROOTString missing...+=...new DependencyLink(...)new String(...)encode(...)DependencyLinkBytesEncoder.JSON_V1builder.parentbuilder.childbuilder.callCountbuilder.errorCountDependencyLink thatthat.parentthat.childthat.callCountthat.errorCount// This is an immutable object, and our encoder is faster than java's: use a serialization proxy....[] bytes, ...;...[]this.bytesdecodeOne(...)DependencyLinkBytesDecoder.JSON_V1import Inet4Addressimport Inet6Addressimport InetAddressimport ByteBufferimport RecyclableBuffersimport static HexCodec.HEX_DIGITS/** The network context of a node in the service graph. *//** Lower-case label of this node in the service graph, such as "favstar". Leave absent if ... *//** The text representation of the primary IPv4 address associated with this a connection. Ex. ... *//** IPv4 endpoint address packed into 4 bytes or null if unknown. ... *//** The text representation of the primary IPv6 address associated with this a connection. Ex. ... *//** IPv6 endpoint address packed into 16 bytes or null if unknown. ... *//** Port of the IP's socket or null, if not known. ... *//** Like {@link #port()} except returns a primitive where zero implies absent. ... */String serviceName, ...;...[] ipv4Bytes, ...;int port, ...;// zero means nullsource.serviceNamesource.ipv4source.ipv6source.ipv4Bytessource.ipv6Bytessource.port/** Sets {@link Endpoint#serviceName} */this.serviceNameisEmpty(...)/** Chaining variant of {@link #parseIp(InetAddress)} */parseIp(...)/** Returns true if {@link Endpoint#ipv4()} or {@link Endpoint#ipv6()} could be parsed from the ... */getHostAddress(...)getAddress(...)byte[] addressBytesparseEmbeddedIPv4(...)writeIpV6(...)/** Like {@link #parseIp(String)} except this accepts a byte array. ... */ipBytes.lengthwriteIpV4(...)char[] bufshortStringBuffer(...)int poswriteBackwards(...)... & ......[...]...++int iint digit... % ...--....../=.../** Chaining variant of {@link #parseIp(String)} */IpFamily formatdetectFamily(...)IpFamily.IPv4getIpv4Bytes(...)IpFamily.IPv4Embeddedsubstring(...)lastIndexOf(...)IpFamily.IPv6textToNumericFormatV6(...)/** Use this to set the port to an externally defined value. ... */... > ...new IllegalArgumentException(...)... <= ...this.port/** Sets {@link Endpoint#portAsInt()} */new Endpoint(...)int flag... | ...... << ...byte o1byte o2byte o3byte o4valueOf(...)new byte[]{...}new IpFamily(...)IpFamily Unknown, ...;IpFamily IPv4, ...;IpFamily IPv4Embedded, ...;IpFamily IPv6, ...;/** Adapted from code in {@code com.google.common.net.InetAddresses.ipStringToBytes}. This version ... */boolean hasColonboolean hasDotint lengthlength(...)char ccharAt(...)IpFamily.UnknownnotHex(...)int lastColonIndexisValidIpV4Address(...)int zeroCompressionIndexint zeroCompressionLengthint zeroIndexboolean allZerosipv6.length... >= ...int zeroLength... - ...byte highbyte lowboolean leadingZerochar val... >> ...int IPV6_PART_COUNT, ...;// Begin code from com.google.common.net.InetAddresses 23String[] partssplit(...)int skipIndexint partsHiint partsLoint partsSkippedByteBuffer rawBytesallocate(...)... * ...parts.lengthputShort(...)parseHextet(...)...--NumberFormatException exarray(...)int hextetparseInt(...)new NumberFormatException(...)// Begin code from io.netty.util.NetUtil 4.1// End code from com.google.common.net.InetAddresses 23int lenisValidIpV4Word(...)indexOf(...)char c0char c1char c2isValidNumericChar(...)// End code from io.netty.util.NetUtil 4.1builder.serviceNamebuilder.ipv4builder.ipv4Bytesbuilder.ipv6builder.ipv6Bytesbuilder.portserializedForm.serviceNameserializedForm.ipv4serializedForm.ipv4BytesserializedForm.ipv6serializedForm.ipv6BytesserializedForm.portEndpoint thatthat.serviceNamethat.ipv4that.ipv6that.port// TODO: replace this with native proto3 encodingendpoint.serviceNameendpoint.ipv4endpoint.ipv4Bytesendpoint.ipv6endpoint.ipv6Bytesendpoint.portbyte[] resultchar chint octet// We write backwards from right to left.// ensures consistent format// Embedded IPv4 addresses start with unset 80 bits// IPv4-Compatible or IPv4-Mapped// ::1 is localhost, not an embedded compat address// Colons must not appear after dots.// Everything else must be a decimal or hex digit.// Now decide which address family to parse.// compressed like ::1.2.3.4// Compress the longest string of zeros// handle all zeros: 0:0:0:0:0:0:0:0 -> ::// handle trailing zeros: 2001:0:0:4:0:0:0:0 -> 2001:0:0:4::// handle leading zeros: 2001:0:0:4:0000:0:0:8 -> 2001:0:0:4::8// An address can have [2..8] colons, and N colons make N+1 parts.// Disregarding the endpoints, find "::" with nothing in between.// This indicates that a run of zeroes has been skipped.// Can't have more than one ::// Number of parts to copy from above/before the "::"// Number of parts to copy from below/after the "::"// If we found a "::", then check if it also covers the endpoints.// ^: requires ^::// :$ requires ::$// Otherwise, allocate the entire address to partsHi. The endpoints// could still be empty, but parseHextet() will check for that.// If we found a ::, then we must have skipped at least one part.// Otherwise, we must have exactly the right number of parts.// Now parse the hextets into a byte array.// Note: we already verified that this string contains only hex digits.// then we have a single digit octet// push the decimal// then we have a two digit octet// otherwise, we have a three digit octet// skip the dotimport ArrayListimport Arraysimport LinkedHashMapimport Mapimport TreeMapimport Loggerimport SpanBytesDecoderimport SpanBytesEncoderimport static String.formatimport static Level.FINEST/** A span is a single-host view of an operation. A trace is a series of spans (often RPC calls) ... */build(...)newBuilder(...)char[] zerosnew char[]fill(...)Endpoint EMPTY_ENDPOINT, ...;int FLAG_DEBUG, ...;int FLAG_DEBUG_SET, ...;int FLAG_SHARED, ...;int FLAG_SHARED_SET, ...;/** Trace identifier, set on all spans within it. ... *//** The parent's {@link #id} or null if this the root span in a trace. ... *//** Unique 64bit identifier for this operation within the trace. ... *//** Indicates the primary span type. */new Kind(...)Kind CLIENT, ...;Kind SERVER, ...;Kind PRODUCER, ...;/** When present, {@link #timestamp()} is the moment a producer sent a message to a destination. ... */Kind CONSUMER, ...;/** When present, {@link #timestamp()} is the moment a consumer received a message from an ... *//** When present, used to interpret {@link #remoteEndpoint} *//** Span name in lowercase, rpc method for example. ... *//** Epoch microseconds of the start of this span, possibly absent if this an incomplete span. ... *//** Like {@link #timestamp()} except returns a primitive where zero implies absent. ... *//** Measurement in microseconds of the critical path, if known. Durations of less than one ... *//** Like {@link #duration()} except returns a primitive where zero implies absent. ... */// Nullable for data conversion especially late arriving data which might not have an annotation/** The host that recorded this span, primarily for query by service name. ... *//** When an RPC (or messaging) span, indicates the other side of the connection. ... *//** Events that explain latency with a timestamp. Unlike log statements, annotations are often ... *//** Tags a span with context, usually to support query or aggregation. ... *//** True is a request to store this span even if it overrides sampling policy. *//** True if we are contributing to a span started by another tracer (ex on a different host). ... */Endpoint localEndpointlocalEndpoint(...)serviceName(...)Endpoint remoteEndpointremoteEndpoint(...)String traceId, ...;Kind kind, ...;String name, ...;Endpoint localEndpoint, ...;ArrayList<Annotation> annotations, ...;TreeMap<String,String> tags, ...;int flags, ...;// bit field for timestamp and durationclear(...)p2p3p4p5p6p7p8p9p10p11p12p13p14p15p16p17p18p19Builder resultresult.traceIdresult.parentIdresult.idresult.kindresult.nameresult.timestampresult.durationresult.localEndpointresult.remoteEndpointresult.annotationsresult.tagsresult.flags<obinit>(...)source.traceIdsource.parentIdsource.idsource.kindsource.namesource.timestampsource.durationsource.localEndpointsource.remoteEndpointsource.annotationsnew ArrayList<Annotation>(...)size(...)addAll(...)source.tagsnew TreeMap<String,String>(...)putAll(...)source.flags/** Used to merge multiple incomplete spans representing the same operation on the same host. Do ... */merge(...)toBuilder(...)/** Sets {@link Span#id()} or throws {@link IllegalArgumentException} if not lower-hex format. */this.traceIdnormalizeTraceId(...)/** Encodes 64 or 128 bits from the input into a hex trace ID. ... */char[] datawriteHexLong(...)/** Hex encodes the input as the {@link Span#parentId()} or unsets if the input is zero. */this.parentIdtoLowerHex(...)/** Sets {@link Span#parentId()} or throws {@link IllegalArgumentException} if not lower-hex ... */validateHexAndReturnZeroPrefix(...)padLeft(...)/** Hex encodes the input as the {@link Span#id()} or throws IllegalArgumentException if the ... */this.id/** Sets {@link Span#kind} */this.kind/** Sets {@link Span#name} */this.name/** Sets {@link Span#timestampAsLong()} *//** Sets {@link Span#timestamp()} *//** Sets {@link Span#durationAsLong()} */this.duration/** Sets {@link Span#duration()} *//** Sets {@link Span#localEndpoint} */this.localEndpoint/** Sets {@link Span#remoteEndpoint} */this.remoteEndpoint/** Sets {@link Span#annotations} */add(...)/** Sets {@link Span#tags} */put(...)this.tags/** Sets {@link Span#debug} */...|=......&=...~...debug(...)/** Sets {@link Span#shared} */shared(...)Logger loggergetLogger(...)getName(...)Span.classisLoggable(...)fine(...)format(...)Kind.CLIENTnew Span(...)SpanBytesEncoder.JSON_V2/** Returns a valid lower-hex trace ID, padded left as needed to 16 or 32 characters. ... */int zerosnew RuntimeException(...)String THIRTY_TWO_ZEROS, ...;int numZerosgetChars(...)/** Inspired by {@code okio.Buffer.writeLong} */writeHexByte(...)boolean inZeroPrefix? ...Object[] arraytoArray(...)int jList<> resultasList(...)copyOf(...)singletonList(...)sort(...)array.length++...unmodifiableList(...)// Custom impl to reduce GC churn and Kryo which cannot handle AutoValue subclass// zero means null, saving 2 object referencesList<Annotation> annotations, ...;Map<String,String> tags, ...;// bit field for timestamp and duration, saving 2 object referencesbuilder.traceIdbuilder.parentIdbuilder.idbuilder.kindbuilder.namebuilder.timestampbuilder.durationbuilder.localEndpointbuilder.remoteEndpointsortedList(...)builder.annotationsemptyMap(...)new LinkedHashMap<String,String>(...)builder.tagsbuilder.flagsSpan thatthat.traceIdthat.parentIdthat.idthat.kindthat.namethat.timestampthat.durationthat.localEndpointthat.remoteEndpointthat.annotationsthat.tagsthat.flagsSpanBytesEncoder.PROTO3SpanBytesDecoder.PROTO3// edge case, so don't require a logger field// shared is for the server side, unset it if accidentally set on the client side// dedupe// prevent self-referencing spansimport BytesDecoder// .. As ThriftSpan has no STRUCT fields: so, if the first byte is TType.STRUCT(12), it is a list.// .. When serializing a List[ThriftSpan], the first byte is the member type, TType.STRUCT(12)// .. When serializing a Span (Struct), the first byte will be the type of a field// When byte(0) <= 16, assume it is a TBinaryProtocol-encoded thrift// When byte(0) == 10, assume it is a proto3-encoded span or trace ID field// When byte(0) == '[' (91), assume it is a list of json-encoded spans// .. If the first byte isn't in that range, it isn't a thrift.// In TBinaryProtocol encoding, the first byte is the TType, in a range 0-16/** Detecting decoder used in transports which don't include means to identify the type of the data. ... */...[] ENDPOINT_FIELD_SUFFIX, ...;/** Zipkin v2 json will have "localEndpoint" or "remoteEndpoint" fields, and others won't. ... */...[] TAGS_FIELD, ...;/** Technically, it is possible to have a v2 span with no endpoints. This should catch the case ... *//** Throws {@link IllegalArgumentException} if the input isn't a v1 json or thrift single-span ... */BytesDecoder<Span> decoderdetectDecoder(...)wrap(...)SpanBytesDecoder.JSON_V2new UnsupportedOperationException(...)/** Throws {@link IllegalArgumentException} if the input isn't a json, proto3 or thrift list ... */decoderForListMessage(...)byte firstposition(...)protobuf3(...)/** @throws */SpanBytesDecoder.THRIFTcontains(...)SpanBytesDecoder.JSON_V1remaining(...)subsequence.length/* span key or trace ID key *//* List[ThriftSpan] *//* openzipkin/zipkin-reporter-java#133 */// binary format/* the first byte is the TType, in a range 0-16 */// varint follows and won't be zeroimport Collection// set to dedupe redundant messages.// collections. This receives collection as opposed to list as zipkin-dependencies decodes into a// This receives a collection, not a function because it profiles 10% faster and all use cases are/** This type accepts a collection that receives decoded elements. ... */// used by zipkin-dependencies which reads elements one-at-a-time from ES documents/** This is used seldomly as the canonical message form is a {@link #decodeList(byte[], Collection) ... *//** Visible for testing. This returns the first element parsed from the serialized object or null *//** Returns {@code true} if an element was decoded or throws {@link IllegalArgumentException}. *//** Convenience method for {@link #decodeList(byte[], Collection)} *//** Utility for encoding one or more elements of a type into a byte array. ... *//** Serializes an object into its binary form. *//** Serializes a list of objects into their binary form. */import DependencyLinkimport JsonCodecimport JsonReaderimport JsonReaderAdapterimport ReadBuffernew DependencyLinkBytesDecoder(...) { ... }Encoding.JSONread(...)readOne(...)readList(...)List<DependencyLink> outnew ArrayList<DependencyLink>(...)decodeList(...)new JsonReaderAdapter<DependencyLink>(...) { ... }DependencyLink.BuilderbeginObject(...)hasNext(...)String nextNamenextName(...)parent(...)nextString(...)child(...)callCount(...)nextLong(...)errorCount(...)skipValue(...)endObject(...)DependencyLinkBytesDecoder JSON_V1, ...;JsonReaderAdapter<DependencyLink> READER, ...;import WriteBufferimport Writerimport static JsonEscaper.jsonEscapeimport static JsonEscaper.jsonEscapedSizeInBytesimport static WriteBuffer.asciiSizeInBytesnew DependencyLinkBytesEncoder(...) { ... }sizeInBytes(...)write(...)writeList(...)new Writer<DependencyLink>(...) { ... }int sizeInBytesjsonEscapedSizeInBytes(...)asciiSizeInBytes(...)writeAscii(...)writeUtf8(...)jsonEscape(...)writeByte(...)DependencyLinkBytesEncoder JSON_V1, ...;Writer<DependencyLink> WRITER, ...;// {"parent":"","child":"","callCount":}// ,"errorCount":// DataDog which has a message pack encoding.// ZIPKIN3 make this not an enum as it prevents non-standard encoding, for example reporting tonew Encoding(...) { ... }/** Encoding overhead of a single element is brackets *//** Encoding overhead is brackets and a comma for each span over 1 */get(...).length/** The first format of Zipkin was TBinaryProtocol, big-endian thrift. It is no longer used, but ... *//** Encoding overhead is thrift type plus 32-bit length prefix *//** Repeated (type 2) fields are length-prefixed. A list is a concatenation of fields with no ... *//** Returns the input as it is assumed to be length-prefixed field from a protobuf message *//** Returns a concatenation of sizes */Encoding JSON, ...;Encoding THRIFT, ...;Encoding PROTO3, ...;/** Like {@link #listSizeInBytes(List)}, except for a single element. */// bracketsimport Spanimport Proto3Codecimport ThriftCodecimport V1JsonSpanReaderimport V2SpanReaderimport V1Spanimport V1SpanConverter/** This is separate from {@link SpanBytesEncoder}, as it isn't needed for instrumentation */new SpanBytesDecoder(...) { ... }/** Corresponds to the Zipkin v1 json format */Span resultnew V1JsonSpanReader(...)wrapUnsafe(...)V1Span v1List<Span> outnew ArrayList<Span>(...)convert(...)doDecodeList(...)/** Corresponds to the Zipkin v1 thrift format */Encoding.THRIFT/** Corresponds to the Zipkin v2 json format */new V2SpanReader(...)Encoding.PROTO3SpanBytesDecoder JSON_V1, ...;SpanBytesDecoder THRIFT, ...;SpanBytesDecoder JSON_V2, ...;SpanBytesDecoder PROTO3, ...;/** ByteBuffer implementation of {@link #decodeList(byte[])}. ... *//** ByteBuffer implementation of {@link #decodeOne(byte[])} ... */// because span is immutable// ex DependencyLinker// ex getTraceimport V1JsonSpanWriterimport V1ThriftSpanWriterimport V2SpanWriter/** Limited interface needed by those writing span reporters */new SpanBytesEncoder(...) { ... }/** Corresponds to the Zipkin v1 json format (with tags as binary annotations) */new V1JsonSpanWriter(...)new V1ThriftSpanWriter(...)new V2SpanWriter(...)V2SpanWriter writer, ...;new Proto3Codec(...)Proto3Codec codec, ...;SpanBytesEncoder JSON_V1, ...;SpanBytesEncoder THRIFT, ...;SpanBytesEncoder JSON_V2, ...;SpanBytesEncoder PROTO3, ...;/** Allows you to encode a list of spans onto a specific offset. For example, when nesting */import AtomicIntegerimport Levelimport Callimport Callback/** A call that blocks on others to complete before invoking a callback or returning from {@link ... */Call<>.Base<O>getClass(...)new AggregateVoidCall(...)boolean empty, ...;cloneCalls(...)Logger log, ...;List<Call<I>> delegate, ...;/** Customizes the aggregated result. For example, summarizing or making immutable. */Throwable firstErrorO resultnewOutput(...)Call<I> callappend(...)Throwable eLevel.INFOlog(...)finish(...)AtomicInteger remainingnew AtomicInteger(...)AtomicReference<> firstErrornew CountdownCallback(...)Call<I> call, ...;AtomicInteger remaining, ...;AtomicReference<Throwable> firstError, ...;O result, ...;Callback<O> callback, ...;this.callthis.remainingthis.firstErrorthis.resultthis.callbackThrowable errordecrementAndGet(...)compareAndSet(...)List<Call<I>> resultnew ArrayList<Call<I>>(...)import Calendarimport Dateimport TimeZoneimport TimeUnitgetTimeZone(...)TimeZone UTC, ...;/** For bucketed data floored to the day. For example, dependency links. */Calendar daygetInstance(...)setTimeInMillis(...)Calendar.MILLISECONDCalendar.SECONDCalendar.MINUTECalendar.HOUR_OF_DAYgetTimeInMillis(...)long tomidnightUTC(...)long startMillislong fromList<Long> daysnew ArrayList<Long>(...)long timetoMillis(...)TimeUnit.DAYS// >= 1970import ConcurrentHashMapimport DelayQueueimport Delayed// this is a dependency-free variant formerly served by an expiring guava cache/** Limits invocations of a given context to at most once per period. */new ConcurrentHashMap<C,Suppression<C>>(...)new DelayQueue<Suppression<C>>(...)TimeUnit.MILLISECONDSlong ttl, ...;TimeUnit ttlUnit, ...;int cardinality, ...;/** When {@link #shouldInvoke(Object)} returns true, it will return false until this duration ... */this.ttlthis.ttlUnit/** This bounds suppressions, useful because contexts can be accidentally unlimited cardinality. */this.cardinalitynew DelayLimiter<C>(...)new SuppressionFactory(...)toNanos(...)SuppressionFactory suppressionFactory, ...;ConcurrentHashMap<C,Suppression<C>> cache, ...;DelayQueue<Suppression<C>> suppressions, ...;this.suppressionFactory/** Returns true if a given context should be invoked. */Suppression<C> suppressioncleanupExpiredSuppressions(...)containsKey(...)putIfAbsent(...)offer(...)removeOneSuppression(...)Suppression<C> eldestpeek(...)remove(...)eldest.contextSuppression<C> expiredSuppressionpoll(...)expiredSuppression.contextlong ttlNanos, ...;// not final for teststhis.ttlNanosnanoTime(...)new Suppression<C>(...)SuppressionFactory factory, ...;C context, ...;long expiration, ...;this.factorythis.contextthis.expirationTimeUnit.NANOSECONDSsignum(...)(...).expiration// lost race// If we added an entry, it could make us go over the max size.// loop unless empty// check for lost race// to ensure we don't remove two!import static ThriftCodec.skipimport static ThriftField.TYPE_I64import static ThriftField.TYPE_LISTimport static ThriftField.TYPE_STOPimport static ThriftField.TYPE_STRINGimport static WriteBuffer.utf8SizeInBytes/** Internal as only cassandra serializes the start and end timestamps along with link data, and ... */new ThriftField(...)new DependencyLinkAdapter(...)ThriftField START_TS, ...;ThriftField END_TS, ...;ThriftField LINKS, ...;DependencyLinkAdapter DEPENDENCY_LINK_ADAPTER, ...;/** Reads from buffer serialized in TBinaryProtocol */long startTslong endTsList<DependencyLink> linksReadBuffer bufferThriftField thriftFieldthriftField.typeisEqualTo(...)readLong(...)readListLength(...)skip(...)/** Writes the current instance in TBinaryProtocol */listSizeInBytes(...)writeLong(...)/** timestamps are in epoch milliseconds */new Dependencies(...)long startTs, ...;List<DependencyLink> links, ...;this.startTsthis.endTsthis.linksDependencies thatthat.startTsthat.endTsthat.linksWriteBuffer.Writer<DependencyLink>ThriftField PARENT, ...;ThriftField CHILD, ...;ThriftField CALL_COUNT, ...;ThriftField ERROR_COUNT, ...;readUtf8(...)readInt(...)utf8SizeInBytes(...)writeLengthPrefixed(...)// START_TS// END_TS// TYPE_STOP// CALL_COUNT// ERROR_COUNTimport Iteratorimport Kindimport static Level.FINE/** This parses a span tree into dependency links used by Web UI. Ex. http://zipkin/dependency ... */new LinkedHashMap<Pair,Long>(...)Logger logger, ...;SpanNode.Builder builder, ...;SpanNode.BuilderMap<Pair,Long> callCounts, ...;Map<Pair,Long> errorCounts, ...;this(...)DependencyLinker.classthis.loggerthis.builder/** All {@code spans} must have the same trace id. */SpanNode traceTreeIterator<SpanNode> itraverse(...)SpanNode currentnext(...)Span currentSpanspan(...)Kind kindkind(...)String serviceNamelocalServiceName(...)String remoteServiceNameremoteServiceName(...)String childString parentboolean isErrortags(...)Span remoteAncestorfirstRemoteAncestor(...)String remoteAncestorNamechildren(...)Kind.PRODUCERKind.CONSUMERaddLink(...)Kind.SERVERparentId(...)id(...)SpanNode ancestorSpan maybeRemotePair keynew Pair(...)link(...)/** links are merged by mapping to parent/child and summing corresponding links */Map<Pair,Long> callCountsMap<Pair,Long> errorCountsDependencyLink linkPair parentChildlong callCountlong errorCountList<DependencyLink> resultEntry<Pair,Long> entryMap<>.Entry<Pair,Long>entrySet(...)getKey(...)getValue(...)parentChild.rightparentChild.leftString left, ...;this.leftthis.rightPair thatDependencyLinker.Pairthat.leftthat.rightint h$// When processing links to a client span, we prefer the server's name. If we have no child// spans, we proceed to use the name the client chose.// Treat unknown type of span as a client span if we know both sides// we are the root-most span.// Local spans may be between the current node and its remote parent// Some users accidentally put the remote service name on client annotations.// Check for this and backfill a link from the nearest remote to that service as necessary.// we don't know if there's an error here// When an RPC is split between spans, we skip the child (server side). If our parent is a// client, we need to check it for errors.import QueryRequestCall<>.Mapper<List<List<Span>>,List<List<Span>>>/** Filters the mutable input based on the query */new FilterTraces(...)QueryRequest request, ...;this.requestArrayList<List<Span>> resultnew ArrayList<List<Span>>(...)List<Span> nexttest(...)// code originally imported from zipkin.Util...[] HEX_DIGITS, ...;/** Parses a 1 to 32 character lower-hex string with no prefix into an unsigned long, tossing any ... */int beginIndexisntLowerHexLong(...)lowerHexToUnsignedLong(...)/** Parses a 16 character lower-hex string with no prefix into an unsigned long, starting at the ... */long resultint endIndexmin(...)...<<=...// trim off any high bitsimport InputStreamReaderimport static JsonToken.BOOLEANimport static JsonToken.NULLimport static JsonToken.STRING/** This explicitly constructs instances of model classes via manual parsing for a number of ... */// Hides gson types for internal use in other submodulesJsonReader delegate, ...;new JsonReader(...)new InputStreamReader(...)beginArray(...)endArray(...)getPath(...)nextBoolean(...)nextInt(...)toString(...)available(...)fromJson(...)Exception eexceptionReading(...)List<T> outnew ArrayList<T>(...)JsonReader readerWriteBuffer.Writer<T>/** Inability to encode is a programming bug. */WriteBuffer bint lengthWrittenresult.lengthString messagegetSimpleName(...)AssertionError errornew AssertionError(...)initCause(...)int initialPosWriteBuffer resultpos(...)String cause// TODO: could make single-element list w/o array// []// comma to join elements// Don't use value directly in the message, as its toString might be implemented using this// method. If that's the case, we'd stack overflow. Instead, emit what we've written so far.new String[]/** Exposed for ElasticSearch HttpBulkIndexer */int afterReplacementStringBuilder builderString replacementnew StringBuilder(...)...[] REPLACEMENT_CHARS, ...;/* Escaping logic adapted from Moshi, which we couldn't use due to language level ... */String U2028, ...;String U2029, ...;boolean asciiint escapingOverheadString maybeReplacement// write characters between the last replacement and now// then we didn't escape anything/** Libraries such as Guice and AutoValue will process any annotation named {@code Nullable}. This ... */RetentionPolicy.RUNTIMEimport static Proto3ZipkinFields.SPANnew Proto3SpanWriter(...)Proto3SpanWriter writer, ...;Span spanimport Endpointimport static WriteBuffer.varintSizeInBytes/** Everything here assumes the field numbers are less than 16, implying a 1 byte tag. */int WIRETYPE_VARINT, ...;/** Define the wire types, except the deprecated ones (groups) ... */int fieldNumber, ...;int wireType, ...;int key, ...;/** "Each key in the streamed message is a varint with the value {@code (field_number << 3) | ... */this.fieldNumberthis.wireTypethis.keyint fieldNumberint wireTypeint remainingreadVarint32(...)readByte(...)/** Leniently skips out null, but not on empty string, allowing tag "error" -> "" to serialize ... */int sizeOfValuesizeOfValue(...)sizeOfLengthDelimitedField(...)writeVarint(...)writeValue(...)/** Calling this after consuming the field key to ensures there's enough space for the data. Null ... */readValue(...)/** @param */bytes.lengthreadBytes(...)... / ...int d1decodeLowerHex(...)int d2readBytesAsHex(...)writeLongLe(...)readLongLe(...)varintSizeInBytes(...)byte bool// added for completion as later we will skip fields we don't use// length prefix// similar logic to okio.ByteString.decodeHex// bug// tag + 8 byte number// tag + varint// tag + 4 byte number// tag + len + bytesimport static Proto3Fields.sizeOfLengthDelimitedFieldWriteBuffer.Writer<Span>...[] EMPTY_ARRAY, ...;/** Encodes per ListOfSpans data wireType, where field one is repeated spans */int lengthOfSpansint[] sizeOfValuesnew int[]WriteBuffer writeBufferwriteSpan(...)// prevents resizing twiceSPAN.keyimport Annotationimport BooleanFieldimport Utf8Fieldimport static Proto3Fields.BytesFieldimport static Field.fieldNumberimport static Field.skipValueimport static Field.wireTypeimport static Proto3Fields.Fixed64Fieldimport static Proto3Fields.HexFieldimport static Proto3Fields.LengthDelimitedFieldimport static Proto3Fields.VarintFieldimport static Proto3Fields.WIRETYPE_FIXED64import static Proto3Fields.WIRETYPE_LENGTH_DELIMITEDimport static Proto3Fields.WIRETYPE_VARINT/** Keys are used in this class because while verbose, it allows us to use switch statements */Proto3ZipkinFields.classnew SpanField(...)Logger LOG, ...;SpanField SPAN, ...;/** This is the only field in the ListOfSpans type */new Utf8Field(...)new BytesField(...)new VarintField(...)int SERVICE_NAME_KEY, ...;int IPV4_KEY, ...;int IPV6_KEY, ...;int PORT_KEY, ...;Utf8Field SERVICE_NAME, ...;BytesField IPV4, ...;BytesField IPV6, ...;VarintField PORT, ...;int resultipv4Bytes(...)ipv6Bytes(...)portAsInt(...)int endPosEndpoint.BuilderBuilder builderint nextKeyreadLengthPrefixAndValue(...)port(...)logAndSkip(...)/** Contributes to a builder as opposed to reading values directly. Avoids allocation. */Span.Buildernew Fixed64Field(...)int TIMESTAMP_KEY, ...;int VALUE_KEY, ...;Fixed64Field TIMESTAMP, ...;Utf8Field VALUE, ...;long timestampString valueaddAnnotation(...)Map<>.Entry<String,String>int KEY_KEY, ...;// map<string,string> in proto is a special field with key, valueUtf8Field KEY, ...;String keyString readputTag(...)new HexField(...)new EndpointField(...)new AnnotationField(...)new TagField(...)new BooleanField(...)int TRACE_ID_KEY, ...;int PARENT_ID_KEY, ...;int ID_KEY, ...;int KIND_KEY, ...;int NAME_KEY, ...;int DURATION_KEY, ...;int LOCAL_ENDPOINT_KEY, ...;int REMOTE_ENDPOINT_KEY, ...;int ANNOTATION_KEY, ...;int TAG_KEY, ...;int DEBUG_KEY, ...;int SHARED_KEY, ...;HexField TRACE_ID, ...;HexField PARENT_ID, ...;HexField ID, ...;VarintField KIND, ...;Utf8Field NAME, ...;VarintField DURATION, ...;EndpointField LOCAL_ENDPOINT, ...;EndpointField REMOTE_ENDPOINT, ...;AnnotationField ANNOTATION, ...;TagField TAG, ...;BooleanField DEBUG, ...;BooleanField SHARED, ...;int sizeOfSpantraceId(...)List<Annotation> annotationsannotations(...)int annotationCountMap<String,String> tagsint tagCountname(...)timestampAsLong(...)durationAsLong(...)Entry<String,String> entryBoolean.TRUEint annotationLengthtoByte(...)SpanField.DEBUGSpanField.SHARED// in java, there's no zero index for unknownSpan.Kindordinal(...)require(...)int kindvalues(...).lengthvalues(...)duration(...)readVarint64(...)int nextWireTypewireType(...)int nextFieldNumberfieldNumber(...)// now, we are in the endpoint fields// now, we are in the annotation fields// now, we are in the tag fields// empty tags allowed// avoid allocating an iterator when empty// toss the key// more convenient to check up-front vs partially read// now, we are in the span fieldsimport InputStreamimport ByteOrderimport static JsonCodec.UTF_8/** Read operations do bounds checks, as typically more errors occur reading than writing. *//** Do not use the buffer passed here after, as it may be manipulated directly. */hasArray(...)int offsetarrayOffset(...)new BigEndianByteBuffer(...)new LittleEndianByteBuffer(...)order(...)ByteOrder.BIG_ENDIANnew Array(...)ReadBuffer.ArraygetShort(...)getInt(...)getLong(...)reverseBytes(...)ByteBuffer buf, ...;// visible for testingthis.bufbyte[] copymark(...)byte breset(...)int toReadcheckReadArguments(...)int skippedmax(...)...[] buf, ...;int arrayOffset, ...;this.arrayOffsetthis.offsetthis.lengtharraycopy(...)String result/** Code is optimized for little endian as proto is the encouraged format. */int toSkip/** only use when you've already ensured the length you need is available */readByteUnsafe(...)char[] bufferRecyclableBuffers.SHORT_STRING_LENGTHdoReadUtf8(...)tryReadAscii(...)char[] resultint hexLength// included in the main api as this is used commonly, for example reading proto tags/** @return ... */dst.lengthnew IndexOutOfBoundsException(...)// Not 7-bit ASCII character// ex error tag with no value// Speculatively assume all 7-bit ASCII characters.. common in normal tags and names// All our hex fields are at most 32 characters.// negative number implies MSB setnew ThreadLocal<char[]>(...)ThreadLocal<char[]> SHORT_STRING_BUFFER, ...;int SHORT_STRING_LENGTH, ...;/** Maximum character length constraint of most names, IP literals and IDs. *//** Returns a {@link ThreadLocal} reused {@code char[]} for use when decoding bytes into hex, IP ... */char[] shortStringBufferimport ArrayDequeimport Comparatorimport NoSuchElementException/** Convenience type representing a trace tree. Multiple Zipkin features require a trace tree. For ... */new Comparator<SpanNode>(...) { ... }long xlong yComparator<SpanNode> NODE_COMPARATOR, ...;SpanNode parent, ...;/** Set via {@link #addChild(SpanNode)} */Span span, ...;/** Null when a synthetic root node */List<SpanNode> children, ...;/** mutable to avoid allocating lists for childless nodes */this.span/** Returns the parent, or null if root *//** Returns the span, or null if a synthetic root node *//** Returns the children of this node. *//** Traverses the tree, breadth-first. */new BreadthFirstIterator(...)new ArrayDeque<SpanNode>(...)ArrayDeque<SpanNode> queue, ...;root.spanroot.childrenSpanNode resultnew NoSuchElementException(...)result.children/** Adds the child IFF it isn't already a child. */new ArrayList<SpanNode>(...)child.parentnew LinkedHashMap<Object,SpanNode>(...)new LinkedHashMap<Object,Object>(...)SpanNode rootSpan, ...;Map<Object,SpanNode> keyToNode, ...;Map<Object,Object> spanToParent, ...;/** Builds a trace tree by merging and processing the input or returns an empty tree. ... */List<Span> cleanedString traceIdindex(...)process(...)new SpanNode(...)Entry<Object,Object> entryMap<>.Entry<Object,Object>SpanNode childSpanNode parentaddChild(...)sortTreeByTimestamp(...)/** Sorts children at the same level by {@link Span#timestampAsLong()} ascending */ArrayDeque<SpanNode> queuepop(...)/** We index spans by (id, shared, localEndpoint) before processing them. This latter fields ... */Object idKeyObject parentKeycreateKey(...)/** Processing is taking a span and placing it at the most appropriate place in the trace tree. ... */Endpoint endpointboolean sharedObject keyObject noEndpointKeyObject parentSpanNode nodenew SharedKey(...)/** A span in the tree is not always unique on ID. Sharing is allowed once per ID (Ex: in RPC). ... */String id, ...;Endpoint endpoint, ...;this.endpointSharedKey thatequal(...)that.endpointList<Span> childrenSpansget(...).spanparent.span// Long.compareTo is JRE 7+// since the input data could be headless, we first push onto the queue the root-most spans// synthetic root// In order to make a tree, we need clean data. This will merge any duplicates so that we// don't have redundant leaves on the tree.// Next, index all the spans so that we can understand any relationships.// Now that we've index references to all spans, we can revise any parent-child relationships.// Notably, by now, we can tell which is the root-most.// If we haven't found any root span, we can still make a tree using a synthetic node.// At this point, we have the most reliable parent-child relationships and can allocate spans// corresponding the the best place in the trace tree.// Handle headless by attaching spans missing parents to root// we need to classify a shared span by its endpoint in case multiple servers respond to the// same ID sent by the client.// the parent of a server span is a client, which is not ambiguous for a given span ID.// Shared is a server span. It will very likely be on a different endpoint than the client.// Clients are not ambiguous by ID, so we don't need to qualify by endpoint.// We are not a root span, and not a shared server span. Proceed in most specific to least.// We could be the child of a shared server span (ex a local (intermediate) span on the same// endpoint). This is the most specific case, so we try this first.// If there's no shared parent, fall back to normal case which is unqualified beyond ID.// we are root or don't know our parent// special-case root, and attribute missing parents to it. In// other words, assume that the first root is the "real" root.// In the case of shared server span, we need to address it both ways, in case intermediate// spans are lacking endpoint information.import EOFExceptionimport BufferUnderflowExceptionimport static ThriftField.TYPE_BOOLimport static ThriftField.TYPE_BYTEimport static ThriftField.TYPE_DOUBLEimport static ThriftField.TYPE_I16import static ThriftField.TYPE_I32import static ThriftField.TYPE_MAPimport static ThriftField.TYPE_SETimport static ThriftField.TYPE_STRUCTint MAX_SKIP_DEPTH, ...;// break vs recursing infinitely when skipping dataV1ThriftSpanWriter writer, ...;V1Span v1Spannew V1ThriftSpanReader(...)int listLengthV1ThriftSpanReader readerV1SpanConverter converterwriteListBegin(...)byte keyTypebyte valueTypebyte elemTypewriteInt(...)// we ignore the type// types that don't need explicit skipping...[] INT_ZERO, ...;ThriftField IPV4, ...;ThriftField PORT, ...;ThriftField SERVICE_NAME, ...;ThriftField IPV6, ...;int ipv4readShort(...)ipv6(...)int portbyte[] ipv6// allocation is ok here as Endpoint.ipv4Bytes would anyway// IPV4// PORT// write short!byte TYPE_STOP, ...;// taken from org.apache.thrift.protocol.TTypebyte TYPE_BOOL, ...;byte TYPE_BYTE, ...;byte TYPE_DOUBLE, ...;byte TYPE_I16, ...;byte TYPE_I32, ...;byte TYPE_I64, ...;byte TYPE_STRING, ...;byte TYPE_STRUCT, ...;byte TYPE_MAP, ...;byte TYPE_SET, ...;byte TYPE_LIST, ...;byte type, ...;int id, ...;this.typebyte typethat.type// Write ID as a short!new Comparator<Span>(...) { ... }int bySpanIdint bySharedcompareShared(...)compareEndpoint(...)/* Spans can be sent in multiple parts. Also client and server spans can share the same ID. This ... */List<Span> resultSpan lastString nextTraceIdboolean spanSharedBuilder replacementEndpointTracker localEndpointSpan nextString nextIdboolean nextSharednew EndpointTracker(...)tryMerge(...)Span.Kind.CLIENTSpan.Kind.SERVERComparator<Span> CLEANUP_COMPARATOR, ...;// false or null first (client first)boolean leftSharedboolean rightSharedboolean leftClientboolean rightClient/** Put spans with null endpoints first, so that their data can be attached to the first span with ... */int byServicenullSafeCompareTo(...)int byIpV4ipv4(...)/** Sometimes endpoints can be sent in pieces. This tracks the whether we should merge with ... */// Let's cleanup any spans and pick the longest ID// Now start any fixes or merging//String previousId = last.id();// Choose the longest trace ID// This cautiously merges with the next span, if we think it was sent in multiple pieces.// remove the merged element// Zipkin and B3 originally used the same span ID between client and server. Some// instrumentation are inconsistent about adding the shared flag on the server side. Since we// have the entire trace, and it is ordered client-first, we can correct a missing shared flag.// Backfill missing shared flag as some instrumentation doesn't add it// handle a shared RPC server span that wasn't propagated its parent span ID// If either are shared put it last// both are shared, so skip out// neither are shared, put the client spans first// neither are client spans// nulls firstimport SpanStoreimport TracesSpanStore delegate, ...;getTrace(...)List<Call<List<Span>>> callsnew ArrayList<Call<List<Span>>>(...)ToListOfTraces.INSTANCEnew ScatterGather(...)Call<>.Mapper<List<Span>,List<List<Span>>>new ToListOfTraces(...)ToListOfTraces INSTANCE, ...;import static JsonCodec.exceptionReadingimport static V2SpanReader.ENDPOINT_READERV1Span.Builder builder, ...;V1Span.BuilderV1Span resultpeekNull(...)readAnnotation(...)readBinaryAnnotation(...)Long timestampBoolean booleanValueString stringValuepeekString(...)peekBoolean(...)addBinaryAnnotation(...)// read any optional fieldsimport V2SpanConverter/** This type isn't thread-safe: it re-uses state to avoid re-allocations in conversion loops. */new V1SpanWriter(...)V2SpanConverter converter, ...;V1SpanWriter v1SpanWriter, ...;import V1Annotationimport V1BinaryAnnotationimport static V2SpanWriter.endpointSizeInBytesimport static V2SpanWriter.writeAnnotation/** This type is only used to backport the v1 read api as it returns v1 json. */WriteBuffer.Writer<V1Span>Endpoint lastEndpointint lastEndpointSizeint binaryAnnotationCountbinaryAnnotations(...)traceIdHigh(...)V1Annotation aendpoint(...)int endpointSizeendpointSizeInBytes(...)annotationSizeInBytes(...)V1BinaryAnnotation astringValue(...)binaryAnnotationSizeInBytes(...)key(...)byte[] lastEndpointByteswriteLongHex(...)byte[] endpointByteslegacyEndpointBytes(...)writeAnnotation(...)writeBinaryAnnotation(...)writeEndpoint(...)// {"traceId":"xxxxxxxxxxxxxxxx"// ,"parentId":"0123456789abcdef"// ,"id":"0123456789abcdef"// ,"name":""// ,"timestamp":// ,"duration":// ,"annotations":[]// ,"binaryAnnotations":[]// commas// {"key":"NN","value":true,"endpoint":}// ,"debug":true// }// {"key":"","value":""}// ,"endpoint":import static ThriftCodec.readListLengthimport static V1ThriftSpanWriter.ANNOTATIONSimport static V1ThriftSpanWriter.BINARY_ANNOTATIONSimport static V1ThriftSpanWriter.DEBUGimport static V1ThriftSpanWriter.DURATIONimport static V1ThriftSpanWriter.IDimport static V1ThriftSpanWriter.NAMEimport static V1ThriftSpanWriter.PARENT_IDimport static V1ThriftSpanWriter.TIMESTAMPimport static V1ThriftSpanWriter.TRACE_IDimport static V1ThriftSpanWriter.TRACE_ID_HIGHString ONE, ...;ThriftField TIMESTAMP, ...;ThriftField VALUE, ...;ThriftField ENDPOINT, ...;ThriftField KEY, ...;ThriftField TYPE, ...;boolean isBooleanboolean isStringThriftField TRACE_ID, ...;ThriftField TRACE_ID_HIGH, ...;ThriftField NAME, ...;ThriftField ID, ...;ThriftField PARENT_ID, ...;ThriftField ANNOTATIONS, ...;ThriftField BINARY_ANNOTATIONS, ...;ThriftField DEBUG, ...;ThriftField DURATION, ...;int valueSizeV1BinaryAnnotation bint keySizeint remoteEndpointSizewriteAnnotations(...)writeBinaryAnnotations(...)byte[] epint type// TRACE_ID// TRACE_ID_HIGH// PARENT_ID// ID// NAME// we write list thriftFields even when empty to match finagle serialization// ANNOTATION field + list overhead// BINARY_ANNOTATION field + list overhead// DEBUG// TIMESTAMP// DURATION// TYPEnew JsonReaderAdapter<Endpoint>(...) { ... }boolean readFieldSpan.Builder builder, ...;JsonReaderAdapter<Endpoint> ENDPOINT_READER, ...;Annotation aIterator<Entry<String,String>> iiterator(...)boolean wroteField// {"traceId":""// ,"kind":""// ,"localEndpoint":// ,"remoteEndpoint":// ,"tags":{}// "":""// ,"shared":true// {// "serviceName":""// ,// "ipv4":""// "ipv6":""// "port":// {"timestamp":,"value":""}/** Writes are unsafe as they do no bounds checks. This means you should take care to allocate or ... */new WriteBuffer(...)int pos, ...;this.posv.lengthint lastPos/** This transcodes a UTF-16 Java String to UTF-8 bytes. ... */char lowint codePointtoCodePoint(...)isHighSurrogate(...)isLowSurrogate(...)// Adapted from okio.Buffer.writeDecimalLong// com.squareup.wire.ProtoWriter.writeVarint v2.3.0...>>>=...// there seem to be less branches for for strings without surrogates// TODO: benchmark vs https://github.com/protocolbuffers/protobuf/blob/master/java/core/src/main/java/com/google/protobuf/Utf8.java#L240/** This returns the bytes needed to transcode a UTF-16 Java String to UTF-8 bytes. ... */int low/** Binary search for character width which favors matching lower numbers. ... */boolean negativeint width/** A base 128 varint encodes 7 bits at a time, this checks how many bytes are needed to represent ... */// Since trace IDs are random, I guess they cover the entire spectrum of varint sizes and probably would especially benefit from this.// TODO: benchmark vs https://github.com/protocolbuffers/protobuf/blob/master/java/core/src/main/java/com/google/protobuf/CodedOutputStream.java#L770/** Like {@link #varintSizeInBytes(int)}, except for uint64. */// 7-bit ASCII character// This could be an ASCII run, or possibly entirely ASCII// another 7-bit ASCII character// 11-bit character// 16-bit character// Possibly a 21-bit character// Malformed or not UTF-8// Truncated or not UTF-8// Write the 21-bit character using 4 bytes// See http://www.unicode.org/versions/Unicode7.0.0/ch03.pdf#G2630// needs to be positive so we can use this for an array index// A malformed surrogate, which yields '?'.// A 21-bit character// making this positive allows us to compare using less-than// conditionally add room for negative sign/** Provides autocomplete functionality by providing values for a given tag key, usually derived from ... *//** Retrieves the list of tag getKeys whose values may be returned by {@link #getValues(String)}. ... *//** Retrieves the list of values, if the input is configured for autocompletion. If a key is not ... */import CheckResult/** We provide a forwarding variant of the storage component for use cases such as trace decoration, ... *//** Constructor for use by subclasses. *//** The delegate is a method as opposed to a field, to allow for flexibility. For example, this ... */spanConsumer(...)delegate(...)traces(...)spanStore(...)autocompleteTags(...)serviceAndSpanNames(...)check(...)isOverCapacity(...)close(...)import static StrictTraceId.lowerTraceId/** A mapper that groups unorganized input spans by trace ID. Useful when preparing a result for ... */new GroupByTraceId(...)boolean strictTraceId, ...;this.strictTraceIdMap<String,List<Span>> groupedByTraceIdnew LinkedHashMap<String,List<Span>>(...)lowerTraceId(...)// Modifiable so that StrictTraceId can filter without allocating a new listimport LinkedHashSetimport Setimport SortedMapimport DependencyLinker/** Test storage component that keeps all spans in memory, accepting them on the calling thread. ... */new SortedMultimap<TraceIdTimestamp,Span>(...) { ... }InMemoryStorage.TraceIdTimestampnew LinkedHashSet<Span>(...)new SortedMultimap<String,TraceIdTimestamp>(...) { ... }new LinkedHashSet<TraceIdTimestamp>(...)new ServiceNameToTraceIds(...)new SortedMultimap<String,String>(...) { ... }new LinkedHashSet<String>(...)new Comparator<String>(...) { ... }new Comparator<TraceIdTimestamp>(...) { ... }left.timestampright.timestampright.lowTraceIdleft.lowTraceIdStorageComponent.Builderint maxSpanCount, ...;List<String> autocompleteKeys, ...;this.searchEnabledthis.autocompleteKeys/** Eldest traces are removed to ensure spans in memory don't exceed this value */this.maxSpanCountnew InMemoryStorage(...)SortedMultimap<TraceIdTimestamp,Span> spansByTraceIdTimestamp, ...;/** Primary source of data is this map, which includes spans ordered descending by timestamp. All ... */SortedMultimap<String,TraceIdTimestamp> traceIdToTraceIdTimestamps, ...;/** This supports span lookup by {@link Span#traceId() lower 64-bits of the trace ID} */ServiceNameToTraceIds serviceToTraceIds, ...;/** This is an index of {@link Span#traceId()} by {@link Endpoint#serviceName() service name} */SortedMultimap<String,String> serviceToSpanNames, ...;/** This is an index of {@link Span#name()} by {@link Endpoint#serviceName() service name} */SortedMultimap<String,String> serviceToRemoteServiceNames, ...;/** This is an index of {@link Span#remoteServiceName()} by {@link Endpoint#serviceName() service ... */SortedMultimap<String,String> autocompleteTags, ...;Call<List<String>> autocompleteKeysCall, ...;Set<String> autocompleteKeys, ...;AtomicInteger acceptedSpanCount, ...;builder.strictTraceIdbuilder.searchEnabledbuilder.maxSpanCountthis.autocompleteKeysCallbuilder.autocompleteKeysnew StoreSpansCall(...)int deltaint spansToRecoveraddAndGet(...)evictToRecoverSpans(...)String lowTraceIdlowTraceId(...)TraceIdTimestamp traceIdTimeStampnew TraceIdTimestamp(...)String spanNameEntry<String,String> tagCall<>.Base<Void>List<Span> spans, ...;this.spansdoAccept(...)/** Returns the count of spans evicted. */int spansEvictedint spansInOldestTracedeleteOldestTrace(...)...-=...lastKey(...).lowTraceIdlastKey(...)Collection<TraceIdTimestamp> traceIdTimeStampsIterator<TraceIdTimestamp> traceIdTimeStampIterCollection<Span> spansString orphanedServiceremoveServiceIfTraceId(...)getTraces(...)Set<String> lowTraceIdsInRangetraceIdsDescendingByTimestamp(...)List<List<Span>> resultIterator<String> lowTraceIdlimit(...)spansByTraceId(...)List<Span> strictTracestrictByTraceId(...)/** Used for testing. Returns all traces unconditionally. */keySet(...)List<Span> sameTraceId/** Used for testing. Returns all dependency links unconditionally. */getDependencyLinks(...)Collection<TraceIdTimestamp> traceIdTimestampstraceIdTimestampsByServiceName(...)emptySet(...)lowTraceIdsInRange(...)request.endTsrequest.lookbacklong beginTsSet<String> resultTraceIdTimestamp traceIdTimestamptraceIdTimestamp.timestamptraceIdTimestamp.lowTraceIdunmodifiableSet(...)List<Span> spansList<Span> filteredIterator<Span> iteratorSet<String> normalizedSet<String> lower64BitList<Span> tracenew ArrayList<String>(...)// ignore traceIdHigh. Otherwise, a single trace can appear as two, doubling callCount.// We don't have a query parameter for strictTraceId when fetching dependency links, so weDependencyLinker linksBuildernew DependencyLinker(...)putTrace(...)Comparator<String> STRING_COMPARATOR, ...;Comparator<TraceIdTimestamp> TIMESTAMP_DESCENDING, ...;/** Returns service names orphaned by removing the trace ID */Entry<String,Collection<String>> entryMap<>.Entry<String,Collection<String>>Collection<String> lowTraceIdsremoveAll(...)// Not synchronized as every exposed method on the enclosing type isSortedMap<K,Collection<V>> delegate, ...;int size, ...;new TreeMap<K,Collection<V>>(...)Collection<V> valueContainervalueContainer(...)Collection<V> valueCollection<V> resultList<TraceIdTimestamp> traceIdTimestampsnew ArrayList<TraceIdTimestamp>(...)String lowTraceId, ...;this.lowTraceIdTraceIdTimestamp thatthat.lowTraceId// re-run the query as now spans are strictly grouped// Our index is by lower-64 bit trace ID, so let's build trace IDs to fetch// service names are always lowercase!// use negative as we are descending/** Invoking this request retrieves traces matching the below filters. ... *//** When present, corresponds to the {@link Span#localServiceName() local service name} and ... *//** When present, only include traces with this {@link Span#remoteServiceName() remote service ... *//** When present, only include traces with this {@link Span#name()} ... *//** When an input value is the empty string, include traces whose {@link Span#annotations()} ... *//** Only return traces whose {@link Span#duration()} is greater than or equal to minDuration ... *//** Only return traces whose {@link Span#duration()} is less than or equal to maxDuration ... *//** Only return traces where all {@link Span#timestamp()} are at or before this time in epoch ... *//** Only return traces where all {@link Span#timestamp()} are at or after (endTs - lookback) in ... *//** Maximum number of traces to return. Defaults to 10 *//** Corresponds to query parameter "annotationQuery". Ex. "http.method=GET and error" ... */StringBuilder resultannotationQuery(...)Entry<String,String> nextMap<String,String> annotationQuery, ...;Long minDuration, ...;long endTs, ...;int limit, ...;source.remoteServiceNamesource.spanNamesource.annotationQuerysource.minDurationsource.maxDurationsource.endTssource.lookbacksource.limit/** Sets {@link QueryRequest#serviceName()} *//** Sets {@link QueryRequest#remoteServiceName()} */this.remoteServiceName/** This ignores the reserved span name "all". ... */this.spanName/** Corresponds to query parameter "annotationQuery". Ex. "http.method=GET and error". Parameter ... */Map<String,String> mapString annint idxtrim(...)String[] keyValuekeyValue.length/** Sets {@link QueryRequest#annotationQuery()} */this.annotationQuery/** Sets {@link QueryRequest#minDuration()} */this.minDuration/** Sets {@link QueryRequest#maxDuration()} */this.maxDuration/** Sets {@link QueryRequest#endTs()} *//** Sets {@link QueryRequest#lookback()} */this.lookback/** Sets {@link QueryRequest#limit()} */this.limitnew QueryRequest(...)/** Tests the supplied trace against the current request. ... */boolean testedDurationminDuration(...)maxDuration(...)String serviceNameToMatchString remoteServiceNameToMatchString spanNameToMatchspanName(...)Map<String,String> annotationQueryRemainingendTs(...)lookback(...)String localServiceNameEntry<String,String> t// put the annotation only if there is no key present already, prevents overriding more specific tags// tag// tags are put regardless, i.e. last tag wins// coerce service and span names to lowercase// remove any accidental empty strings// v2 returns raw spans in any order, get the root's timestamp or the first timestamp// service name, when present, constrains other queries./** Provides autocomplete functionality by providing values for service and span names, usually ... *//** Retrieves all {@link Span#localEndpoint() local} {@link Endpoint#serviceName() service names}, ... *//** Retrieves all {@link Span#remoteEndpoint() remote} {@link Endpoint#serviceName() service names} ... *//** Retrieves all {@link Span#name() span names} recorded by a {@link Span#localEndpoint() ... */// @FunctionalInterface/** Queries data derived from {@link SpanConsumer}. ... *//** Retrieves spans grouped by trace ID from the storage system with no ordering expectation. ... *//** Retrieves spans that share a 128-bit trace id with no ordering expectation or empty if none are ... *//** Retrieves all {@link Span#localEndpoint() local} and {@link Span#remoteEndpoint() remote} ... *//** Returns dependency links derived from spans in an interval contained by (endTs - lookback) or ... */import RejectedExecutionExceptionimport Componentimport TracesAdapter/** A component that provides storage interfaces used for spans and aggregations. Implementations are ... */new TracesAdapter(...)new AutocompleteTags(...) { ... }SpanStore delegatenew ServiceAndSpanNames(...) { ... }getServiceNames(...)getSpanNames(...)/** A storage request failed and was dropped due to a limit, resource unavailability, or a timeout. ... *//** Zipkin supports 64 and 128-bit trace identifiers, typically serialized as 16 or 32 character ... *//** False is an attempt to disable indexing, leaving only {@link StorageComponent#traces()} ... *//** Autocomplete is used by the UI to suggest getValues for site-specific tags, such as ... */info(...)/** How long in milliseconds to suppress calls to write the same autocomplete key/value pair. *//** How many autocomplete key/value pairs to suppress at a time. */// delegates to deprecated methods.// returns default to not break compat// incorrect for not yet ported 3rd party storage components.// not abstract as added laterimport Mapperimport FilterTraces/** Storage implementation often need to re-check query results when {@link ... */new FilterSpans(...)/** Filters the mutable input client-side when there's a clash on lower 64-bits of a trace ID. ... */new FilterTracesIfClashOnLowerTraceId(...)hasClashOnLowerTraceId(...)// necessary is also more efficient.// fail client side. Normally, we wouldn't special case like this, but not filtering unless// blindly filtered without seeing if we had to, a match that works on the server side would// Concretely, Netflix have a special index template for a multi-tag, "fit.sessionId". If we/** Returns true if any trace clashes on the right-most 16 characters of the trace ID */int traceCountSet<String> traceIdLowsboolean clashIterator<Span> i/** Returns a function that filters its mutable input when it contains a trace not matching the ... */new FilterTracesByIds(...)Set<String> traceIds, ...;Iterator<List<Span>> i// NOTE: It is probably more efficient to do clever sorting and peeking here, but the call site// is query side, which is not in the critical path of user code. A set is much easier to grok.// Not using removeIf as that's java 8+/** Allows readback of traces by ID, as written by a {@link SpanConsumer}. ... *//** Retrieves any traces with the specified IDs. Results return in any order, and can be empty. ... *//** Like {@link zipkin2.Annotation}, except in v1 format the {@link Span#localEndpoint()} was ... */// exposed for conversionnew V1Annotation(...)/** Sets {@link Annotation#timestamp()} *//** Sets {@link Annotation#value()} *//** The host that reported this annotation or null if unknown. ... */// hashCode and equals implemented as legacy cassandra uses it in a naming conventionV1Annotation thatthat.value/** Compares by {@link #timestamp()}, then {@link #value()}. *//** This only supports binary annotations that map to {@link Span v2 span} data. Namely, this ... */int TYPE_BOOLEAN, ...;/** The defined in zipkin's thrift definition */int TYPE_STRING, ...;/** The type defined in zipkin's thrift definition *//** Creates an address annotation, which is the same as {@link Span#remoteEndpoint()} */new V1BinaryAnnotation(...)/** Creates a tag annotation, which is the same as {@link Span#tags()} except duplicating the ... *//** The same as the key of a {@link Span#tags()} v2 span tag} *//** The thrift type for the value defined in Zipkin's thrift definition. Note this is not the ... *//** The same as the value of a {@link Span#tags()} v2 span tag} or null if this is an address *//** When {@link #stringValue()} is present, this is the same as the {@link Span#localEndpoint()} ... */String key, ...;int type, ...;this.stringValueV1BinaryAnnotation thatthat.keythat.stringValue/** Provides consistent iteration by {@link #key} */import static Collections.unmodifiableListimport static HexCodec.lowerHexToUnsignedLong/** V1 spans are different than v2 especially as annotations repeat. Support is available to help ... *//** When non-zero, the trace containing this span uses 128-bit trace identifiers. *//** lower 64-bits of the {@link Span#traceId()} *//** Same as {@link zipkin2.Span#id()} except packed into a long. Zero means root span. *//** Same as {@link zipkin2.Span#name()} *//** The parent's {@link #id()} or zero if this the root span in a trace. *//** Same as {@link Span#timestampAsLong()} *//** Same as {@link Span#durationAsLong()} *//** Same as {@link Span#annotations()}, except each may be associated with {@link ... *//** {@link Span#tags()} are allocated to binary annotations with a {@link ... *//** Same as {@link Span#debug()} *//** Returns the distinct {@link Endpoint#serviceName() service names} that logged to this span. */a.endpointlong traceIdHigh, ...;long parentId, ...;List<V1Annotation> annotations, ...;List<V1BinaryAnnotation> binaryAnnotations, ...;Boolean debug, ...;this.traceIdHighbuilder.traceIdHighthis.annotationsthis.binaryAnnotationsbuilder.binaryAnnotationsthis.debugbuilder.debug/** Sets {@link V1Span#traceIdHigh()} */// ID accessors are here to help organize builders by their identifiers/** Sets {@link V1Span#traceId()} *//** Sets {@link V1Span#id()} */ArrayList<V1Annotation> annotations, ...;ArrayList<V1BinaryAnnotation> binaryAnnotations, ...;/** Same as {@link Span.Builder#traceId(String)} *//** Same as {@link Span.Builder#id(String)} *//** Same as {@link Span.Builder#parentId(String)} *//** Sets {@link V1Span#parentId()} *//** Sets {@link V1Span#name()} *//** Sets {@link V1Span#timestamp()} *//** Sets {@link V1Span#duration()} *//** Sets {@link V1Span#annotations()} */new ArrayList<V1Annotation>(...)new ArrayList<V1BinaryAnnotation>(...)/** Sets {@link V1Span#debug()} */new V1Span(...)V1Span thatthat.traceIdHighthat.binaryAnnotationsthat.debug// Ignore empty endpoints rather than crashing v1 parsers on bad address data/** Allows you to split a v1 span when necessary. This can be the case when reading merged ... */new ArrayList<Builder>(...)new V1SpanConverter(...)Span.Builder first, ...;List<Builder> spans, ...;V1Annotation cs, ...;start(...)processAnnotations(...)processBinaryAnnotations(...)Builder currentSpanforEndpoint(...)a.valuea.timestampendTimestampReflectsSpanDuration(...)cr.endpointss.endpointBuilder clientcs.endpointBuilder servermaybeTimestampDuration(...)hasSameServiceName(...)sr.endpointnewSpanBuilder(...)sr.timestampss.timestamphandleIncompleteRpc(...)Builder producerms.endpointBuilder consumermr.endpointwr.timestampmr.timestampms.timestampws.timestampws.valuews.endpointwr.valuewr.endpointcs.timestampcr.timestampcr.valuess.valueend.timestampBuilder span2begin.endpointbegin.timestampEndpoint caEndpoint saEndpoint maboolean noCoreAnnotationsV1Annotation serversource.binaryAnnotationsb.endpointb.keyb.stringValueserver.endpointcloseEnoughEndpoint(...)Builder nextsource.debugsource.traceIdHigh// add annotations unless they are "core"// convert binary annotations to tags and addresses// core annotations require an endpoint. Don't give special treatment when that's missing// When bridging between event and span model, you can end up missing a start annotation// in a shared span, the client side owns span duration by annotations or explicit timestamp// special-case loopback: We need to make sure on loopback there are two span2s// fork a new span for the server side// the server side is smaller than that, we have to read annotations to find out// one-way has no duration// otherwise, the span is incomplete. revert special-casing// Span v1 format did not have a shared flag. By convention, span.timestamp being absent// implied shared. When we only see the server-side, carry this signal over.// We use a signal of either the authoritative timestamp being unset, or the duration is unset// eventhough we have the server send result. The latter clarifies an edge case in MySQL// where a span row is shared between client and server. The presence of timestamp in this// case could be due to the client-side of that RPC.// ms and mr are not supposed to be in the same span, but in case they are..// fork a new span for the consumer side// Peek to see if this is an address annotation. Strictly speaking, address annotations should// have a value of true (not "true" or "1"). However, there are versions of zipkin-ruby in the// wild that create "1" and misinterpreting confuses the question of what is the local// endpoint. Hence, we leniently parse.// don't add marker "lc" tags// special-case when we are missing core annotations, but we have both address annotations// "sa" is a default for a remote address, don't make it a client span// ca != null: treat it like a server// Finagle adds a "ca" annotation on server spans for the client-port on the socket, but with// the same service name as "sa". Removing the service name prevents creating loopback links.// client span// messaging span// Intentionally process messaging endpoints separately in case someone accidentally shared// a messaging span. This will ensure both sides have the address of the broker.// allocate missing endpoint data to first span/** Allows you convert a v2 span into a v1 span. This is helpful for legacy storage which still use ... */new V1SpanMetadata(...)new V2SpanConverter(...)V1Span.Builder result, ...;V1SpanMetadata md, ...;boolean beginAnnotationmd.startTsmd.beginboolean endAnnotationmd.endTsmd.endEndpoint epboolean writeLocalComponentboolean hasRemoteEndpointmd.addrparse(...)Entry<String,String> bString begin, ...;Span.Kind.PRODUCERSpan.Kind.CONSUMER// Don't report timestamp and duration on shared spans (should be server, but not necessarily)// write an empty "lc" annotation to avoid missing the localEndpoint in an in-process span// scan annotations in case there are better timestamps, or inferred kind// default value// If we didn't find a span kind, directly or indirectly, unset the addrimport UncheckedIOExceptionimport JMSExceptionimport ActiveMQConnectionFactoryimport Collectorimport CollectorComponentimport CollectorMetricsimport CollectorSamplerimport StorageComponent/** This collector consumes encoded binary messages from a ActiveMQ queue. *//** Configuration including defaults needed to consume spans from a ActiveMQ queue. */CollectorComponent.BuilderActiveMQCollector.classCollectorMetrics.NOOP_METRICSCollector.Builder delegate, ...;Collector.BuilderCollectorMetrics metrics, ...;ActiveMQConnectionFactory connectionFactory, ...;String queue, ...;int concurrency, ...;storage(...)sampler(...)this.metricsforTransport(...)metrics(...)this.connectionFactory/** Queue zipkin spans will be consumed from. Defaults to "zipkin". */this.queue/** Count of concurrent message listeners on the queue. Defaults to 1 */this.concurrencynew ActiveMQCollector(...)LazyInit lazyInit, ...;builder.queuethis.lazyInitnew LazyInit(...)init(...)lazyInit.resultfailed(...)lazyInit.result.checkResultlazyInit.queuegetBrokerURL(...)lazyInit.connectionFactoryException causegetLinkedException(...)new UncheckedIOException(...)message(...)import BytesMessageimport Messageimport MessageListenerimport Queueimport QueueReceiverimport QueueSessionimport Sessionimport TextMessageimport ActiveMQConnectionimport TransportListenerimport static StandardCharsets.UTF_8/** Consumes spans from messages on a ActiveMQ queue. Malformed messages will be discarded. Errors in ... */new LinkedHashMap<QueueSession,QueueReceiver>(...)new Callback<Void>(...) { ... }Callback<Void> NOOP, ...;CheckResult CLOSED, ...;Collector collector, ...;ActiveMQConnection connection, ...;Map<QueueSession,QueueReceiver> sessionToReceiver, ...;CheckResult checkResult, ...;this.collectorthis.connectionaddTransportListener(...)/** JMS contract is one session per thread: we need a new session up to our concurrency level. */QueueSession sessioncreateQueueSession(...)Session.AUTO_ACKNOWLEDGEQueue destinationcreateQueue(...)QueueReceiver receivercreateReceiver(...)setMessageListener(...)byte[] serializedincrementMessages(...)BytesMessage bytesMessagegetBodyLength(...)String textgetText(...)getBytes(...)incrementMessagesDropped(...)incrementBytes(...)serialized.lengthacceptSpans(...)removeTransportListener(...)Entry<QueueSession,QueueReceiver> sessionReceiverMap<>.Entry<QueueSession,QueueReceiver>JMSException ignored// Pass redundant info as we can't use default method in activeMQ// No need to do anything on ActiveMQ side as physical queues are created on demand// TODO: consider how to reuse buffers here// lenient on empty messages// deregister this// EmptyCatch ignoredimport static ActiveMQCollector.uncheckedException/** Lazy creates a connection and registers a message listener up to the specified concurrency level. ... */ActiveMQSpanConsumer result, ...;ActiveMQCollector.Builderbuilder.delegatebuilder.metricsbuilder.connectionFactorybuilder.concurrencydoInit(...)ActiveMQSpanConsumer maybeActiveMQConnection connectioncreateQueueConnection(...)JMSException euncheckedException(...)ActiveMQSpanConsumer resultnew ActiveMQSpanConsumer(...)registerInNewSession(...)import CopyOnWriteArraySetimport CountDownLatchimport LinkedBlockingQueueimport EmbeddedActiveMQBrokerimport Afterimport Beforeimport ClassRuleimport Ruleimport Testimport ExpectedExceptionimport TestNameimport InMemoryCollectorMetricsimport ForwardingStorageComponentimport SpanConsumerimport static Assertions.assertThatimport static TestObjects.LOTS_OF_SPANSimport static TestObjects.UTF_8import static SpanBytesEncoder.PROTO3import static SpanBytesEncoder.THRIFTnew TestName(...)none(...)new InMemoryCollectorMetrics(...)new CopyOnWriteArraySet<Thread>(...)new LinkedBlockingQueue<List<Span>>(...)...->...new SpanConsumer(...) { ... }currentThread(...)new EmbeddedActiveMQBroker(...)EmbeddedActiveMQBroker activemq, ...;TestName testName, ...;ExpectedException thrown, ...;InMemoryCollectorMetrics metrics, ...;InMemoryCollectorMetrics activemqMetrics, ...;CopyOnWriteArraySet<Thread> threadsProvidingSpans, ...;LinkedBlockingQueue<List<Span>> receivedSpans, ...;SpanConsumer consumer, ...;ActiveMQCollector collector, ...;builder(...)isTrue(...)assertThat(...)ok(...)ActiveMQConnectionFactory connectionFactorynew ActiveMQConnectionFactory(...)setBrokerURL(...)connectionFactory(...)expect(...)UncheckedIOException.classexpectMessage(...)/** The {@code toString()} of {@link Component} implementations appear in health check endpoints. ... */hasToString(...)getVmURL(...)getMethodName(...)/** Ensures list encoding works: a json encoded list of spans */messageWithMultipleSpans(...)SpanBytesEncoder.JSON_V1/** Ensures list encoding works: a version 2 json list of spans *//** Ensures list encoding works: proto3 ListOfSpans */byte[] messageencodeList(...)pushMessage(...)collector.queuetake(...)messages(...)isZero(...)messagesDropped(...)message.lengthbytes(...)spans(...)spansDropped(...)/** Ensures malformed spans don't hang the collector */byte[] malformed1byte[] malformed2sleep(...)malformed2.lengthmalformed1.lengthencodeList(...).length/** Guards against errors that leak from storage, such as InvalidQueryException */AtomicInteger counternew Call<>.Base<Void>(...) { ... }getAndIncrement(...)buildStorage(...)containsExactlyElementsOf(...)CountDownLatch latchnew CountDownLatch(...)concurrency(...)countDown(...)await(...)InterruptedException eaccept(...)queue(...)createConnectionFactory(...)new ForwardingStorageComponent(...) { ... }// we can be pretty certain ActiveMQ isn't running on localhost port 80// screwed up json// only malformed, not empty// tossed on error// the only way we could read this, is if the malformed span was skipped.// storage failure not message failure// only one dropped// await the other one as this proves 2 threads are in use// empty bodies don't go to storage// 2 + empty body for warmup// prevent test flakes by having each run in an individual queueimport Executorimport Supplierimport LoggerFactoryimport SpanBytesDecoderDetectorimport static Call.propagateIfFatal/** This component takes action on spans received from a transport. This includes deserializing, ... */Callback<Void> NOOP_CALLBACK, ...;// not final for mock/** Needed to scope this to the correct logging category */StorageComponent storage, ...;CollectorSampler sampler, ...;/** Sets {@link {@link CollectorComponent.Builder#storage(StorageComponent)}} */this.storage/** Sets {@link {@link CollectorComponent.Builder#metrics(CollectorMetrics)}} *//** Sets {@link {@link CollectorComponent.Builder#sampler(CollectorSampler)}} */this.samplernew Collector(...)builder.loggerbuilder.storageCollectorSampler.ALWAYS_SAMPLEbuilder.sampler...::...new Executor(...) { ... }run(...)/** Calls to get the storage component could be blocking. This ensures requests that block ... */List<Span> sampledSpanssample(...)incrementSpans(...)new StoreSpans(...)Throwable unexpected/** Like {@link #acceptSpans(byte[], BytesDecoder, Callback)}, except using a byte buffer. */...|...handleDecodeError(...)/** Before calling this, call {@link CollectorMetrics#incrementMessages()}, and {@link ... */List<Span> sampledint droppedSpan sisSampled(...)incrementSpansDropped(...)store(...)handleStorageError(...)appendSpanIds(...)new Supplier<String>(...) { ... }/** When storing spans, an exception can be raised before or after the fact. This adds context of ... */String errorisDebugEnabled(...)startsWith(...)// span IDs repeat between client and server!// TODO: this logic needs to be redone as service names are more important than span IDs. Also,idString(...)// In order to ensure callers are not blocked, we swap callbacks when we get to the storage// phase of this process. Here, we create a callback whose sole purpose is classifying later// errors on this bundle of spans in the same log category. This allows people to only turn on// debug logging in one place.// ensure if a future is supplied we always set value or error// While unexpected, invoking the storage command could raise an error synchronously. When// that's the case, we wouldn't have invoked callback.onSuccess, so we need to handle the// error here.// The exception could be related to a span being huge. Instead of filling logs,// print trace id, span id pairs// We have specific code that customizes log messages. Use this when the case.// otherwise, beautify the message/** The collector represents the server-side of a transport. Its job is to take spans from a ... *//** Starts the server-side of the transport, typically listening or looking up a queue. ... *//** Once spans are sampled, they are {@link SpanConsumer#accept(List)} queued for storage} using ... *//** Aggregates and reports collection metrics to a monitoring system. Should be {@link ... *//** {@link CollectorSampler#isSampled(String, boolean) samples spans} to reduce load on the ... *//** Instrumented applications report spans over a transport such as Kafka. Zipkin collectors receive ... */new CollectorMetrics(...) { ... }/** Those who wish to partition metrics by transport can call this method to include the transport ... *//** Increments count of messages received, which contain 0 or more spans. Ex POST requests or Kafka ... *//** Increments count of messages that could not be read. Ex malformed content, or peer disconnect. *//** Increments the count of spans read from a successful message. When bundling is used, accepted ... *//** Increments the number of bytes containing serialized spans in a message. ... *//** Increments the count of spans dropped for any reason. For example, failure queueing to storage ... */CollectorMetrics NOOP_METRICS, ...;import HexCodec/** CollectorSampler decides if a particular trace should be "sampled", i.e. recorded in permanent ... */CollectorSampler ALWAYS_SAMPLE, ...;/** Returns a trace ID sampler with the indicated rate. ... */long boundaryLong.MAX_VALUEnew CollectorSampler(...) { ... }/** Returns true if spans with this trace ID should be recorded to storage. ... */long traceIdlong tabs(...)boundary(...)// safe cast as less <= 1// The absolute value of Long.MIN_VALUE is larger than a long, so Math.abs returns identity.// This converts to MAX_VALUE to avoid always dropping when traceId == Long.MIN_VALUEConcurrentHashMap<String,AtomicInteger> metrics, ...;String messages, ...;String messagesDropped, ...;String bytes, ...;String spans, ...;String spansDropped, ...;new ConcurrentHashMap<String,AtomicInteger>(...)this.messagesscope(...)this.messagesDroppedthis.spansDroppedincrement(...)AtomicInteger atomicAtomicInteger metricint oldValueint update// won race creating the entry// won race updatingimport Streamimport static Percentage.withPercentage/** Math.abs("8000000000000000") returns a negative, we coerse to "7fffffffffffffff" to avoid ... */CollectorSampler samplerfloat sampleRateisCloseTo(...)withPercentage(...)count(...)filter(...)lotsOfSpans(...)new Predicate<Span>(...) { ... }LOTS_OF_SPANS.length/** The collector needs to apply the same decision to incremental updates in a trace. */CollectorSampler sampler1CollectorSampler sampler2containsExactly(...)hasSize(...)IllegalArgumentException.classparallel(...)of(...)import TestLoggerimport TestLoggerFactoryimport InMemoryStorageimport static Arrays.asListimport static ArgumentMatchers.anyimport static Mockito.mockimport static Mockito.spyimport static Mockito.verifyimport static Mockito.verifyNoMoreInteractionsimport static Mockito.whenimport static TestObjects.CLIENT_SPANimport static TestObjects.TRACEmock(...)Callback<>.classCollectorMetrics.classgetTestLogger(...)InMemoryStorage storage, ...;Callback<Void> callback, ...;TestLogger testLogger, ...;clearAll(...)spy(...)thenReturn(...)when(...)verifyNoMoreInteractions(...)verify(...)getLoggingEvents(...)any(...)RuntimeException.classbyte[] bytescontainsOnly(...)assertDebugLogIs(...)StorageComponent storageStorageComponent.classRuntimeException errorthenThrow(...)Span span2unprefixIdString(...)Callback<Void> callbackIllegalArgumentException errornew RejectedExecutionException(...)replaceAll(...)extracting(...)filteredOn(...)new Predicate<LoggingEvent>(...) { ... }getLevel(...)Level.DEBUGnew ThrowingExtractor<LoggingEvent,String,RuntimeException>(...) { ... }// to make expectations easier to read// error is asyncimport Durationimport Propertiesimport CopyOnWriteArrayListimport ExecutorServiceimport Executorsimport AdminClientimport ProducerConfigimport KafkaExceptionimport KafkaFutureimport ConfigExceptionimport InterruptExceptionimport ByteArrayDeserializerimport static ConsumerConfig.AUTO_OFFSET_RESET_CONFIGimport static ConsumerConfig.BOOTSTRAP_SERVERS_CONFIGimport static ConsumerConfig.GROUP_ID_CONFIGimport static ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIGimport static ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG/** This collector polls a Kafka topic for messages that contain TBinaryProtocol big-endian encoded ... */KafkaCollector.class/** Configuration including defaults needed to consume spans from a Kafka topic. */new Properties(...)Properties properties, ...;String topic, ...;int streams, ...;/** Topic zipkin spans will be consumed from. Defaults to "zipkin". Multiple topics may be ... */this.topic/** The bootstrapServers connect string, ex. 127.0.0.1:9092. No default. *//** The consumer group this process is consuming on behalf of. Defaults to "zipkin" *//** Count of threads consuming the topic. Defaults to 1 */this.streams/** By default, a consumer will be built from properties derived from builder defaults, as well ... */new KafkaCollector(...)ByteArrayDeserializer.classLazyKafkaWorkers kafkaWorkers, ...;AdminClient adminClient, ...;new LazyKafkaWorkers(...)builder.propertiesCheckResult failurekafkaWorkers.failureKafkaFuture<String> maybeClusterIdclusterId(...)describeCluster(...)getAdminClient(...)TimeUnit.SECONDSofSeconds(...)kafkaWorkers.builder.topicProducerConfig.BOOTSTRAP_SERVERS_CONFIGkafkaWorkers.buildernew AtomicReference<CheckResult>(...)new CopyOnWriteArrayList<KafkaCollectorWorker>(...)Builder builder, ...;AtomicReference<CheckResult> failure, ...;CopyOnWriteArrayList<KafkaCollectorWorker> workers, ...;ExecutorService pool, ...;builder.streamscompute(...)ExecutorService maybePoolKafkaCollectorWorker workerstop(...)shutdown(...)awaitTermination(...)shutdownNow(...)ExecutorService poolnewSingleThreadExecutor(...)newFixedThreadPool(...)new KafkaCollectorWorker(...)guardFailures(...)new Runnable(...) { ... }InterruptException eKafkaException egetCause(...)error(...)// Settings below correspond to "New Consumer Configs"// https://kafka.apache.org/documentation/#newconsumerconfigs// check the kafka workers didn't quit// Timeout exceeded: force shutdown// at least we tried// TODO: bad idea to lazy reference properties from a mutable builder// copy them here and then pass this to the KafkaCollectorWorker constructor instead// Interrupts are normal on shutdown, intentionally swallowimport ChronoUnitimport AtomicBooleanimport ConsumerRebalanceListenerimport ConsumerRecordimport ConsumerRecordsimport KafkaConsumerimport TopicPartition/** Consumes spans from Kafka messages, ignoring malformed input */new AtomicReference<List<TopicPartition>>(...)new AtomicBoolean(...)KafkaCollectorWorker.classList<String> topics, ...;AtomicReference<List<TopicPartition>> assignedPartitions, ...;// added for integration tests only, see ITKafkaCollectorAtomicBoolean running, ...;KafkaCollector.Builderbuilder.topicKafkaConsumer<byte[],byte[]> kafkaConsumernew KafkaConsumer<byte[],byte[]>(...)subscribe(...)new ConsumerRebalanceListener(...) { ... }new ArrayList<E>(...)ConsumerRecords<byte[],byte[]> consumerRecordsChronoUnit.MILLISConsumerRecord<byte[],byte[]> recordwarn(...)/** Stop the polling loop */// technically we should remove only the revoked partitions but for test purposes it// does not matter// need two bytes to check if protobuf// If we received legacy single-span encoding, decode it into a singleton list/* thrift, but not list */import TimeoutExceptionimport KafkaProducerimport ProducerRecordimport ByteArraySerializerimport AfterEachimport BeforeEachimport TestInstanceimport Timeoutimport RegisterExtensionimport static SpanBytesEncoder.JSON_V2TestInstance.Lifecycle.PER_CLASSTestInstance.Lifecyclenew KafkaExtension(...)KafkaExtension kafka, ...;InMemoryCollectorMetrics kafkaMetrics, ...;KafkaProducer<byte[],byte[]> producer, ...;Properties configbootstrapServer(...)new KafkaProducer<byte[],byte[]>(...)new ByteArraySerializer(...)KafkaCollector collector/** Don't raise exception (crash process), rather fail status check! This allows the health check ... */bootstrapServers(...)hasMessage(...)isInstanceOf(...)KafkaException.class/** If the Kafka broker(s) specified in the connection string are not available, the Kafka consumer ... */TimeoutException.class/** Ensures legacy encoding works: a single TBinaryProtocol encoded span */produceSpans(...)/** Ensures list encoding works: a TBinaryProtocol encoded list of spans */containsAll(...)byte[] traceBytesprepareTopics(...)warmUpTopic(...)waitForPartitionAssignments(...)traceBytes.lengthget(...).topicscollector.kafkaWorkers.workerscollector.kafkaWorkers/** Producing this empty message triggers auto-creation of the topic and gets things "warmed up" on ... *//** Wait until all kafka consumers created by the collector have at least one partition assigned. */long consumersWithAssignmentscollector.kafkaWorkers.streamsstream(...)new Predicate<KafkaCollectorWorker>(...) { ... }w.assignedPartitionssend(...)new ProducerRecord<byte[],byte[]>(...)flush(...)newCollectorBuilder(...)// wait for crash// the only way we could read this, is if the malformed spans were skipped.// storage failure isn't a message failureimport ExecutionExceptionimport AdminClientConfigimport NewTopicimport TopicExistsExceptionimport AfterAllCallbackimport BeforeAllCallbackimport ExtensionContextimport TestAbortedExceptionimport GenericContainerimport InternetProtocolimport Slf4jLogConsumerimport Waitimport static DockerImageName.parsenew KafkaContainer(...)KafkaExtension.classLogger LOGGER, ...;int KAFKA_PORT, ...;KafkaContainer container, ...;getEnclosingClass(...)getRequiredTestClass(...)List<NewTopic> newTopicsnew ArrayList<NewTopic>(...)AdminClientConfig.BOOTSTRAP_SERVERS_CONFIGString topicnew NewTopic(...)AdminClient adminClientall(...)createTopics(...)new TestAbortedException(...)getMappedPort(...)getHost(...)streams(...)groupId(...)topic(...)// mostly waiting for https://github.com/testcontainers/testcontainers-java/issues/3537getProperty(...)forHealthcheck(...)addFixedExposedPort(...)InternetProtocol.TCPwithLogConsumer(...)new Slf4jLogConsumer(...)// Only run once in outermost scope.// 19092 is for connections from the Docker host and needs to be used as a fixed port.// TODO: someone who knows Kafka well, make ^^ comment better!import BasicPropertiesimport Addressimport Channelimport Connectionimport ConnectionFactoryimport DefaultConsumerimport Envelope/** This collector consumes encoded binary messages from a RabbitMQ queue. *//** Configuration including defaults needed to consume spans from a RabbitMQ queue. */RabbitMQCollector.classnew ConnectionFactory(...)ConnectionFactory connectionFactory, ...;...[] addresses, ...;this.addressesconvertAddresses(...)/** Queue zipkin spans will be consumed from. Defaults to "zipkin-spans". */new RabbitMQCollector(...)LazyInit connection, ...;connection.failureconnection.builder.addressesconnection.builder/** Lazy creates a connection and a queue before starting consumers */Connection connection, ...;// copy them here and then pass this to the KafkaCollectorWorker ctor insteadConnection maybeConnectionConnection connectionCollector collectorCollectorMetrics metricsnewConnection(...)builder.addressesdeclareQueueIfMissing(...)TimeoutException eString consumerTagChannel channelcreateChannel(...)RabbitMQSpanConsumer consumernew RabbitMQSpanConsumer(...)basicConsume(...)queueDeclarePassive(...)IOException maybeQueueDoesNotExistThrowable causequeueDeclare(...)/** Consumes spans from messages on a RabbitMQ queue. Malformed messages will be discarded. Errors ... */body.lengthAddress[] addressArraynew Address[]String[] splitAddressString hostsplitAddress.lengthNumberFormatException ignorenew Address(...)// this sets up a channel for each consumer thread.// We don't track channels, as the connection will close its channels implicitly// check if queue already existsnew RabbitMQExtension(...)RabbitMQExtension rabbit, ...;InMemoryCollectorMetrics rabbitmqMetrics, ...;ConnectionFactory factorysetHost(...)host(...)setPort(...)RabbitMQCollector collectorRabbitMQCollector.BuilderbasicPublish(...)import static Assertions.assertThatThrownByRabbitMQCollector collector, ...;ConnectionFactory connectionFactorysetConnectionTimeout(...)addresses(...)CheckResult checkisFalse(...)hasMessageStartingWith(...)assertThatThrownBy(...)new ThrowingCallable(...) { ... }// We can be pretty certain RabbitMQ isn't running on localhost port 80// NOTE.. This is probably not good as it can crash on transient failure..import ExecResultnew RabbitMQContainer(...)RabbitMQExtension.classint RABBIT_PORT, ...;RabbitMQContainer container, ...;declareQueue(...)ExecResult resultexecInContainer(...)getExitCode(...)withExposedPorts(...)forLogMessage(...)withStartupTimeout(...)// rabbit's image doesn't expose any portimport CommonPoolsimport EventLoopGroupsimport ServerBootstrapimport ChannelInitializerimport EventLoopGroupimport SocketChannelimport LengthFieldBasedFrameDecoderimport InetSocketAddressScribeSpanConsumer scribe, ...;EventLoopGroup bossGroup, ...;Channel channel, ...;this.scribeEventLoopGroup workerGroupworkerGroup(...)ServerBootstrap bnew ServerBootstrap(...)newEventLoopGroup(...)channel(...)syncUninterruptibly(...)bind(...)childHandler(...)new ChannelInitializer<SocketChannel>(...) { ... }group(...)serverChannelType(...)addLast(...)new ScribeInboundHandler(...)pipeline(...)new LengthFieldBasedFrameDecoder(...)Integer.MAX_VALUEshutdownGracefully(...)isActive(...)getPort(...)localAddress(...)// TODO: chain these futures, and probably block a bit// https://line-armeria.slack.com/archives/C1NGPBUH2/p1591167918430500/** This collector accepts Scribe logs in a specified category. Each log entry is expected to contain ... *//** Configuration including defaults needed to receive spans from a Scribe category. */ScribeCollector.classString category, ...;/** Category zipkin spans will be consumed from. Defaults to "zipkin" */this.category/** The port to listen on. Defaults to 9410 */new ScribeCollector(...)NettyScribeServer server, ...;new NettyScribeServer(...)new ScribeSpanConsumer(...)builder.category/** Will throw an exception if the {@link Builder#port(int) port} is already in use. */isRunning(...)/** Returns zero until {@link #start()} was called. */server.scribe.categoryserver.scribeimport HttpDataimport HttpHeaderNamesimport HttpMethodimport HttpRequestimport HttpResponseimport RequestHeadersimport Exceptionsimport SafeCloseableimport ServiceRequestContextimport ServiceRequestContextBuilderimport THttpServiceimport ByteBufimport Unpooledimport ChannelFutureListenerimport ChannelHandlerContextimport ChannelInboundHandlerAdapterimport EventLoopimport HashMapnew HashMap<Integer,ByteBuf>(...)ScribeInboundHandler.classHttpHeaderNames.USER_AGENTHttpHeaderNames.ACCEPTHttpHeaderNames.CONTENT_TYPEHttpMethod.POSTRequestHeaders THRIFT_HEADERS, ...;// Headers mostly copied from https://github.com/apache/thrift/blob/master/lib/javame/src/org/apache/thrift/transport/THttpClient.java#L130THttpService scribeService, ...;Map<Integer,ByteBuf> pendingResponses, ...;int nextResponseIndex, ...;int previouslySentResponseIndex, ...;HttpRequest requestServiceRequestContextBuilder requestContextBuilderalloc(...)service(...)ServiceRequestContext requestContextHttpResponse responseint responseIndexexecutor(...)eventLoop(...)SafeCloseable unusedpush(...)serve(...)exceptionCaught(...)handle(...)aggregateWithPooledObjects(...)new BiFunction<AggregatedHttpResponse,Throwable,Object>(...) { ... }HttpData contentcontent(...)ByteBuf returnedbuffer(...)writeBytes(...)byteBuf(...)writeAndFlush(...)flushResponses(...)release(...)logIfUnexpected(...)closeOnFlush(...)ByteBuf responseforEach(...)new Consumer<ByteBuf>(...) { ... }/** Closes the specified channel after all queued write requests are flushed. */addListener(...)ChannelFutureListener.CLOSEUnpooled.EMPTY_BUFFER// TODO: errorprone wants us to check futures before returning, but what would be a sensible check?// Say it is somehow canceled, would we take action? Would callback.onError() be redundant?import StandardCharsetsimport Base64import AsyncMethodCallbackimport LogEntryimport ResultCodeimport ScribeScribe.AsyncIfaceint byteCountLogEntry logEntrylogEntry.messageStandardCharsets.ISO_8859_1logEntry.categorydecode(...)getMimeDecoder(...)blockingTaskExecutor(...)onComplete(...)ResultCode.OKException error// finagle-zipkin uses mime encoding// Collectors may not be asynchronous so switch to blocking executor here.LogEntry._Fieldsnew TStruct(...)new TField(...)TType.STRINGnew LogEntryStandardSchemeFactory(...)new LogEntryTupleSchemeFactory(...)Map<_Fields,FieldMetaData> tmpMapnew EnumMap<_Fields,FieldMetaData>(...)_Fields.class_Fields.CATEGORYnew FieldMetaData(...)TFieldRequirementType.DEFAULTnew FieldValueMetaData(...)_Fields.MESSAGEunmodifiableMap(...)addStructMetaDataMap(...)LogEntry.classTStruct STRUCT_DESC, ...;TField CATEGORY_FIELD_DESC, ...;TField MESSAGE_FIELD_DESC, ...;SchemeFactory STANDARD_SCHEME_FACTORY, ...;SchemeFactory TUPLE_SCHEME_FACTORY, ...;String message, ...;// required/** The set of fields this struct contains, along with convenience methods for finding and manipulating them. */new _Fields(...)new HashMap<String,_Fields>(...)_Fields fieldallOf(...)getFieldName(...)_Fields CATEGORY, ...;_Fields MESSAGE, ...;Map<String,_Fields> byName, ...;/** Find the _Fields constant that matches fieldId, or null if its not found. *//** Find the _Fields constant that matches fieldId, throwing an exception ... */_Fields fieldsfindByThriftId(...)/** Find the _Fields constant that matches name, or null if its not found. */short _thriftId, ...;String _fieldName, ...;Map<_Fields,FieldMetaData> metaDataMap, ...;// isset id assignmentsthis.message/** Performs a deep copy on <i>other</i>. */isSetCategory(...)other.categoryisSetMessage(...)other.messagenew LogEntry(...)/** Returns true if field category is set (has been assigned a value) and false otherwise *//** Returns true if field message is set (has been assigned a value) and false otherwise */unsetCategory(...)setCategory(...)unsetMessage(...)setMessage(...)getCategory(...)/** Returns true if field corresponding to fieldID is set (has been assigned a value) and false otherwise */boolean this_present_categoryboolean that_present_categoryboolean this_present_messageboolean that_present_messagethat.categorythat.messageint hashCodeint lastComparisonscheme(...)StringBuilder sbboolean firstnew TCompactProtocol(...)new TIOStreamTransport(...)TException tenew LogEntryStandardScheme(...)TField schemeFieldreadStructBegin(...)readFieldBegin(...)schemeField.typeTType.STOPschemeField.idstruct.categoryreadString(...)setCategoryIsSet(...)struct.messagesetMessageIsSet(...)readFieldEnd(...)readStructEnd(...)validate(...)writeStructBegin(...)writeFieldBegin(...)writeString(...)writeFieldEnd(...)writeFieldStop(...)writeStructEnd(...)new LogEntryTupleScheme(...)TTupleProtocol oprotBitSet optionalsnew BitSet(...)writeBitSet(...)TTupleProtocol iprotBitSet incomingreadBitSet(...)getScheme(...)StandardScheme<>.class/** Autogenerated by Thrift Compiler (0.12.0) ... */// CATEGORY// MESSAGE// check for required fields// check for sub-struct validity// check for required fields of primitive type, which can't be checked in the validate methodnew ResultCode(...)ResultCode OK, ...;ResultCode TRY_LATER, ...;int value, ...;/** Get the integer value of this enum value, as defined in the Thrift IDL. *//** Find a the enum type by its integer value, as defined in the Thrift IDL. ... */new Client(...)send_Log(...)recv_Log(...)Log_args argsnew Log_args(...)setMessages(...)sendBase(...)Log_result resultnew Log_result(...)receiveBase(...)isSetSuccess(...)result.successnew TApplicationException(...)TApplicationException.MISSING_RESULTTAsyncClientManager clientManager, ...;TProtocolFactory protocolFactory, ...;this.clientManagerthis.protocolFactorynew AsyncClient(...)Log_call method_callnew Log_call(...)checkReady(...)this.___currentMethodcall(...)List<LogEntry> messages, ...;writeMessageBegin(...)new TMessage(...)TMessageType.CALLwriteMessageEnd(...)TMemoryInputTransport memoryTransportnew TMemoryInputTransport(...)getFrameBuffer(...)TProtocol protgetProtocol(...)getProtocolFactory(...)getState(...)TAsyncMethodCall<>.State.RESPONSE_READTAsyncMethodCall<>.StateProcessor<>.classLogger _LOGGER, ...;getProcessMap(...)new HashMap<String,ProcessFunction<I,? extends TBase<>>>(...)new Log<>(...)Log(...)args.messagesAsyncProcessor<>.classnew HashMap<String,AsyncProcessFunction<I,? extends TBase<>,?>>(...)AbstractNonblockingServer.AsyncFrameBufferAsyncProcessFunction<> fcallnew AsyncMethodCallback<ResultCode>(...) { ... }sendResponse(...)TMessageType.REPLYTTransportException ebyte msgTypeTSerializable msgTMessageType.EXCEPTIONTApplicationException.INTERNAL_ERRORException exLog_args._FieldsTType.LISTnew Log_argsStandardSchemeFactory(...)new Log_argsTupleSchemeFactory(...)_Fields.MESSAGESnew ListMetaData(...)new StructMetaData(...)TType.STRUCTLog_args.classTField MESSAGES_FIELD_DESC, ...;_Fields MESSAGES, ...;isSetMessages(...)List<LogEntry> __this__messagesnew ArrayList<LogEntry>(...)other.messagesLogEntry other_element/** Returns true if field messages is set (has been assigned a value) and false otherwise */unsetMessages(...)getMessages(...)boolean this_present_messagesboolean that_present_messagesthat.messagesnew Log_argsStandardScheme(...)TList _list0readListBegin(...)LogEntry _elem1struct.messages_list0.sizeint _i2readListEnd(...)setMessagesIsSet(...)new TList(...)LogEntry _iter3writeListEnd(...)new Log_argsTupleScheme(...)writeI32(...)LogEntry _iter4TList _list5readI32(...)LogEntry _elem6_list5.sizeint _i7Log_result._FieldsTType.I32new Log_resultStandardSchemeFactory(...)new Log_resultTupleSchemeFactory(...)_Fields.SUCCESSnew EnumMetaData(...)TType.ENUMResultCode.classLog_result.classTField SUCCESS_FIELD_DESC, ...;ResultCode success, ...;_Fields SUCCESS, ...;this.successother.success/** Returns true if field success is set (has been assigned a value) and false otherwise */unsetSuccess(...)setSuccess(...)getSuccess(...)boolean this_present_successboolean that_present_successthat.successnew Log_resultStandardScheme(...)struct.successfindByValue(...)setSuccessIsSet(...)new Log_resultTupleScheme(...)// MESSAGES// SUCCESSimport Collectorsimport TBinaryProtocolimport TProtocolimport TFramedTransportimport TSocketimport TTransportimport AfterAllimport BeforeAllimport TestObjectsimport static ArgumentMatchers.eqimport static Mockito.doAnswerimport static Mockito.timesCollector.classdoAnswer(...)new Answer<>(...) { ... }getArgument(...)TTransport transportnew TFramedTransport(...)new TSocket(...)TProtocol protocolnew TBinaryProtocol(...)Scribe.IfaceIface clientScribe.ClientList<LogEntry> entriescollect(...)toList(...)TestObjects.TRACEnew Function<Span,LogEntry>(...) { ... }logEntry(...)open(...)ResultCode codeeq(...)times(...)encodeToString(...)getMimeEncoder(...)SpanBytesEncoder.THRIFT// Java version of this sample code// https://github.com/facebookarchive/scribe/wiki/Logging-MessagesScribeCollector scribeCheckResult resultIllegalStateException.classisNotZero(...)ScribeCollector.BuilderScribeCollector firstScribeCollector samePortimport static Awaitility.awaitip(...)getEncoder(...)char[] asInMemoryCollectorMetrics scribeMetrics, ...;// scope to scribe as we aren't creating the consumer with the builder.ResultCode resultCode, ...;Exception error, ...;CountDownLatch latch, ...;this.resultCodeString reallyLongAnnotation, ...;Endpoint zipkinQuery, ...;Endpoint zipkinQuery0, ...;V1Span v1, ...;Span v2, ...;String encodedSpan, ...;ScribeSpanConsumer scribenewScribeSpanConsumer(...)LogEntry entryentry.categoryentry.messageexpectSuccess(...)untilAsserted(...)new ThrowingRunnable(...) { ... }SpanConsumer consumerCaptureAsyncMethodCallback callbacknew CaptureAsyncMethodCallback(...)callback.latchcallback.resultCodecallback.errorisNull(...)/** Callbacks are performed asynchronously. If they throw, it hints that we are chaining futures ... *//** Finagle's zipkin tracer breaks on a column width with a trailing newline */decode(...).lengthcategory(...)// Storage finishes after callback so wait for it.// as we shouldn't get here.// Storage related exceptions are not propagated to the caller. Only marshalling ones are.import MockResponseimport static SocketPolicy.DISCONNECT_DURING_REQUEST_BODY/** Instrumentation that use {@code POST} endpoints need to survive failures. Besides simply not ... *//** Ex a network partition occurs in the middle of the POST request */new HttpFailure(...)setSocketPolicy(...)new MockResponse(...)/** Ex code 400 when the server cannot read the spans */setBody(...)setResponseCode(...)MockResponse response, ...;/** Not exposed publicly in order to not leak okhttp3 types. */this.responseimport HttpUrlimport Dispatcherimport MockWebServerimport RecordedRequestimport Bufferimport GzipSourceCollector consumer, ...;MockWebServer server, ...;this.consumerthis.serverHttpUrl urlurl(...)getMethod(...)String typegetHeader(...)encodedPath(...)SpanBytesDecoder decoderbyte[] bodyreadByteArray(...)getBody(...)String encodingMockResponse resultBuffer resultnew Buffer(...)GzipSource sourcenew GzipSource(...)// unsupported method// lenient on emptyimport BlockingQueueimport TestRuleimport Descriptionimport Statementimport static SocketPolicy.KEEP_OPEN/** Starts up a local Zipkin server, listening for http requests on {@link #httpUrl}. ... */new MockWebServer(...)new LinkedBlockingQueue<MockResponse>(...)BlockingQueue<MockResponse> failureQueue, ...;AtomicInteger receivedSpanBytes, ...;ZipkinDispatcher successDispatchnew ZipkinDispatcher(...)Dispatcher dispatchernew Dispatcher(...) { ... }MockResponse maybeFailuredispatch(...)getBodySize(...)setDispatcher(...)/** Use this to connect. The zipkin v1 interface will be under "/api/v1" */getHostName(...)/** Use this to see how many requests you've sent to any zipkin http endpoint. */getRequestCount(...)/** Use this to see how many spans or serialized bytes were collected on the http endpoint. *//** Stores the given spans directly, to setup preconditions for a test. ... *//** Adds a one-time failure to the http endpoint. ... */failure.response/** Retrieves all traces this zipkin server has received. *//** Retrieves a trace by ID which Zipkin server has received, or null if not present. *//** Retrieves all service links between traces this zipkin server has received. */getDependencies(...)/** Used to manually start the server. ... *//** Used to manually stop the server. */apply(...)// Note: this is a different behavior than Traces.getTrace() which is not nullable!import MediaTypeimport OkHttpClientimport Requestimport RequestBodyimport Responseimport ByteStringimport GzipSinkimport AssumptionViolatedExceptionimport SLF4JBridgeHandlerimport static Assertions.failBecauseExceptionWasNotThrownnew ZipkinRule(...)new OkHttpClient(...)removeHandlersForRootLogger(...)install(...)ZipkinRule zipkin, ...;OkHttpClient client, ...;code(...)postSpansV1(...)getTraces_storedViaPostVersion2(...)Response responsenewCall(...)post(...)Request.BuilderhttpUrl(...)/** The rule is here to help debugging. Even partial spans should be returned *//** The raw query can show affects like redundant rows in the data store. */Span missingDurationSpan withDurationstoreSpans(...)httpRequestCount(...)/** Normally, a span can be reported twice: for client and server. However, there are bugs that ... */collectorMetrics(...)enqueueFailure(...)disconnectDuringBody(...)failBecauseExceptionWasNotThrown(...)IOException.classIOException expectedIOException flakenew AssumptionViolatedException(...)sendErrorResponse(...)string(...)body(...)byte[] spansInJsonBuffer sinkGzipSink gzipSinknew GzipSink(...)ByteString gzippedJsonreadByteString(...)spansInJson.lengthaddHeader(...)// ensure jul-to-slf4j works// write the span to the zipkin using http// read the traces directly// write the span to the zipkin using http api v2// write the span to zipkin directly// not always a ConnectException!// Zipkin didn't store the spans, as they shouldn't have been readable, due to disconnect// The failure shouldn't affect later requests// Zipkin didn't store the spans, as they shouldn't have been readable, due to the errorimport Documentedimport ElementTypeimport Retentionimport RetentionPolicyimport Targetimport Importimport InternalZipkinConfiguration/** @deprecated ... */ElementType.TYPEInternalZipkinConfiguration.classimport SpringBootConfigurationimport EnableAutoConfigurationimport SpringApplicationBuilderimport EnableZipkinServerimport ZipkinActuatorImporterimport ZipkinModuleImporterimport ZipkinBanner/** This adds the {@link EnableAutoConfiguration} annotation, but disables it by default to save ... */properties(...)logStartupInfo(...)initializers(...)banner(...)new ZipkinModuleImporter(...)new ZipkinActuatorImporter(...)new SpringApplicationBuilder(...)new ZipkinBanner(...)ZipkinServer.classEnableAutoConfiguration.ENABLED_OVERRIDE_PROPERTY// Avoids potentially expensive DNS lookup and inaccurate startup timingimport ExceptionHandlerFunctionimport static HttpStatus.BAD_REQUESTimport static HttpStatus.INTERNAL_SERVER_ERRORimport static MediaType.ANY_TEXT_TYPEBodyIsExceptionMessage.classmethod(...)path(...)ZipkinHttpCollector.metricsimport ConditionOutcomeimport SpringBootConditionimport ConditionContextimport Conditionalimport AnnotationAttributesimport AnnotatedTypeMetadata/** This helps solve a number of problems including the following, which sometimes only break in an ... */ElementType.METHODConditionalOnSelfTracing.SelfTracingCondition.classConditionalOnSelfTracing.SelfTracingConditioncheckForBrave(...)boolean BRAVE_PRESENT, ...;ClassNotFoundException eString selfTracingEnabledgetEnvironment(...)String expectedStorageTypegetString(...)fromMap(...)getAnnotationAttributes(...)ConditionalOnSelfTracing.classString storageTypenoMatch(...)match(...)ConditionalOnThrottledStorage.ThrottledStorageCondition.classConditionalOnThrottledStorage.ThrottledStorageConditionString throttleEnabledimport ArmeriaAutoConfigurationimport ZipkinActiveMQCollectorConfigurationimport ZipkinSelfTracingConfigurationimport ZipkinCassandra3StorageConfigurationimport ZipkinElasticsearchStorageConfigurationimport ZipkinHealthControllerimport ZipkinKafkaCollectorConfigurationimport ZipkinMySQLStorageConfigurationimport ZipkinMetricsControllerimport ZipkinPrometheusMetricsConfigurationimport ZipkinRabbitMQCollectorConfigurationimport ZipkinScribeCollectorConfigurationimport ZipkinUiConfigurationArmeriaAutoConfiguration.classZipkinConfiguration.classZipkinHttpConfiguration.classZipkinUiConfiguration.classZipkinCassandra3StorageConfiguration.classZipkinElasticsearchStorageConfiguration.classZipkinMySQLStorageConfiguration.classZipkinScribeCollectorConfiguration.classZipkinSelfTracingConfiguration.classZipkinQueryApiV2.classZipkinHttpCollector.classZipkinGrpcCollector.classZipkinActiveMQCollectorConfiguration.classZipkinKafkaCollectorConfiguration.classZipkinRabbitMQCollectorConfiguration.classZipkinMetricsController.classZipkinHealthController.classZipkinPrometheusMetricsConfiguration.classimport JsonFactoryimport JsonGeneratorimport DefaultIndenterimport DefaultPrettyPrinter/** Utilities for working with JSON. */new JsonFactory(...)new DefaultIndenter(...)JsonFactory JSON_FACTORY, ...;DefaultPrettyPrinter.Indenter TWOSPACES_LF_INDENTER, ...;DefaultPrettyPrinter.Indenter/** Creates a new {@link JsonGenerator} with pretty-printing enabled forcing {@code '\n'} ... */JsonGenerator generatorcreateGenerator(...)DefaultPrettyPrinter prettyPrinternew DefaultPrettyPrinter(...)indentArraysWith(...)indentObjectsWith(...)setPrettyPrinter(...)import Counterimport Gaugeimport MeterRegistry/** This is a simple metric service that exports the following to the "/metrics" endpoint: ... */MeterRegistry registryInstance, ...;Counter messages, ...;AtomicInteger messageBytes, ...;this.registryInstanceregister(...)tag(...)description(...)baseUnit(...)this.messageSpansnew ToDoubleFunction<AtomicInteger>(...) { ... }this.messageBytesnew MicrometerCollectorMetrics(...)checkScoped(...)import Callableimport Future// copy/pasted from Brave/** Used to implement a context propagating executor service which wraps tasks */invokeAll(...)invokeAny(...)isShutdown(...)isTerminated(...)submit(...)ArrayList<Callable<T>> resultnew ArrayList<Callable<T>>(...)Callable<T> taskimport Binderimport ApplicationContextInitializerimport ImportSelectorimport GenericApplicationContextimport ConfigurableEnvironment// look at RATIONALE.md and update if relevant when changing this file/** When auto-configuration is enabled, actuator and all of its subordinate endpoints such as {@code ... */ZipkinActuatorImporter.classString ACTUATOR_IMPL_CLASS, ...;String PROPERTY_NAME_ACTUATOR_ENABLED, ...;String PROPERTY_NAME_ACTUATOR_INCLUDE, ...;String actuatorImplClass, ...;this.actuatorImplClassConfigurableEnvironment envString[] includesorElse(...)...[].classequalsIgnoreCase(...)includes.lengthregisterBean(...)String include// At this point in the life-cycle, env can directly resolve plain properties, like the boolean// above. If you tried to resolve a property bound by a yaml list, it returns null, as they are// not yet bound.// As we are in a configurable environment, we can bind lists properties. We expect this to take// includes from PROPERTY_NAME_ACTUATOR_INCLUDE yaml path of zipkin-server-shared.yml.// Skip any classes that didn't match due to driftimport Tracingimport BeansExceptionimport BeanFactoryimport BeanFactoryAwareimport Valueimport BeanPostProcessorimport ConditionalOnMissingBeanimport EnableConfigurationPropertiesimport Beanimport Conditionimport TracingStorageComponentimport ThrottledStorageComponentimport ZipkinStorageThrottleProperties/** Base collector and storage configurations needed for higher-level integrations */ZipkinConfiguration.InMemoryConfiguration.classZipkinConfiguration.InMemoryConfigurationZipkinConfiguration.ThrottledStorageComponentEnhancer.classZipkinConfiguration.ThrottledStorageComponentEnhancerZipkinConfiguration.TracingStorageComponentEnhancer.classZipkinConfiguration.TracingStorageComponentEnhancerZipkinStorageThrottleProperties.classBeanFactory beanFactory, ...;/** Need this to resolve cyclic instantiation issue with spring when instantiating with metrics ... */ZipkinStorageThrottleProperties throttlePropertiesgetBean(...)new ThrottledStorageComponent(...)getMinConcurrency(...)getMaxConcurrency(...)getMaxQueueSize(...)MeterRegistry.classcontainsBean(...)Tracing.classthis.beanFactory/** Need this to resolve cyclic instantiation issue with spring when instantiating with tracing. ... */Tracing tracingnew TracingStorageComponent(...)/** This is a special-case configuration if there's no StorageComponent of any kind. In-Mem can ... */StorageTypeMemAbsentOrEmpty.classautocompleteKeys(...)maxSpanCount(...)searchEnabled(...)strictTraceId(...)import AbstractUnsafeUnaryGrpcServiceimport ArmeriaServerConfiguratorimport CompletableFutureimport ConditionalOnProperty/** Collector for receiving spans on a gRPC endpoint. */CollectorMetrics grpcMetricsnew ArmeriaServerConfigurator(...) { ... }new SpanService(...)readableBytes(...)isReadable(...)completedFuture(...)CompletableFutureCallback resultnew CompletableFutureCallback(...)Executor executormapCurrent(...)new Function<ServiceRequestContext,ScheduledExecutorService>(...) { ... }makeContextAware(...)new Supplier<ScheduledExecutorService>(...) { ... }nioBuffer(...)complete(...)completeExceptionally(...)// disabled by default// collector.accept might block so need to move off the event loop. We make sure the// callback is context aware to continue the trace.import StreamDecoderFactoryimport AggregatedHttpRequestimport HttpStatusimport ResponseHeadersimport Consumesimport ConsumesJsonimport ExceptionHandlerimport PostvalidateAndStoreSpans(...)/** This synchronously decodes the message so that users can see data errors. */CompletableCallback resultnew CompletableCallback(...)new BiFunction<AggregatedHttpRequest,Throwable,Object>(...) { ... }HttpData requestContentconvertRequest(...)Throwable t1ByteBuffer nioBufferSpanBytesDecoder unexpectedDecodertestForUnexpectedFormat(...)from(...)clientAddress(...)headers(...)/** Some formats clash on partial data. For example, a v1 and v2 span is identical if only the span ... */...[] BINARY_ANNOTATION_FIELD_SUFFIX, ...;// copy-pasted from SpanBytesDecoderDetector, to avoid making it publicHttpStatus.ACCEPTEDResponseHeaders ACCEPTED_RESPONSE, ...;HttpHeaderNames.CONTENT_ENCODINGnewDecoder(...)gzip(...)maybeLog(...)toStringAscii(...)empty(...)// converter instances aren't injected by Spring// TODO: errorprone wants us to check this future before returning, but what would be a sensible// check? Say it is somehow canceled, would we take action? Would callback.onError() be redundant?// logging already handled upstream in UnzippingBytesRequestConverter where request context exists// The implementation of the armeria decoder is to return an empty body on failureimport HttpServiceimport CorsServiceimport CorsServiceBuilderimport HttpFileimport PrometheusExpositionServiceimport CollectorRegistryimport Optionalimport Functionimport Configurationimport OrderMediaType MEDIA_TYPE_ACTUATOR, ...;ifPresent(...)new Consumer<ZipkinQueryApiV2>(...) { ... }Function<HttpService,HttpService> timeoutDecoratornew Function<HttpService,HttpService>(...) { ... }new HttpService(...) { ... }setRequestTimeout(...)annotatedService(...)new Consumer<ZipkinHttpCollector>(...) { ... }new Consumer<ZipkinHealthController>(...) { ... }new Consumer<ZipkinMetricsController>(...) { ... }new Consumer<CollectorRegistry>(...) { ... }PrometheusExpositionService prometheusServicenew PrometheusExpositionService(...)infoService(...)MediaType.JSON_UTF_8requestTimeout(...)trace(...)routeDecorator(...)new DecoratingHttpServiceFunction(...) { ... }HttpStatus.METHOD_NOT_ALLOWED/** Configures the server at the last because of the specified {@link Order} annotation. */CorsServiceBuilder corsBuilderexposeHeaders(...)allowRequestHeaders(...)allowRequestMethods(...)HttpMethod.GETdecorator(...)asService(...)contentType(...)getClassLoader(...)// For UI.// Directly implement info endpoint, but use different content type for the /actuator path// It's common for backend requests to have timeouts of the magic number 10s, so we go ahead// and default to a slightly longer timeout on the server to be able to handle these with// better error messages where possible.// Block TRACE requests because https://github.com/openzipkin/zipkin/issues/2286// NOTE: The property says query, and the UI does not use POST, but we allow POST?// The reason is that our former CORS implementation accidentally allowed POST. People doing// browser-based tracing relied on this, so we can't remove it by default. In the future, we// could split the collector's CORS policy into a different property, still allowing POST// with content-type by default.// Use literals to avoid a runtime dependency on armeria-grpc types/** This loads configuration needed for modules like zipkin-aws, but without relying on ... */ZipkinModuleImporter.classString PROPERTY_NAME_MODULE, ...;Map<String,String> modulesMap<>.classEntry<String,String> module// above. If you tried to resolve a property bound by a yaml map, it returns null, as they are// includes from PROPERTY_NAME_MODULE yaml path from all modules.import AggregatedHttpResponseimport ResponseHeadersBuilderimport Blockingimport Defaultimport Getimport Paramimport ByteBufAllocatorimport ByteBufOutputStreamimport OutputStreamimport static HttpHeaderNames.CACHE_CONTROLimport static HttpStatus.NOT_FOUNDString storageType, ...;long defaultLookback, ...;// don't cache spanStore here as it can cause the app to crash!int namesMaxAge, ...;/** The Cache-Control max-age (seconds) for /api/v2/services /api/v2/remoteServices and ... */int serviceCount, ...;// used as a threshold to start returning cache-control headersthis.storageTypethis.defaultLookbackthis.namesMaxAgeCall<List<DependencyLink>> calljsonResponse(...)List<String> serviceNamesmaybeCacheNames(...)List<String> spanNamesList<String> remoteServiceNamesgetRemoteServiceNames(...)QueryRequest queryRequestparseAnnotationQuery(...)currentTimeMillis(...)List<List<Span>> traceswriteTraces(...)setInt(...)HttpHeaderNames.CONTENT_LENGTHMediaType.JSONList<String> valuesgetValues(...)/** We cache names if there are more than 3 names. This helps people getting started: if we cache ... */int sizeEstimateByteBuf bufResponseHeadersBuilder headersJsonGenerator genJsonUtil.JSON_FACTORYnew ByteBufOutputStream(...)writeStartArray(...)writeEndArray(...)// This is inlined here as there isn't enough re-use to warrant it being in the zipkin2 librarybyte[] outint jLength// 1 day in millis// 5 minutes// Two brackets./* comma */// Last element doesn't have a comma.// If the values don't require escaping, this buffer will not be resized.// Get the encoded size of the nested list so that we don't need to grow the buffer// start list of traces// stop list of tracesimport ConditionalOnClassimport ActiveMQCollector/** Auto-configuration for {@link ActiveMQCollector}. */ZipkinActiveMQCollectorProperties.classZipkinActiveMQCollectorConfiguration.ActiveMQUrlSet.classZipkinActiveMQCollectorConfiguration.ActiveMQUrlSet/** This condition passes when {@link ZipkinActiveMQCollectorProperties#getUrl()}} is set to ... */notFalse(...)import ConfigurationProperties/** Properties for configuring and building a {@link ActiveMQCollector}. */String url, ...;/** URL of the ActiveMQ broker. *//** ActiveMQ queue from which to collect the Zipkin spans */String clientIdPrefix, ...;/** Client ID prefix for queue consumers */String connectionIdPrefix, ...;/** Connection ID prefix for queue consumers */Integer concurrency, ...;/** Number of concurrent span consumers */String username, ...;/** Login user of the broker. */String password, ...;/** Login password of the broker. */this.urlemptyToNull(...)this.clientIdPrefixthis.connectionIdPrefixthis.usernamethis.passwordsetClientIDPrefix(...)setConnectionIDPrefix(...)import PrintStreamimport Bannerimport AnsiElementimport AnsiOutputimport AnsiStyleimport Environmentimport ClassPathResourceimport StreamUtils/** More efficient Banner implementation which doesn't use property sources as variables are expanded ... */new AnsiElement(...) { ... }AnsiElement ZIPKIN_ORANGE, ...;InputStream streamgetInputStream(...)new ClassPathResource(...)String bannercopyToString(...)replace(...)AnsiStyle.NORMALprintln(...)// Ansi 256 color code 208 (orange)// Instead of use property expansion for only 2 ansi codes, inline them// who caresimport DurationUnitboolean enabled, ...;/** Whether self-tracing is enabled. Defaults to {@code false}. */float sampleRate, ...;/** The percentage of traces retained when self-tracing. If 1.0 (i.e., all traces are sampled), the ... */int tracesPerSecond, ...;/** The number of traces per second to retain. If 0, an unlimited number of traces will be ... */Duration messageTimeout, ...;/** Timeout to flush self-tracing data to storage. */ChronoUnit.SECONDSthis.enabledthis.sampleRatethis.tracesPerSecondthis.messageTimeoutimport ScopedSpanimport TracerTracer tracer, ...;this.tracerScopedSpan spanstartScopedSpan(...)nextSpan(...)isNoop(...)new SpanFinishingCallback<V>(...)new TracedCall(...)Callback<V> delegate, ...;import AutocompleteTagsimport ServiceAndSpanNames// public for use in ZipkinServerConfigurationTracing tracing, ...;StorageComponent delegate, ...;this.tracingnew TracingServiceAndSpanNames(...)new TracingTraces(...)new TracingSpanStore(...)new TracingAutocompleteTags(...)new TracingSpanConsumer(...)Traces delegate, ...;tracer(...)new TracedCall<List<Span>>(...)new TracedCall<List<List<Span>>>(...)new TracedCall<List<String>>(...)new TracedCall<List<DependencyLink>>(...)AutocompleteTags delegate, ...;getKeys(...)ServiceAndSpanNames delegate, ...;SpanConsumer delegate, ...;new TracedCall<Void>(...)import MDCScopeDecoratorimport HttpTracingimport B3Propagationimport CurrentTraceContextimport ThreadLocalSpanimport BoundarySamplerimport RateLimitingSamplerimport Samplerimport RequestContextCurrentTraceContextimport BraveServiceimport Encodingimport ReporterMetricsimport Senderimport AsyncZipkinSpanHandlerimport ConditionalOnSelfTracingSelfTracingProperties.class/** Configuration for how to buffer spans into messages for Zipkin */messageTimeout(...)new ReporterMetricsAdapter(...)threadFactory(...)new LocalSender(...)new ThreadFactory(...) { ... }new Thread(...)setCurrentThreadNotRequestThread(...)getMessageTimeout(...)addScopeDecorator(...)/** There's no attribute namespace shared across request and response. Hence, we need to save off a ... *//** This controls the general rate. In order to not accidentally start traces started from the ... */getSampleRate(...)getTracesPerSecond(...)Sampler.ALWAYS_SAMPLE/** Controls aspects of tracing such as the name that shows up in the UI */addSpanHandler(...)propagationFactory(...)currentTraceContext(...)Sampler.NEVER_SAMPLEinjectFormat(...)newFactoryBuilder(...)B3Propagation<>.Format.SINGLEB3Propagation<>.FormatserverSampler(...)new SamplerFunction<HttpRequest>(...) { ... }String pathnewDecorator(...)/** Lazily looks up the storage component in order to to avoid proxying. */BeanFactory factory, ...;// volatile to prevent stale readsbyte[] encodedSpanSpan v2Span/** Lazy lookup to avoid proxying */StorageComponent result(...).delegateCollectorMetrics delegate, ...;CollectorMetrics result// puts trace IDs into logs// don't sample traces at this abstraction// Reduce the impact on untraced downstream http services such as Elasticsearch// server starts traces for read requests under the path /api// use the global rate limit// TODO: less memory efficient, but not a huge problem for self-tracing which is rarely on// https://github.com/openzipkin/zipkin-reporter-java/issues/178// arbitrary// Avoid using the delegate to avoid eagerly loading the bean during initialization// don't close delegate as we didn't open it!// synchronization is not needed as redundant calls have no ill effectsimport CassandraStorageimport SessionFactory/** This storage accepts Cassandra logs in a specified category. Each log entry is expected to ... */CassandraStorage.classZipkinCassandra3StorageProperties.classZipkinCassandra3StorageConfiguration.TracingSessionFactoryEnhancer.classZipkinCassandra3StorageConfiguration.TracingSessionFactoryEnhancerSessionFactory.DEFAULTsessionFactory(...)autocompleteCardinality(...)autocompleteTtl(...)// This component is named .*Cassandra3.* even though the package already says cassandra3 because// Spring Boot configuration endpoints only printout the simple name of the class//if (bean instanceof SessionFactory && beanFactory.containsBean("tracing")) {//  SessionFactory delegate = (SessionFactory) bean;//  Tracing tracing = beanFactory.getBean(Tracing.class);//  return (SessionFactory) storage -> TracingSession.create(tracing, delegate.create(storage));//}String keyspace, ...;String contactPoints, ...;String localDc, ...;int maxConnections, ...;boolean ensureSchema, ...;boolean useSsl, ...;int indexFetchMultiplier, ...;/** See {@link CassandraStorage.Builder#indexFetchMultiplier(int)} */this.keyspacethis.contactPointsthis.localDcthis.maxConnectionsthis.ensureSchemathis.useSslthis.indexFetchMultiplierCassandraStorage.BuilderindexFetchMultiplier(...)password(...)username(...)useSsl(...)ensureSchema(...)maxConnections(...)localDc(...)contactPoints(...)keyspace(...)import ClientRequestContextimport HttpClientimport SimpleDecoratingHttpClientimport Objects/** Adds basic auth username and password to every request. ... */BasicCredentials basicCredentials, ...;this.basicCredentialsString credentialsgetCredentials(...)addAdditionalRequestHeader(...)HttpHeaderNames.AUTHORIZATIONunwrap(...)/** Generate Elasticsearch basic user credentials. ... */String basicCredentials, ...;updateCredentials(...)String tokenimport FileInputStreamimport static ZipkinElasticsearchStorageConfiguration.PASSWORDimport static ZipkinElasticsearchStorageConfiguration.USERNAME/** Loads username/password from credentials file. ... */DynamicCredentialsFileLoader.classString credentialsFile, ...;this.credentialsFileupdateCredentialsFromProperties(...)Properties propertiesString usernameensureNotEmptyOrNull(...)String passwordFileInputStream isnew FileInputStream(...)load(...)import ClientFactoryimport ClientOptionsimport ClientOptionsBuilderimport WebClientimport DecodingClientimport EndpointGroupimport ContentPreviewingClientimport LoggingClientimport LoggingClientBuilderimport MetricCollectingClientimport HttpHeadersimport SessionProtocolimport LogLevelimport MeterIdPrefixFunctionimport Consumerimport HttpLogging// Exposed as a bean so that zipkin-aws can use this for api requests to get initial endpoints.SessionProtocol protocol, ...;ClientOptions options, ...;ClientFactory clientFactory, ...;int timeout, ...;List<Consumer<ClientOptionsBuilder>> customizers, ...;HttpLogging httpLogginggetHttpLogging(...)ClientOptionsBuilder optionsofDefault(...)this.clientFactorythis.protocolthis.customizersthis.timeoutgetTimeout(...)configureHttpLogging(...)this.optionsconfigureOptionsExceptHttpLogging(...)LoggingClientBuilder loggingBuilderrequestHeadersSanitizer(...)successfulResponseLogLevel(...)requestLogLevel(...)LogLevel.INFOnew BiFunction<RequestContext,HttpHeaders,Object>(...) { ... }HttpLogging.NONEcontentSanitizer(...)new BiFunction<RequestContext,Object,Object>(...) { ... }headersSanitizer(...)HttpLogging.BODYoptions(...)/** This takes care to not expose health checks into wire level logging */writeTimeoutMillis(...)responseTimeoutMillis(...)factory(...)new Consumer<Consumer<ClientOptionsBuilder>>(...) { ... }// TODO(anuraaga): Add unit tests after https://github.com/line/armeria/issues/2220import DnsAddressEndpointGroupimport URIInitialEndpointSupplier.classString hosts, ...;SessionProtocol sessionProtocol, ...;this.sessionProtocolthis.hostsuriText(...)List<EndpointGroup> endpointGroupsnew ArrayList<EndpointGroup>(...)String hostTextURI urlisTls(...)isIpAddress(...)defaultPort(...)// possibly extra comma// A host that isn't an IP may resolve to multiple IP addresses, so we use a endpoint// group to round-robin over them. Users can mix addresses that resolve to multiple IPs// with single IPs freely, they'll all get used.import HealthCheckedEndpointGroupimport LazyHttpClientHttpClientFactory factory, ...;Supplier<EndpointGroup> initialEndpoints, ...;ZipkinElasticsearchStorageProperties.HealthCheck healthCheck, ...;ZipkinElasticsearchStorageProperties.HealthCheckint timeoutMillis, ...;MeterRegistry meterRegistry, ...;WebClient result, ...;this.initialEndpointsthis.healthCheckgetHealthCheck(...)this.timeoutMillisthis.meterRegistrygetEndpoint(...)EndpointGroup initialisEnabled(...)decorateHealthCheck(...)// Enables health-checking of an endpoint group, so we only send requests to endpoints that are upHealthCheckedEndpointGroup healthCheckedretryInterval(...)withClientOptions(...)getInterval(...)clientFactory(...)useGet(...)factory.clientFactoryprotocol(...)new Function<ClientOptionsBuilder,ClientOptionsBuilder>(...) { ... }new DecoratingHttpClientFunction(...) { ... }logBuilder(...)bindTo(...)newMeterBinder(...)// Only health-check when there are alternative endpoints. There aren't when instanceof Endpoint// Wrap the result when health checking is enabled.import URLimport KeyStoreimport KeyManagerFactoryimport TrustManagerFactoryimport ResourceUtilsimport Ssl// snippets adapted from com.linecorp.armeria.internal.spring.ArmeriaConfigurationUtilKeyStore storeloadKeyStore(...)getKeyStoreType(...)getKeyStore(...)getKeyStorePassword(...)KeyManagerFactory keyManagerFactorygetDefaultAlgorithm(...)String keyPasswordtoCharArray(...)getTrustStoreType(...)getTrustStore(...)getTrustStorePassword(...)TrustManagerFactory trustManagerFactoryURL urlgetURL(...)openStream(...)import CurrentSpanCustomizerimport SpanCustomizerimport ClientFactoryBuilderimport BraveClientimport RequestLogimport RequestLogPropertyimport NamedThreadFactoryimport ScheduledExecutorServiceimport ScheduledFutureimport Qualifierimport ElasticsearchStorageimport static ZipkinElasticsearchStorageProperties.SslDynamicRefreshRequired.classBasicAuthRequired.classZipkinElasticsearchStorageProperties.classString QUALIFIER, ...;String USERNAME, ...;String PASSWORD, ...;String CREDENTIALS_FILE, ...;String CREDENTIALS_REFRESH_INTERVAL, ...;// Exposed as a bean so that zipkin-aws can override this as sourced from the AWS endpoints apinew InitialEndpointSupplier(...)getHosts(...)// Exposed as a bean so that zipkin-aws can override this to always be SSLSessionProtocol.HTTPSessionProtocol.HTTPS// TODO: see if we can override the TLS via properties instead as that has less surface area.// exposed as a bean so that we can test TLS by swapping it out.ClientFactoryBuilder builderSsl sslgetSsl(...)isNoVerify(...)tlsNoVerify(...)configureSsl(...)meterRegistry(...)connectTimeoutMillis(...)useHttp2Preface(...)new HttpClientFactory(...)ElasticsearchStorage.BuildernamesLookback(...)new LazyHttpClientImpl(...)new Consumer<ClientOptionsBuilder>(...) { ... }new Function<HttpClient,HttpClient>(...) { ... }new BasicAuthInterceptor(...)getUsername(...)getPassword(...)new BasicCredentials(...)ScheduledExecutorService sesnewSingleThreadScheduledExecutor(...)new NamedThreadFactory(...)DynamicCredentialsFileLoader credentialsFileLoadernew DynamicCredentialsFileLoader(...)ScheduledFuture<?> futurescheduleAtFixedRate(...)isDone(...)HttpTracing httpTracingclientOf(...)SpanCustomizer spanCustomizertracing(...)isPresent(...)RequestLog logpartial(...)isAvailable(...)RequestLogProperty.NAMEString nameString userNameString credentialsFilegetKeyManagerFactory(...)getTrustManagerFactory(...)tlsCustomizer(...)new Consumer<SslContextBuilder>(...) { ... }keyManager(...)trustManager(...)// Allow use of a custom KeyStore or TrustStore when connecting to Elasticsearch// Elasticsearch 7 never returns a response when receiving an HTTP/2 preface instead of the more// valid behavior of returning a bad request response, so we can't use the preface.// TODO: find or raise a bug with Elastic// TODO: is there a special cased empty consumer we can use here? I suspect debug is cluttered// Alternatively, check why we would ever get here if ConditionalOnSelfTracing matches// We only need the name if it's available and can unsafely access the partially filled log.// override the span name if set// the tracing decorator is added last so that it encloses the attempt to overwrite the name./** Settings for Elasticsearch client connection ... */new Ssl(...)new HealthCheck(...)/** Sets the level of logging for HTTP requests made by the Elasticsearch client. If not set or ... */new HttpLogging(...)HttpLogging NONE, ...;HttpLogging BASIC, ...;HttpLogging HEADERS, ...;HttpLogging BODY, ...;String keyStore, ...;String keyStorePassword, ...;String keyStoreType, ...;String trustStore, ...;String trustStorePassword, ...;String trustStoreType, ...;boolean noVerify, ...;/** Disables the verification of server's key certificate chain. */this.keyStorethis.keyStorePasswordthis.keyStoreTypethis.trustStorethis.trustStorePasswordthis.trustStoreTypethis.noVerify/** Configures the health-checking of endpoints by the Elasticsearch client. *//** Indicates health checking is enabled. */HttpLogging httpLogging, ...;/** When set, controls the volume of HTTP logging of the Elasticsearch API. */Duration interval, ...;/** The time to wait between sending health check requests. */this.httpLoggingthis.intervalString pipeline, ...;/** Indicates the ingest pipeline used before spans are indexed. *//** A comma separated list of base urls to connect to. */String index, ...;/** The index prefix to use when generating daily index names. */String dateSeparator, ...;/** The date separator used to create the index name. */Integer indexShards, ...;/** Number of shards (horizontal scaling factor) per index. */Integer indexReplicas, ...;/** Number of replicas (redundancy factor) per index. */Boolean ensureTemplates, ...;/** False disables automatic index template creation. *//** username used for basic auth. Needed when Shield or X-Pack security is enabled *//** password used for basic auth. Needed when Shield or X-Pack security is enabled *//** credentialsFile is an absolute path refers to a properties-file used to store username and ... */Integer credentialsRefreshInterval, ...;/** Credentials refresh interval (in seconds) */Integer timeout, ...;/** Connect, read and write socket timeouts (in milliseconds) for Elasticsearch API requests. */Ssl ssl, ...;/** Overrides ssl configuration relating to the Elasticsearch client connection. */Integer maxRequests, ...;HealthCheck healthCheck, ...;// unusedInteger templatePriority, ...;this.pipelinethis.maxRequeststhis.indexthis.indexShardsthis.ensureTemplatesString trimmedthis.dateSeparatorthis.indexReplicasthis.credentialsRefreshIntervalthis.sslthis.templatePrioritydateSeparator(...)indexShards(...)indexReplicas(...)ensureTemplates(...)warning(...)templatePriority(...)String STATUS_UP, ...;new ComponentHealth(...)String status, ...;String error, ...;this.statusimport StringWriterimport JsonUtilimport static ZipkinHttpConfiguration.MEDIA_TYPE_ACTUATORimport static ComponentHealth.STATUS_DOWNimport static ComponentHealth.STATUS_UPList<Component> components, ...;this.componentshealth(...)CompletableFuture<HttpResponse> responseFuturenew CompletableFuture<HttpResponse>(...)List<CompletableFuture<ComponentHealth>> futuresnew Function<Component,CompletableFuture<ComponentHealth>>(...) { ... }supplyAsync(...)new Supplier<ComponentHealth>(...) { ... }ofComponent(...)whenRequestTimingOut(...)new BiFunction<Void,Throwable,Object>(...) { ... }String healthJsonwriteJsonError(...)newHealthResponse(...)new CompletableFuture<>[]new Function<CompletableFuture<ComponentHealth>,ComponentHealth>(...) { ... }join(...)String overallStatusComponentHealth healthhealth.statuswriteJson(...)new Error(...)HttpStatus codeHttpStatus.OKHttpStatus.SERVICE_UNAVAILABLEStringWriter writernew StringWriter(...)writeStartObject(...)writeStringField(...)writeObjectFieldStart(...)writeEndObject(...)health.namehealth.error// Shouldn't happen since we serialize to an array.// Computing health of a component may block so we make sure to invoke in the blocking// executor.// Can't have an exception writing to a string.// .zipkin.details// .zipkin// .// .zipkin.details.healthName.details// .zipkin.details.healthNameimport KafkaCollector/** This collector consumes a topic, decodes spans from thrift messages and stores them subject to ... */ZipkinKafkaCollectorProperties.classZipkinKafkaCollectorConfiguration.KafkaBootstrapServersSet.classZipkinKafkaCollectorConfiguration.KafkaBootstrapServersSet// makes simple type name unique for /actuator/conditions/** This condition passes when {@link ZipkinKafkaCollectorProperties#getBootstrapServers()} is set ... */String bootstrapServers, ...;/** Comma-separated list of Kafka bootstrap servers in the form [host]:[port],... */String groupId, ...;/** Kafka consumer group id used by the collector. *//** Kafka topic span data will be retrieved from. */Integer streams, ...;/** Number of Kafka consumer threads to run. */Map<String,String> overrides, ...;/** Additional Kafka consumer configuration. */this.bootstrapServersthis.groupIdthis.overridesoverrides(...)import DataSourceimport ExecuteListenerProviderimport Autowiredimport ThreadPoolTaskExecutorimport MySQLStorageMySQLStorage.classZipkinMySQLStorageProperties.classZipkinSelfTracingMySQLStorageConfiguration.classZipkinMySQLStorageProperties mysql, ...;ExecuteListenerProvider mysqlListener, ...;ThreadPoolTaskExecutor executornew ThreadPoolTaskExecutor(...)setThreadNamePrefix(...)initialize(...)toDataSource(...)listenerProvider(...)datasource(...)import HikariDataSourceimport StringUtilsString jdbcUrl, ...;String host, ...;String db, ...;int maxActive, ...;this.jdbcUrlthis.hostthis.dbthis.maxActiveHikariDataSource resultnew HikariDataSource(...)setDriverClassName(...)setJdbcUrl(...)determineJdbcUrl(...)setMaximumPoolSize(...)getMaxActive(...)setUsername(...)setPassword(...)StringBuilder urlhasText(...)getJdbcUrl(...)getDb(...)isUseSsl(...)import RequestContextimport ExecuteContextimport DefaultExecuteListenerimport DefaultExecuteListenerProvider/** Sets up the MySQL tracing in Brave as an initialization. */CurrentTraceContext currentTraceContext, ...;ThreadLocalSpan threadLocalSpan, ...;new DefaultExecuteListenerProvider(...)mysqlExecutor(...)new ZipkinMySQLStorageConfiguration(...)/** Decorates the input such that the {@link RequestContext#current() current request context} and ... */current(...)new TracingCurrentRequestContextExecutor(...)String sqlsql(...)int spaceIndexremoteIpAndPort(...)ThreadLocalSpan.CURRENT_TRACERsqlException(...)// don't start new traces (to prevent amplifying writes to local storage)// Gets the next span (and places it in scope) so code between here and postProcess can read it// Allow span names of single-word statements like COMMITimport MeterCollectorRegistry collectorRegistry, ...;this.collectorRegistry// Extracts Zipkin metrics to provide backward compatibilityMeter metergetMeters(...)getId(...)String transportgetTag(...)Meter.TypeType typegetType(...)Meter.Type.COUNTERwriteNumberField(...)Meter.Type.GAUGE// Get the Zipkin Custom meters for constructing the Metrics endpoint// We only use counters and gauges// instead of using try/finally as extra indent causes lines to wrapimport Routeimport SimpleDecoratingHttpServiceimport Clockimport Tagimport Timerimport ClassLoaderMetricsimport JvmGcMetricsimport JvmMemoryMetricsimport JvmThreadMetricsimport ProcessorMetricsimport PrometheusConfigimport PrometheusMeterRegistryimport AttributeKeyBoolean.classTag URI_NOT_FOUND, ...;// from io.micrometer.spring.web.servlet.WebMvcTagsTag URI_REDIRECTION, ...;Tag URI_TRACE_V2, ...;Tag URI_CROSSROADS, ...;// single-page app requests are forwarded to index: ZipkinUiConfiguration.forwardUiEndpointsString metricName, ...;// https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#production-ready-metrics-spring-mvcthis.metricNameClock.SYSTEMPrometheusConfig.DEFAULTnew CollectorRegistry(...)PrometheusMeterRegistry meterRegistrynew PrometheusMeterRegistry(...)new JvmMemoryMetrics(...)new JvmGcMetrics(...)new JvmThreadMetrics(...)new ClassLoaderMetrics(...)new ProcessorMetrics(...)pathPrefix(...)new MetricCollectingService(...)// service is handled by this.// adding metrics. We add a lower precedence path mapping so anything not mapped by another// We need to make sure not-found requests are still handled by a service to be decorated forglob(...)HttpStatus.NOT_FOUNDMeterRegistry registry, ...;this.registrysetup(...)AttributeKey<Boolean> PROMETHEUS_METRICS_SET, ...;// A variable to make sure setup method is not called twice.hasAttr(...)setAttr(...)thenAccept(...)whenComplete(...)new Consumer<RequestLog>(...) { ... }record(...)totalDurationNanos(...)getTimeBuilder(...)Timer.BuilderpublishPercentileHistogram(...)getTags(...)uri(...)requestHeaders(...)status(...)responseHeaders(...)/** Ensure metrics cardinality doesn't blow up on variables */int statusString urigetPathInfo(...)replaceFirst(...)context(...)// Use glob instead of catch-all to avoid adding it to the trie router.// no known action to take following .thenAccept// single-page app route// un-map UI's api route// handle templated routes instead of exploding on trace ID cardinalityimport URISyntaxExceptionimport KeyManagementExceptionimport NoSuchAlgorithmExceptionimport RabbitMQCollector/** Auto-configuration for {@link RabbitMQCollector}. */ZipkinRabbitMQCollectorProperties.classZipkinRabbitMQCollectorConfiguration.RabbitMQAddressesOrUriSet.classZipkinRabbitMQCollectorConfiguration.RabbitMQAddressesOrUriSet/** This condition passes when {@link ZipkinRabbitMQCollectorProperties#getAddresses()} or {@link ... *//** Properties for configuring and building a {@link RabbitMQCollector}. */URI EMPTY_URI, ...;List<String> addresses, ...;/** RabbitMQ server addresses in the form of a (comma-separated) list of host:port pairs *//** Number of concurrent consumers */Integer connectionTimeout, ...;/** TCP connection timeout in milliseconds *//** RabbitMQ user password *//** RabbitMQ queue from which to collect the Zipkin spans *//** RabbitMQ username */String virtualHost, ...;/** RabbitMQ virtual host */Boolean useSsl, ...;/** Flag to use SSL */URI uri, ...;/** RabbitMQ URI spec-compliant URI to connect to the RabbitMQ server. When used, other connection ... */this.connectionTimeoutthis.virtualHostthis.urisetUri(...)setVirtualHost(...)useSslProtocol(...)import ScribeCollector/** The init method will block until the scribe port is listening, or crash on port conflict *//** Follows the same naming convention as {@link CollectorMetrics} */Counter requests, ...;import AbstractLimiterimport ThreadPoolExecutorimport MicrometerCollectorMetrics/** Follows the same naming convention as {@link MicrometerCollectorMetrics} */new Supplier<Number>(...) { ... }getCorePoolSize(...)getQueue(...)getInflight(...)// This value should parallel (zipkin_storage.throttle.queue_size + zipkin_storage.throttle.concurrency)// It is tracked to make sure it doesn't perpetually increase.  If it does then we're not resolving LimitListeners.import Limiterimport Listenerimport InterruptedIOExceptionimport Predicateimport static Exceptions.clearTrace/** {@link Call} implementation that is backed by an {@link ExecutorService}. The ExecutorService ... */clearTrace(...)RejectedExecutionException STORAGE_THROTTLE_MAX_CONCURRENCY, ...;/** <p>This reduces allocations when concurrency reached by always returning the same instance. ... */Call<Void> delegate, ...;Executor executor, ...;Limiter<Void> limiter, ...;LimiterMetrics limiterMetrics, ...;Predicate<Throwable> isOverCapacity, ...;Throwable throwable, ...;// thread visibility guaranteed by the countdown latchthis.executorthis.limiterthis.limiterMetricsthis.isOverCapacity/** To simplify code, this doesn't actually invoke the underlying {@link #execute()} method. This ... */this.throwablenew InterruptedIOException(...)// When handling enqueue, we don't block the calling thread. Any exception goes to the callback.Listener limiterListenerorElseThrow(...)acquire(...)new Supplier<RejectedExecutionException>(...) { ... }EnqueueAndAwait enqueueAndAwaitnew EnqueueAndAwait(...)limiterMetrics.requestsonIgnore(...)new ThrottledCall(...)/** When run, this enqueues a call with a given callback, and awaits its completion. */Listener limiterListener, ...;this.limiterListener/** This waits until completion to ensure the number of executing calls doesn't surpass the ... */limiterMetrics.requestsSucceededlimiterMetrics.requestsDroppedonDropped(...)limiterMetrics.requestsIgnored/** Returns true if uninterrupted waiting for the latch */interrupt(...)// Enqueue the call invocation on the executor and block until it completes.// Check if the run resulted in an exception// success// Coerce the throwable to the signature of Call.execute()// possibly rejected, but from the executor, not storage!// Ignoring in all cases here because storage itself isn't saying we need to throttle. Though// we may still be write bound, but a drop in concurrency won't necessarily help.// allows blocking calls to see the exception// Need to wait here since the callback call will run asynchronously also.// This ensures we don't exceed our throttle/queue limits.// edge case: error during enqueue!// usually we don't add metrics like this,// but for now it is helpful to sanity check acquired vs erred.// NOTE: limiter could block and delay the caller's callback// catch the throwable in case the invocation is blocking (Call.execute())// NOTE: the above limiter could block and delay the caller's callbackimport Limitimport Gradient2Limitimport TracedCall/** Delegating implementation that limits requests to the {@link #spanConsumer()} of another {@link ... */RejectedExecutionException STORAGE_THROTTLE_MAX_QUEUE_SIZE, ...;/** See {@link ThrottledCall#STORAGE_THROTTLE_MAX_CONCURRENCY} if unfamiliar with clearing trace on ... */AbstractLimiter<Void> limiter, ...;ThreadPoolExecutor executor, ...;Limit limitqueueSize(...)maxConcurrency(...)initialLimit(...)minLimit(...)MicrometerThrottleMetrics metricsnew MicrometerThrottleMetrics(...)requireNonNull(...)this.currentTraceContextnew ThreadPoolExecutor(...)getLimit(...)new NamedThreadFactory(...) { ... }newThread(...)supernew RejectedExecutionHandler(...) { ... }notifyOnChange(...)new ThreadPoolExecutorResizer(...)new LimiterMetrics(...)new ThrottledSpanConsumer(...)throttledStorage.delegatethrottledStorage.executorthrottledStorage.currentTraceContextthrottledStorage.limiterthrottledStorage.limiterMetricsnew Predicate<Throwable>(...) { ... }throttledStorage.tracerCall<Void> resultnew LinkedBlockingQueue<Runnable>(...)/** This is {@code synchronized} to ensure that we don't let the core/max pool sizes get out of ... */int previousValueint newValueIntsetCorePoolSize(...)AbstractLimiter<>.Builder<Builder>new NonLimitingLimiter(...)/** Unlike a normal Limiter, this will actually not prevent the creation of a {@link Listener} in ... */AbstractLimiter<>.Builder<?>createListener(...)// Limiter will trend towards min until otherwise necessary so may as well start there// The size of the thread pool is managed by the limiter, so we initialize it with the lower// bound (current limit), and later use change notification to resize it.// 0 means we should be bounded but we can't create a queue with that size so use 1 instead.// Note: no case for equals.  Why modify something that doesn't need modified?/** Should we throttle at all? */int minConcurrency, ...;/** Minimum number of storage requests to allow through at a given time. */int maxConcurrency, ...;/** Maximum number of storage requests to allow through at a given time. Should be tuned to ... */int maxQueueSize, ...;/** Maximum number of storage requests to buffer while waiting for open Thread. 0 = no buffering. */this.minConcurrencythis.maxConcurrencythis.maxQueueSizeimport Compressionthis.compressionCompression compression, ...;import ServerCacheControlimport RedirectServiceimport FileServiceimport MeterFilterimport BeanCreationExceptionimport Resourceimport static ZipkinUiProperties.DEFAULT_BASEPATH/** Zipkin-UI is a single-page application mounted at /zipkin. For simplicity, assume paths mentioned ... */ZipkinUiProperties.classCompressionProperties.classZipkinUiProperties ui, ...;Resource lensIndexHtml, ...;HttpService lensIndexmaybeIndexService(...)getBasepath(...)new BeanCreationException(...)ServerCacheControl maxAgeYearmaxAgeSeconds(...)toSeconds(...)HttpService uiFileServicecacheControl(...)String configwriteConfig(...)ofUtf8(...)serviceUnder(...)new RedirectService(...)HttpStatus.FOUNDnew Consumer<MeterRegistry>(...) { ... }meterFilter(...)config(...)deny(...)new Predicate<Id>(...) { ... }//   highErrorRate: 0.75 // 75% of calls in error turns line red//   lowErrorRate: 0.5, // 50% of calls in error turns line yellow//   enabled: true,// dependency: {// searchEnabled: true,// defaultLookback: 15 * 60 * 1000, // 15 minutes// queryLimit: 10,// environment: '',useDefaultPrettyPrinter(...)getQueryLimit(...)getDefaultLookback(...)writeBooleanField(...)isSearchEnabled(...)getLogsUrl(...)getSupportUrl(...)getArchivePostUrl(...)getArchiveUrl(...)getDependency(...)getLowErrorRate(...)getHighErrorRate(...)String maybeContentmaybeResource(...)ServerCacheControl maxAgeMinuteMediaType.HTML_UTF_8String contentString baseTagValue// TODO This approach requires maintenance when new UI routes are added. Change to the following:// If the path is a a file w/an extension, treat normally.// Otherwise instead of returning 404, forward to the index.// See https://github.com/twitter/finatra/blob/458c6b639c3afb4e29873d123125eeeb2b02e2cd/http/src/main/scala/com/twitter/finatra/http/response/ResponseBuilder.scala#L321// don't add metrics for favicon// .dependency// html-webpack-plugin seems to strip out quotes from the base tag when compiling so be// careful with this matcher.new Dependency(...)String DEFAULT_BASEPATH, ...;// TODO: this isn't honored in lens https://github.com/openzipkin/zipkin/issues/2519String environment, ...;int queryLimit, ...;int defaultLookback, ...;String instrumented, ...;String logsUrl, ...;String supportUrl, ...;String archivePostUrl, ...;String archiveUrl, ...;String basepath, ...;boolean searchEnabled, ...;Dependency dependency, ...;this.environmentthis.queryLimitthis.instrumentedthis.logsUrlthis.supportUrlthis.archivePostUrlthis.archiveUrlthis.dependencythis.basepathfloat lowErrorRate, ...;float highErrorRate, ...;// 50% of calls in error turns line yellow// 75% of calls in error turns line redthis.lowErrorRatethis.highErrorRateimport Serverimport RunWithimport SpringBootApplicationimport SpringBootTestimport SpringRunnerimport static ITZipkinServer.urlSpringRunner.classCustomServer.classSpringBootTest.WebEnvironment.NONESpringBootTest.WebEnvironmentfollowRedirects(...)OkHttpClient.BuilderServer server, ...;// RANDOM_PORT requires spring-webimport Assertionsimport Parameterizedimport Parameterimport Parametersimport TestPropertyValuesimport AnnotationConfigApplicationContextimport AccessParameterized.classnew AnnotationConfigApplicationContext(...)AnnotationConfigApplicationContext context, ...;String property, ...;Object value, ...;Function<Builder,Object> builderExtractor, ...;parameters(...)new Function<Builder,String>(...) { ... }b.connectionFactorygetClientIDPrefix(...)b.queuenew Function<Builder,Integer>(...) { ... }b.concurrencygetUserName(...)/** to allow us to define with a lambda */new Object[]endsWith(...)applyTo(...)registerActiveMQProperties(...)refresh(...)collectorBuilder(...)b.propertiesb.topicb.streamsregisterKafkaProperties(...)getConnectionTimeout(...)getVirtualHost(...)new Function<Builder,Boolean>(...) { ... }isSSL(...)new Function<Builder,URI>(...) { ... }registerRabbitMQProperties(...)// intentionally punting on comma-separated form of a list of addresses as it doesn't fit// this unit test. Better to make a separate one than force-fit!import NoSuchBeanDefinitionExceptionimport PropertyPlaceholderAutoConfigurationimport InMemoryConfigurationNoSuchBeanDefinitionException.classrefreshContext(...)/** Note: this will flake if you happen to be running a server on port 9410! */isNotNull(...)getBean(...).server.portgetBean(...).serverPropertyPlaceholderAutoConfiguration.classInMemoryConfiguration.classimport ZipkinServerimport static Assumptions.assumeThatPrometheusMeterRegistry registry, ...;assumeThat(...)isSuccessful(...)doesNotContain(...)scrape(...)Response infoResponse actuatorInfoisNotEqualTo(...)Response healthResponse actuatorHealth// actuator is optional// ensure we don't track actuator in prometheus// Different content type// Same content// ensure we don't track info in prometheus// ensure we don't track health in prometheusimport BufferedSourceimport ListOfSpansimport ReportResponseimport static Protocol.H2_PRIOR_KNOWLEDGE/** This tests that we accept messages constructed by other clients. */protocols(...)ListOfSpans request, ...;ListOfSpans.ADAPTERcallReport(...)awaitSpans(...)ListOfSpans.BuilderBuffer requestBodyBuffer encodedMessagesnapshot(...)BufferedSource responseBodysource(...)long encodedLengthwriteAll(...)ReportResponse.ADAPTERisGreaterThanOrEqualTo(...)acceptedSpanCount(...)// sanity check codec compatible// Result is effectively void/* compressedFlag */// uncompressed// wait for spansimport Okioimport static TestObjects.FRONTENDimport static TestObjects.TODAYTestObjects.CLIENT_SPANList<Span> TRACE, ...;header(...)List<String> services/** Simulate a proxy which forwards / to zipkin as opposed to resolving / -> /zipkin first */Request forwardedisEqualToIgnoringWhitespace(...)stringFromClasspath(...)new Consumer<String>(...) { ... }activeLocalPort(...)getResource(...)InputStream fromClasspath// Check that the response is alphabetically sorted.// Redirect header should be the proxy, not the backed IP/port// trace method is disallowed for any route but we just test couple of paths here, can't test them all/** Integration test suite for autocomplete tags. ... *//** Integration test suite for CORS configuration. ... */ITZipkinServerCORS.ALLOWED_ORIGINString ALLOWED_ORIGIN, ...;String DISALLOWED_ORIGIN, ...;/** Notably, javascript makes pre-flight requests, and won't POST spans if disallowed! */shouldPermitPreflight(...)optionsForOrigin(...)withFailMessage(...)request(...)shouldAllowConfiguredOrigin(...)getTracesFromOrigin(...)postSpansFromOrigin(...)shouldDisallowOrigin(...)/** Query-only builds should be able to disable the HTTP collector, so that associated assets 404 ... *//** Shows the same http path still works for GET */// cheat and test empty storage type/** Collector-only builds should be able to disable the query (and indirectly the UI), so that ... */// but other endpoints are okimport ArmeriaSettingsimport static Access.configureSsl/** This code ensures you can setup SSL. Look at {@link ArmeriaSettings} for property names. ... */ArmeriaSettings armeriaSettings, ...;callHealthEndpoint(...)AggregatedHttpResponse responseaggregate(...)baseUrl(...)findAny(...)activePorts(...)new Predicate<ServerPort>(...) { ... }hasProtocol(...)new Function<ServerPort,String>(...) { ... }new Supplier<AssertionError>(...) { ... }// TODO: use normal spring.server properties after https://github.com/line/armeria/issues/1834// redundant in zipkin-server-shared https://github.com/spring-projects/spring-boot/issues/16394import MockBeanSlowSpanStore spanStore, ...;new SlowSpanStore(...)spanStore.storageimport NoopMeterRegistryimport static ZipkinActuatorImporter.PROPERTY_NAME_ACTUATOR_ENABLED// This tests actuator integration without actually requiring a compile dep on actuatorActuatorImpl.classnew GenericApplicationContext(...)ZipkinActuatorImporter zipkinActuatorImporter, ...;GenericApplicationContext context, ...;Include1.classInclude2.classimport ApplicationConversionServiceimport ConversionServiceregisterBaseConfig(...)StorageComponent v2StoragegetSharedInstance(...)Config.classZipkinModuleImporter zipkinModuleImporter, ...;Module1.classModule2.class/** opens package access for testing *//** Just registering properties to avoid automatically connecting to a ActiveMQ server */EnableActiveMQCollectorProperties.classBeanCreationException.classBeanCreationException e/** This prevents an empty ACTIVEMQ_URL variable from being mistaken as a real one */ZipkinActiveMQCollectorProperties propertiesnew ZipkinActiveMQCollectorProperties(...)setUrl(...)getUrl(...)hasMessageContaining(...)// wrong portimport ByteArrayOutputStreamsetEnabled(...)AnsiOutput.Enabled.DETECTAnsiOutput.EnabledZipkinBanner bannerByteArrayOutputStream outnew ByteArrayOutputStream(...)AnsiOutput.Enabled.ALWAYSprintBanner(...)new PrintStream(...)toByteArray(...)AnsiOutput.Enabled.NEVER// ansi codesimport Ignoreimport static Collections.singletonMapimport static TestObjects.DAY/** This class is flaky for as yet unknown reasons. For example, in CI, sometimes assertions fail ... */TracingStorageComponent storage, ...;AsyncZipkinSpanHandler zipkinSpanHandler, ...;inMemoryStorage(...)storage.delegategetServices(...)assertQueryReturnsResults(...)singletonMap(...)postSpan(...)long receivedflatMap(...)new Function<List<Span>,Stream<? extends Span>>(...) { ... }QueryRequest.BuilderQueryRequest queryisNotEmpty(...)/** This POSTs a single span. Afterwards, we expect this trace in storage, and also the self-trace ... */SpanBytesEncoder encoderList<Span> testTraceassertSuccessful(...)peekBody(...)// test span + POST + accept-spansimport NoOpMeterRegistryConfigurationNoOpMeterRegistryConfiguration.classZipkinElasticsearchStorageProperties.SslSsl eSslsetKeyStore(...)setKeyStorePassword(...)setKeyStoreType(...)setTrustStore(...)setTrustStorePassword(...)setTrustStoreType(...)import ServerBuilderimport MockWebServerExtensionimport static TestResponses.VERSION_RESPONSEimport static TestResponses.YELLOW_RESPONSEnew MockWebServerExtension(...) { ... }https(...)tls(...)MockWebServerExtension server, ...;ElasticsearchStorage storage, ...;httpsPort(...)registerElasticsearch(...)ElasticsearchStorage.classAggregatedHttpRequest nexttakeRequest(...)toHttpResponse(...)// hard coded for sanity taken from https://en.wikipedia.org/wiki/Basic_access_authentication/** This blocks for less than the timeout of 2 second to prove we defer i/o until first use of the ... *//** blocking a little is ok, but blocking forever is not. */ElasticsearchStorage storageimport FilepathOfResource(...)File filenew File(...)getFile(...)ITElasticsearchDynamicCredentials.classgetAbsolutePath(...)import EmptyEndpointGroupExceptionimport HealthCheckServiceimport SettableHealthCheckerimport ServerRuleimport SSLExceptionimport ConditionFactoryimport static TestResponses.GREEN_RESPONSE/** These tests focus on http client health checks not currently in zipkin-storage-elasticsearch. */ITElasticsearchHealthCheck.classtimeout(...)new SettableHealthChecker(...)setProperty(...)new ServerRule(...) { ... }ConditionFactory awaitTimeout, ...;// Health check interval is 100ms, but in-flight requests in CI might take a few hundred msSettableHealthChecker server1Health, ...;ServerRule server1, ...;SettableHealthChecker server2Health, ...;ServerRule server2, ...;setHealthy(...)httpUri(...)initWithHosts(...)httpPort(...)assertOk(...)SSLException.classEmptyEndpointGroupException.class// If this flakes, uncomment in initWithHosts and log4j2.propertiesAnnotationConfigApplicationContext context// Gives better context when there's an exception such as AbortedStreamException// uncomment (and also change log4j2.properties) to see health-checks requests in the console//"zipkin.storage.elasticsearch.health-check.http-logging=headers",// Test this is not wrapped in a rejection exception, as health check is not throttled// Depending on JDK this is SSLHandshakeException or NotSslRecordException// Even though cluster health is false, we ignore that and continue to check index health,// which is correctly returned by our mock server.new MockWebServerExtension(...)/** We currently don't have a nice way to mute outbound propagation in Brave. This just makes sure ... */new ThrowingExtractor<Entry<AsciiString,String>,String,RuntimeException>(...) { ... }import static SessionProtocol.HTTPimport static SessionProtocol.HTTPS/** This helps ensure old setups don't break (provided they have http port 9200 open) */String hostListendpoints(...)InitialEndpointSupplier supplierimport static HttpStatus.OKimport static MediaType.JSONAggregatedHttpResponse VERSION_RESPONSE, ...;AggregatedHttpResponse YELLOW_RESPONSE, ...;AggregatedHttpResponse GREEN_RESPONSE, ...;import UnsatisfiedDependencyExceptionimport static ITElasticsearchDynamicCredentials.pathOfResourcees(...)SessionProtocol.classmaxResponseLength(...)Consumer<ClientOptionsBuilder> one, ...;Consumer<ClientOptionsBuilder> two, ...;/** Ensures we can wire up network interceptors, such as for logging or authentication */HttpClientFactory factoryHttpClientFactory.classCustomizerConfiguration.classfactory.optionslong timeoutformatTypeAndTimestamp(...)indexNameFormatter(...)WebClient clientoption(...)ClientOptions.DECORATIONdecoration(...)as(...)BasicAuthInterceptor.classBasicCredentials basicCredentialsrequireNonNull(...).basicCredentialsUnsatisfiedDependencyException.class// TODO(anuraaga): Verify connect timeout after https://github.com/line/armeria/issues/1890import ClosedSessionExceptionnew Component(...) { ... }import JsonPathString jsongetAsString(...)isIn(...)compile(...)Response checkList<ComponentHealth> healths/** Just registering properties to avoid automatically connecting to a Kafka server */EnableKafkaCollectorProperties.classZipkinKafkaCollectorProperties propertiesnew ZipkinKafkaCollectorProperties(...)setBootstrapServers(...)setGroupId(...)setTopic(...)getBootstrapServers(...)getGroupId(...)getTopic(...)import JsonParserimport JsonToken/** Only add tests that do not consider the value of a counter or gauge, as these will flake and so ... */byte[] spanString metricscontainsOnlyKeys(...)readJson(...)Map<String,Integer> resultnew LinkedHashMap<String,Integer>(...)JsonParser parsercreateParser(...)String nextFieldJsonToken.START_OBJECTnextToken(...)nextFieldName(...)nextIntValue(...)// ensure we don't track metrics in prometheus// ensure we don't track prometheus, UI requests in prometheus// sanity check// gc metrics are not tested as are not present during test runningimport DirtiesContextimport static ClassMode.BEFORE_EACH_TEST_METHOD/** Tests here look at values based on counter values, so need to run independently. It would seem ... */double messagesCountcounter(...)double bytesCountdouble spansCountreadDouble(...)double messagesDroppedCount/** This tests logic in {@code BodyIsExceptionMessage} is scoped to POST requests. *//** Makes sure the prometheus filter doesn't count twice */long httpCounttimer(...)find(...)// Clearing the prometheus registry also clears the metrics themselves, not just the values, so we// have to use dirties context so that each test runs in a separate instance of Spring Boot.// We use DirtiesContext, not registry.clear(), as the latter would cause an empty scrape// sometimes CI flakes getting the "http.server.requests" timer// Get the http count from the registry and it should match the summation previous count// and count of calls below// ensure unscoped counter does not existgetBeansOfType(...)ArmeriaServerConfigurator.classgetBean(...).metricName/** Just registering properties to avoid automatically connecting to a Rabbit MQ server */EnableRabbitMQCollectorProperties.classnew ZipkinRabbitMQCollectorProperties(...)ZipkinRabbitMQCollectorProperties properties, ...;setAddresses(...)satisfies(...)new Consumer<?>(...) { ... }ConnectionFactory connFactory/** This prevents an empty RABBIT_URI variable from being mistaken as a real one */getUri(...)boolean overCapacity, ...;this.overCapacityimport SettableLimitimport SimpleLimiterimport Semaphoreimport AwaitableCallbackimport static Mockito.doThrowimport static ThrottledCall.NOOP_CALLBACKimport static ThrottledCall.STORAGE_THROTTLE_MAX_CONCURRENCYimport static ThrottledStorageComponent.STORAGE_THROTTLE_MAX_QUEUE_SIZEstartingAt(...)isInstance(...)RejectedExecutionException.classSettableLimit limit, ...;SimpleLimiter<> limiter, ...;int numThreads, ...;ExecutorService executor, ...;Call<Void> delegateCall<>.classint queueSizeint totalTasksSemaphore startLocknew Semaphore(...)Semaphore waitLockSemaphore failLockThrottledCall throttledthrottle(...)new LockedCall(...)ExecutorService backgroundPoolnewCachedThreadPool(...)setLimit(...)drainPermits(...)new Callable<Void>(...) { ... }Future<?> futureExecutionException.classExecutionException thasCauseInstanceOf(...)Listener listenerListener.classFakeCall callnew FakeCall(...)ThrottledCall throttlemockLimiter(...)call.overCapacityRejectedExecutionException emockExhaustedPool(...)AwaitableCallback callbacknew AwaitableCallback(...)Semaphore startLock, ...;this.startLockthis.waitLockExecutorService mockExecutorService.classdoThrow(...)Callable<>.classLimiter<Void> mockLimiter<>.classException OVER_CAPACITY, ...;// Step 1: drain appropriate locks// Step 2: saturate threads and fill queue// Step 3: make sure the threads actually started// Step 4: submit something beyond our limits// Step 6: signal that we tripped the limit// Step 5: wait to make sure our limit actually tripped// Step 7: Expect great things// from future.get// should raise a RejectedExecutionException// Step 4: submit something beyond our limits and make sure it failsimport ThrottledSpanConsumerExpectedException expectedException, ...;InMemoryStorage delegate, ...;NoopMeterRegistry registry, ...;ThrottledStorageComponent throttleisSameAs(...)ThrottledSpanConsumer.classStorageComponent mock// no exception == passimport static ITZipkinServer.stringFromClasspath/** The zipkin-lens is a single-page app. This prevents reloading all resources on each click. */String index/** Browsers honor conditional requests such as eTag. Let's make sure the server does */String etagconditionalGet(...)/** Some assets are pretty big. ensure they use compression. */getContentEncodingFromRequestThatAcceptsGzip(...)/** The test sets the property {@code zipkin.ui.base-path=/foozipkin}, which should reflect in ... *//** index.html is served separately. This tests other content is also loaded from the classpath. */HttpHeaderNames.ACCEPT_ENCODING// too small to compress// We typically use OkHttp in our tests, but that automatically unzips..import ClientCookieEncoderimport Cookieimport DefaultCookieimport ByteArrayInputStreamcreateContext(...)serveIndex(...)ZipkinUiConfiguration uinew ZipkinUiConfiguration(...)ui.uinew ZipkinUiProperties(...)ui.lensIndexHtmlindexService(...)createContextWithOverridenProperty(...)String urlhasSameContentAs(...)getResourceAsStream(...)new ByteArrayInputStream(...)contentUtf8(...)new DefaultCookie(...)RequestHeaders headersString encodedCookiesClientCookieEncoder.LAXHttpRequest reqHttpHeaderNames.COOKIEHttpService.class// Instantiate directly so that spring doesn't cache itregisterCassandra3(...)getBean(...).contactPointsgetBean(...).strictTraceIdgetBean(...).searchEnabledgetBean(...).autocompleteKeysgetBean(...).autocompleteTtlgetBean(...).autocompleteCardinality// note snake-case supportedregisterMySQL(...)HikariDataSource.classimport FieldEncodingimport ProtoAdapterimport ProtoReaderimport ProtoWriterimport WireFieldimport Internalimport Longimport Objectimport Overrideimport Stringimport StringBuilderAnnotation.Buildernew ProtoAdapter_Annotation(...)ProtoAdapter<Annotation> ADAPTER, ...;Long DEFAULT_TIMESTAMP, ...;String DEFAULT_VALUE, ...;Long timestamp, ...;/** Epoch microseconds of this event. ... *//** Usually a short tag indicating an event, like "error" ... */ByteString.EMPTYbuilder.valueaddUnknownFields(...)unknownFields(...)Annotation oo.timestampo.valuesuper.hashCodeMessage<>.Builder<Annotation,Builder>buildUnknownFields(...)FieldEncoding.LENGTH_DELIMITEDAnnotation.classencodedSizeWithTag(...)ProtoAdapter<>.FIXED64value.timestampProtoAdapter<>.STRINGvalue.valueencodeWithTag(...)long tokenbeginMessage(...)int tagnextTag(...)readUnknownField(...)endMessageAndGetUnknownFields(...)clearUnknownFields(...)// Code generated by Wire protocol buffer compiler, do not edit.// Source file: zipkin.protoimport Integer/** The network context of a node in the service graph. ... */new ProtoAdapter_Endpoint(...)ProtoAdapter<Endpoint> ADAPTER, ...;String DEFAULT_SERVICE_NAME, ...;ByteString DEFAULT_IPV4, ...;ByteString DEFAULT_IPV6, ...;Integer DEFAULT_PORT, ...;String service_name, ...;/** Lower-case label of this node in the service graph, such as "favstar". ... */ByteString ipv4, ...;/** 4 byte representation of the primary IPv4 address associated with this ... */ByteString ipv6, ...;/** 16 byte representation of the primary IPv6 address associated with this ... */Integer port, ...;/** Depending on context, this could be a listen port or the client-side of a ... */this.service_namethis.ipv4this.ipv6builder.service_nameEndpoint oo.service_nameo.ipv4o.ipv6o.portMessage<>.Builder<Endpoint,Builder>Endpoint.classvalue.service_nameProtoAdapter<>.BYTESvalue.ipv4value.ipv6ProtoAdapter<>.INT32value.portservice_name(...)/** A list of spans with possibly different trace ids, in no particular order. ... */new ProtoAdapter_ListOfSpans(...)ProtoAdapter<ListOfSpans> ADAPTER, ...;WireField.Label.REPEATEDWireField.LabelimmutableCopyOf(...)builder.spansListOfSpans oo.spansMessage<>.Builder<ListOfSpans,Builder>newMutableList(...)checkElementsNotNull(...)new ListOfSpans(...)ListOfSpans.classasRepeated(...)value.spansSpan.ADAPTERredactElements(...)/** Response for SpanService/Report RPC. This response currently does not return ... */ReportResponse.Buildernew ProtoAdapter_ReportResponse(...)ProtoAdapter<ReportResponse> ADAPTER, ...;ReportResponse oMessage<>.Builder<ReportResponse,Builder>new ReportResponse(...)ReportResponse.classimport EnumAdapterimport WireEnumimport Boolean/** A span is a single-host view of an operation. A trace is a series of spans ... */new ProtoAdapter_Span(...)Kind.SPAN_KIND_UNSPECIFIEDProtoAdapter<Span> ADAPTER, ...;ByteString DEFAULT_TRACE_ID, ...;ByteString DEFAULT_PARENT_ID, ...;ByteString DEFAULT_ID, ...;Kind DEFAULT_KIND, ...;String DEFAULT_NAME, ...;Long DEFAULT_DURATION, ...;Boolean DEFAULT_DEBUG, ...;Boolean DEFAULT_SHARED, ...;ByteString trace_id, ...;/** Randomly generated, unique identifier for a trace, set on all spans within ... */ByteString parent_id, ...;/** The parent span ID or absent if this the root span in a trace. */ByteString id, ...;/** Unique identifier for this operation within the trace. ... *//** When present, used to interpret remote_endpoint *//** The logical operation this span represents in lowercase (e.g. rpc method). ... *//** Epoch microseconds of the start of this span, possibly absent if ... */Long duration, ...;/** Duration in microseconds of the critical path, if known. Durations of less ... */Endpoint local_endpoint, ...;Endpoint remote_endpoint, ...;/** When an RPC (or messaging) span, indicates the other side of the ... *//** Associates events that explain latency with the time they happened. *//** Tags give your span context for search, viewing and analysis. ... *//** True is a request to store this span even if it overrides sampling policy. ... */Boolean shared, ...;/** True if we are contributing to a span started by another tracer (ex on a ... */this.trace_idthis.parent_idthis.local_endpointthis.remote_endpointthis.sharedbuilder.trace_idbuilder.parent_idbuilder.local_endpointbuilder.remote_endpointbuilder.sharedSpan oo.trace_ido.parent_ido.ido.kindo.nameo.durationo.local_endpointo.remote_endpointo.annotationso.tagso.debugo.sharedMessage<>.Builder<Span,Builder>newMutableMap(...)/** When present, kind clarifies timestamp, duration and remote_endpoint. When ... */new ProtoAdapter_Kind(...)Kind SPAN_KIND_UNSPECIFIED, ...;/** Default value interpreted as absent. *//** The span represents the client side of an RPC operation, implying the ... *//** The span represents the server side of an RPC operation, implying the ... *//** The span represents production of a message to a remote broker, implying ... *//** The span represents consumption of a message from a remote broker, not ... */ProtoAdapter<Kind> ADAPTER, ...;/** Return the constant for {@code value} or null. */Kind.classfromValue(...)newMapAdapter(...)ProtoAdapter<Map<String,String>> tags, ...;value.trace_idvalue.parent_idvalue.idKind.ADAPTERvalue.kindvalue.nameProtoAdapter<>.UINT64value.durationEndpoint.ADAPTERvalue.local_endpointvalue.remote_endpointvalue.annotationsAnnotation.ADAPTERvalue.tagsProtoAdapter<>.BOOLvalue.debugvalue.sharedtrace_id(...)parent_id(...)EnumConstantNotFoundException eProtoAdapter<>.EnumConstantNotFoundExceptionaddUnknownField(...)FieldEncoding.VARINTe.valuelocal_endpoint(...)remote_endpoint(...)redact(...)import UdtValueimport UserDefinedTypeimport MappingCodecimport TypeCodecimport GenericType/** For better performance, this relies on ordinals instead of name lookups. ... */getCqlType(...)setString(...)setLong(...)newValue(...)Call<List<String>> keysCall, ...;SelectAutocompleteValues.Factory valuesCallFactory, ...;SelectAutocompleteValues.Factorymetadata(...).hasAutocompleteTagsstorage.searchEnabledstorage.autocompleteKeysmetadata(...)new Factory(...)session(...)import CqlSessionimport Uuidsimport SimpleImmutableEntryimport UUIDimport AggregateCallimport InsertEntryimport static CassandraUtil.durationIndexBucketimport static Schema.TABLE_AUTOCOMPLETE_TAGSimport static Schema.TABLE_SERVICE_REMOTE_SERVICESimport static Schema.TABLE_SERVICE_SPANSCqlSession session, ...;// not final for testingInsertSpan.Factory insertSpan, ...;InsertSpan.FactoryInsertTraceByServiceRemoteService.Factory insertTraceByServiceRemoteService, ...;InsertTraceByServiceRemoteService.Factory// Everything below here is null when search is disabledInsertTraceByServiceSpan.Factory insertTraceByServiceSpan, ...;InsertTraceByServiceSpan.FactoryInsertEntry.Factory insertServiceSpan, ...;InsertEntry.FactoryInsertEntry.Factory insertServiceRemoteService, ...;InsertEntry.Factory insertAutocompleteValue, ...;storage.strictTraceIdstorage.autocompleteTtlstorage.autocompleteCardinality// Exposed to allow tests to switch from strictTraceId to notSchema.Metadatathis.sessionmetadata.hasRemoteServicemetadata.hasAutocompleteTags/** This fans out into many requests, last count was 2 * spans.size. If any of these fail, the ... */Set<Input> spansnew LinkedHashSet<Input>(...)Set<Entry<String,String>> serviceRemoteServicesnew LinkedHashSet<Entry<String,String>>(...)Set<Entry<String,String>> serviceSpansSet<Input> traceByServiceRemoteServicesSet<Input> traceByServiceSpansSet<Entry<String,String>> autocompleteTagsList<Call<Void>> callsnew ArrayList<Call<Void>>(...)InsertSpan.InputInsertTraceByServiceRemoteService.InputInsertTraceByServiceSpan.Inputlong ts_microUUID ts_uuidnew UUID(...)getMostSignificantBits(...)getLeastSignificantBits(...)startOf(...)random(...)String serviceString spanString remoteServiceint bucketdurationIndexBucket(...)long durationguessTimestamp(...)newInput(...)new SimpleImmutableEntry<String,String>(...)Input spanEntry<String,String> serviceSpanmaybeAdd(...)Entry<String,String> serviceRemoteServiceInput serviceSpanInput serviceRemoteServiceEntry<String,String> autocompleteTagnewVoidCall(...)Annotation annotation// indexing occurs by timestamp, so derive one if not present.// fallback to current time on the ts_uuid for span data, so we know when it was inserted// Empty values allow for api queries with blank service or span name// Empty value allows for api queries without span name// don't index further w/o a service name// service span and remote service indexes is refreshed regardless of timestamp// search is only valid with a timestamp, don't index w/o it!// duration index is milliseconds not microseconds// Allows lookup without the span name// return a timestamp that won't match a queryimport DriverExceptionimport KeyspaceMetadataimport FlatMapperimport KeyspaceMetadataUtilimport IntersectKeySetsimport IntersectMapsimport static CassandraUtil.traceIdsSortedByDescTimestampimport static Schema.TABLE_TRACE_BY_SERVICE_SPANCassandraSpanStore.class//not final for testingSelectFromSpan.Factory spans, ...;SelectFromSpan.FactorySelectDependencies.Factory dependencies, ...;SelectDependencies.Factoryint indexTtl, ...;Call<List<String>> serviceNames, ...;// zero when disabledSelectRemoteServiceNames.Factory remoteServiceNames, ...;SelectRemoteServiceNames.FactorySelectSpanNames.Factory spanNames, ...;SelectSpanNames.FactorySelectTraceIdsFromSpan.Factory spanTable, ...;SelectTraceIdsFromSpan.FactorySelectTraceIdsFromServiceSpan.Factory traceIdsFromServiceSpan, ...;SelectTraceIdsFromServiceSpan.FactorySelectTraceIdsFromServiceRemoteService.Factory traceIdsFromServiceRemoteService, ...;SelectTraceIdsFromServiceRemoteService.FactoryCqlSession sessionMetadata metadataint maxTraceColsstorage.maxTraceColsboolean strictTraceIdKeyspaceMetadata mdensureKeyspaceMetadata(...)storage.keyspacestorage.indexFetchMultipliergetDefaultTtl(...)SelectServiceNames.FactoryinitialiseSelectTraceIdsFromSpan(...)/** This makes it possible to safely drop the annotations_query SASI. ... */DriverException ex/** This fans out into a number of requests corresponding to query input. In simplest case, there ... */TimestampRange timestampRangetimestampRange(...)int traceIndexFetchSizeList<Call<Map<String,Long>>> callsToIntersectnew ArrayList<Call<Map<String,Long>>>(...)List<String> annotationKeysannotationKeys(...)IntersectKeySets intersectedTraceIdsnew IntersectKeySets(...)String annotationKeyannotationQueryString(...)newBucketedTraceIdCall(...)newFlatMapper(...)traceIdsSortedByDescTimestamp(...)// and speculatively query those first.// TODO: smartly handle when serviceName is null. For example, rank recently written serviceNames/** Creates a call representing one or more queries against {@link Schema#TABLE_TRACE_BY_SERVICE_SPAN} ... */Long minDurationLong maxDurationint startBuckettimestampRange.startMillisint endBuckettimestampRange.endMillisList<Input> serviceSpansnew ArrayList<Input>(...)List<Input> serviceRemoteServicesSelectTraceIdsFromServiceSpan.InputSelectTraceIdsFromServiceRemoteService.Inputboolean addSpanQueryCall<List<String>> serviceNamesnew AggregateFlatMapper<K,V>(...)new IntersectMaps<String,Long>(...)FlatMapper<List<K>,Map<K,V>> left, ...;new IntersectMaps<K,V>(...)String normalizedTraceIdlong startMillis, ...;UUID startUUID, ...;long endMillis, ...;UUID endUUID, ...;long oldestDataTimestampRange resultnew TimestampRange(...)result.startMillisresult.startUUIDresult.endMillisresult.endUUIDendOf(...)// If we have to make multiple queries, over fetch on indexes as they don't return distinct// (trace id, timestamp) rows. This mitigates intersection resulting in < limit traces// Bucketed calls can be expensive when service name isn't specified. This guards against abuse.// We achieve the AND goal, by intersecting each of the key sets.// @xxx the sorting by timestamp desc is broken here^// trace_by_service_span adds special empty-string span name in order to search by all// "" isn't a real value. it is used to template bucketed calls and replaced later// TODO: ideally, the buckets are traversed backwards, only spawning queries for older buckets// if younger buckets are empty. This will be an async continuation, punted for now.// If the remote service query can satisfy the request, don't make a redundant span query// If we have no service name, we have to lookup service names before running trace ID queries// make sure we have a 16 or 32 character trace IDimport AuthProviderimport DriverOptionimport ProgrammaticPlainTextAuthProviderimport CassandraStorageBuilderimport ResultSetFutureCall/** CQL3 implementation of zipkin storage. ... */// @FunctionalInterface, except safe for lower language levelsnew DefaultSessionFactory(...)SessionFactory DEFAULT, ...;SessionFactory sessionFactory, ...;Schema.DEFAULT_KEYSPACE/** Keyspace to store span and index data. Defaults to "zipkin2" *//** Ensures that schema exists, if enabled tries to execute: ... *//** Override to control how sessions are created. */this.sessionFactoryAuthProvider authProvidernew ProgrammaticPlainTextAuthProvider(...)new CassandraStorage(...)poolingOptions(...)int autocompleteTtl, ...;Map<DriverOption,Integer> poolingOptions, ...;AuthProvider authProvider, ...;int maxTraceCols, ...;LazySession session, ...;this.autocompleteTtlthis.autocompleteCardinalitythis.poolingOptionsthis.authProviderthis.maxTraceColsnew LazySession(...)boolean closeCalled, ...;/** close is typically called from a different thread */CassandraSpanConsumer spanConsumer, ...;CassandraSpanStore spanStore, ...;CassandraAutocompleteTags tagStore, ...;/** Lazy initializes or returns the session in use by this storage component. *//** {@inheritDoc} Memoized in order to avoid re-preparing statements */new CassandraSpanStore(...)new CassandraAutocompleteTags(...)// Memoized in order to avoid re-preparing statementsnew CassandraSpanConsumer(...)healthCheck(...)// Assign generic configuration for all storage components// Assign configuration used to create a session// Assign configuration used to control queriesimport BigIntegerimport UnknownHostExceptionimport Instantimport LocalDateimport ZoneOffsetimport Randomimport DateUtilimport static RecyclableBuffers.SHORT_STRING_LENGTHCassandraUtil.classlong DURATION_INDEX_BUCKET_WINDOW_SECONDS, ...;/** Time window covered by a single bucket of the {@link Schema#TABLE_TRACE_BY_SERVICE_SPAN} and ... *//** Returns a set of annotation getValues and tags joined on equals, delimited by  ... */char delimiterSet<String> annotationKeysEntry<String,String> eCall<>.Mapper<Map<String,Long>,Set<String>>TraceIdsSortedByDescTimestamp.INSTANCEnew TraceIdsSortedByDescTimestamp(...)new Random(...)TraceIdsSortedByDescTimestamp INSTANCE, ...;TreeMap<BigInteger,String> sortednew TreeMap<BigInteger,String>(...)reverseOrder(...)Entry<String,Long> entryMap<>.Entry<String,Long>BigInteger uncollidedmultiply(...)Random RAND, ...;BigInteger OFFSET, ...;List<LocalDate> resultnew ArrayList<LocalDate>(...)long epochMillisepochDays(...)toLocalDate(...)atZone(...)ofEpochMilli(...)ZoneOffset.UTCgetByAddress(...)UnknownHostException e// if the window constant has microsecond precision, the division produces negative getValues// as very unlikely to be in the query// search is possible by key alone// timestamps can collide, so we need to add some random digits on end before using them as// serviceSpanKeysimport MutableCodecRegistryimport SessionBuilder/** Creates a session and ensures schema if configured. Closes the cluster and session if any ... */CassandraStorage.SessionFactorySchema.classString keyspacecassandra.keyspacebuildSession(...)cassandra.ensureSchemaensureExists(...)cassandra.searchEnabledinitializeUDTs(...)cassandra.contactPointscassandra.localDccassandra.poolingOptionscassandra.authProvidercassandra.useSslKeyspaceMetadata ksgetKeyspace(...)getMetadata(...)MutableCodecRegistry codecRegistrygetCodecRegistry(...)getContext(...)TypeCodec<UdtValue> annotationUDTCodeccodecFor(...)getUserDefinedType(...)TypeCodec<UdtValue> endpointUDTCodecnew AnnotationCodec(...)new EndpointCodec(...)// don't leak on unexpected exception!import static CassandraUtil.inetAddressOrNullgetInetAddress(...)UdtValue resultsetInetAddress(...)inetAddressOrNull(...)import AsyncResultSetimport BoundStatementBuilderimport PreparedStatementimport AutoValueimport CompletionStageimport static Schema.TABLE_SPANPreparedStatement preparedStatement, ...;String insertQuerythis.preparedStatementprepare(...)boolean traceIdHighString annotation_querynew AutoValue_InsertSpan_Input(...)new InsertSpan(...)Factory factory, ...;Input input, ...;this.input/** TLDR: we are guarding against setting null, as doing so implies tombstones. We are dodging setX ... */BoundStatementBuilder boundsetUuid(...)boundStatementBuilder(...)ts_uuid(...)factory.preparedStatementtrace_id_high(...)ts(...)l_ep(...)r_ep(...)setList(...)setMap(...)String.classsetBoolean(...)factory.searchEnabledannotation_query(...)executeAsync(...)factory.session// Don't set null as we don't want to add tombstonesimport static Schema.TABLE_TRACE_BY_SERVICE_REMOTE_SERVICEnew AutoValue_InsertTraceByServiceRemoteService_Input(...)new InsertTraceByServiceRemoteService(...)bucket(...)remote_service(...)/** While {@link zipkin2.Span#duration()} cannot be zero, zero duration in milliseconds is ... */new AutoValue_InsertTraceByServiceSpan_Input(...)new InsertTraceByServiceSpan(...)import ResultSetCassandraStorage storage, ...;PreparedStatement healthCheck, ...;Schema.Metadata metadata, ...;// guarded by sessionreadMetadata(...)CqlSession maybeSession// cached here to warn only once when schema problems existimport Versionimport Nodeimport Patternimport static Resources.resourceToStringString TABLE_SPAN, ...;String TABLE_TRACE_BY_SERVICE_SPAN, ...;String TABLE_TRACE_BY_SERVICE_REMOTE_SERVICE, ...;String TABLE_SERVICE_SPANS, ...;String TABLE_SERVICE_REMOTE_SERVICES, ...;String TABLE_DEPENDENCY, ...;String TABLE_AUTOCOMPLETE_TAGS, ...;String DEFAULT_KEYSPACE, ...;String SCHEMA_RESOURCE, ...;String INDEX_RESOURCE, ...;String UPGRADE_1, ...;String UPGRADE_2, ...;KeyspaceMetadata keyspaceMetadataMap<String,String> replicationgetReplication(...)boolean hasAutocompleteTagshasUpgrade1_autocompleteTags(...)boolean hasRemoteServicehasUpgrade2_remoteService(...)new Metadata(...)boolean hasAutocompleteTags, ...;this.hasAutocompleteTagsthis.hasRemoteServiceensureVersion(...)getClusterName(...)Version versionEntry<UUID,Node> entryMap<>.Entry<UUID,Node>getNodes(...)getCassandraVersion(...)KeyspaceMetadata resultgetTable(...)Schema.TABLE_SPANapplyCqlFile(...)String cmdresourceToString(...)reviseCQL(...)getMajor(...)// refresh metadata since we've installed the schema// read_repair_chance options were removed and make Cassandra crash starting in v4// See https://cassandra.apache.org/doc/latest/operating/read_repair.html#background-read-repairimport DistinctSortedStringsnew SelectAutocompleteValues(...)SelectAutocompleteValues.Factory factory, ...;import Rowimport static Schema.TABLE_DEPENDENCYList<LocalDate> daysgetDays(...)new SelectDependencies(...)List<LocalDate> days, ...;this.daysLocalDate.classList<DependencyLink> unmergedRow rowcurrentPage(...)import BiConsumerimport GroupByTraceIdimport StrictTraceIdimport AccumulateAllResultsnew ReadSpans(...)Call<>.Mapper<List<Span>,List<List<Span>>> groupByTraceId, ...;this.groupByTraceIdSet<String> traceIdsCall<List<Span>> resultnew SelectFromSpan(...)singleton(...)filterSpans(...)Set<String> normalizedTraceIdsCall<List<List<Span>>> resultfilterTraces(...)new SelectSpansByTraceIds(...)Set<String> trace_id, ...;int limit_, ...;this.limit_Call<>.Mapper<List<List<Span>>,List<List<Span>>> filter, ...;this.filterfactory.strictTraceIdfactory.groupByTraceIdfactory.maxTraceColsIterator<String> iteratorAccumulateAllResults<List<Span>> READ_SPANS, ...;new Supplier<List<Span>>(...) { ... }new ArrayList<>(...)new BiConsumer<Row,List<Span>>(...) { ... }String traceIdHighIllegalArgumentException ignoredgetBoolean(...)getList(...)getMap(...)// Unless we are strict, truncate the trace ID to 64bit (encoded as 16 characters)// Switched Set to List which is higher overhead, as have to copy into it, but avoids this:// com.datastax.oss.driver.api.core.type.codec.CodecNotFoundException: Codec not found for requested operation: [List(TEXT, not frozen) <-> java.util.Set<java.lang.String>]// Cassandra always looks up traces by 64-bit trace ID, so we have to unconditionally filter// when strict trace ID is enabled.new SelectRemoteServiceNames(...)String service, ...;this.servicenew SelectServiceNames(...)new SelectSpanNames(...)import TimestampRangeimport AccumulateTraceIdTsUuidimport AggregateIntoMapnew AutoValue_SelectTraceIdsFromServiceRemoteService_Input(...)start_ts(...)end_ts(...)limit_(...)timestampRange.startUUIDtimestampRange.endUUIDList<Call<Map<String,Long>>> bucketedTraceIdCallsInput inputnew AggregateIntoMap<String,Long>(...)new SelectTraceIdsFromServiceRemoteService(...)/** Applies all deferred service names to all input templates */new FlatMapServicesToInputs(...)List<Input> inputTemplates, ...;this.inputTemplatesList<Input> scopedInputswithService(...)List<String> inputssetPageSize(...)// fan out every input for each service namenew AutoValue_SelectTraceIdsFromServiceSpan_Input(...)start_duration(...)end_duration(...)PreparedStatement selectTraceIdsByServiceSpanName, ...;PreparedStatement selectTraceIdsByServiceSpanNameAndDuration, ...;String baseQuerythis.selectTraceIdsByServiceSpanNamethis.selectTraceIdsByServiceSpanNameAndDurationLong start_durationLong end_durationPreparedStatement preparedStatementnew SelectTraceIdsFromServiceSpan(...)/** Selects from the {@link Schema#TABLE_SPAN} using data in the partition key or SASI indexes. ... */PreparedStatement withAnnotationQuery, ...;String querySuffixthis.withAnnotationQuerythis.withServiceAndAnnotationQuerynew AutoValue_SelectTraceIdsFromSpan_Input(...)new SelectTraceIdsFromSpan(...)l_service(...)new AccumulateTraceIdTsLong(...)AccumulateAllResults<Map<String,Long>> INSTANCE, ...;new Supplier<Map<String,Long>>(...) { ... }new LinkedHashMap<>(...)new BiConsumer<Row,Map<String,Long>>(...) { ... }// because results are not distinct// no timestampimport DefaultDriverOptionimport static DefaultDriverOption.CONNECTION_MAX_REQUESTSimport static DefaultDriverOption.CONNECTION_POOL_LOCAL_SIZETimeUnit.HOURSint autocompleteCardinality, ...;// Ex. 5 site tags with cardinality 4000 each// Driver v4 requires this, so take a guess! When we are wrong, the user can override anywayint poolLocalSize, ...;// Ported from java-driver v3 PoolingOptions.setMaxConnectionsPerHost(HostDistance.LOCAL, 8)// increase some properties beyond the norm.// Zipkin collectors can create out a lot of async requests in bursts, so weint maxRequestsPerConnection, ...;// Ported from java-driver v3 PoolingOptions.setMaxQueueSize(40960)Map<DriverOption,Integer> resultnew LinkedHashMap<DriverOption,Integer>(...)new LinkedHashSet<E>(...)/** Comma separated list of host addresses part of Cassandra cluster. You can also specify a custom ... *//** Name of the datacenter that will be considered "local" for latency load balancing. When unset, ... *//** Max pooled connections per datacenter-local host. Defaults to 8 */this.poolLocalSize/** Will throw an exception on startup if authentication fails. No default. *//** Use ssl for connection. Defaults to false. *//** Keyspace to store span and index data. Defaults to "zipkin3" *//** Spans have multiple values for the same id. For example, a client and server contribute to the ... *//** How many more index rows to fetch than the user-supplied query limit. Defaults to 3. ... */// Similar to com.google.common.net.HostAndPort, but no guava dep/** Returns the unvalidated hostname or IP literal *//** Returns the port */HostAndPort thatthat.host/** Constructs a host-port pair from the given string, defaulting to the indicated port if absent */int endHostIndexint colonIndexint nextColonIndexnew HostAndPort(...)validatePort(...)// Bracketed IPv6// reuse our IPv6 validator// only 1 colon// isDigitimport CqlIdentifierimport TableMetadatanew Function<TableMetadata,Map<CqlIdentifier,Object>>(...) { ... }getOptions(...)new Function<Map<CqlIdentifier,Object>,Optional<? extends Object>>(...) { ... }ofNullable(...)fromCql(...)import ReaderReader readerResources.classint readIOException eximport CqlSessionBuilderimport DriverConfigLoaderimport ProgrammaticDriverConfigLoaderBuilderimport DefaultSslEngineFactoryimport RequestLoggerimport static DefaultDriverOption.REQUEST_CONSISTENCYimport static DefaultDriverOption.REQUEST_DEFAULT_IDEMPOTENCEimport static DefaultDriverOption.REQUEST_LOGGER_SUCCESS_ENABLEDimport static DefaultDriverOption.REQUEST_LOGGER_VALUESimport static DefaultDriverOption.REQUEST_TIMEOUTimport static DefaultDriverOption.REQUEST_TRACKER_CLASSimport static DefaultDriverOption.REQUEST_WARN_IF_SET_KEYSPACEimport static DefaultDriverOption.SSL_ENGINE_FACTORY_CLASS/** Returns a connected session. Closes the cluster if any exception occurred. */ProgrammaticDriverConfigLoaderBuilder configprogrammaticBuilder(...)SessionBuilder.classCqlSessionBuilder builderLogger requestLoggerRequestLogger.classwithDuration(...)ofMinutes(...)addContactPoints(...)parseContactPoints(...)withAuthProvider(...)withLocalDatacenter(...)withString(...)new BiConsumer<DriverOption,Integer>(...) { ... }withInt(...)withBoolean(...)withClass(...)DefaultSslEngineFactory.classisTraceEnabled(...)withConfigLoader(...)List<InetSocketAddress> resultnew ArrayList<InetSocketAddress>(...)String contactPointHostAndPort parsedfromString(...)new InetSocketAddress(...)// Some options aren't supported by builder methods. In these cases, we use driver config// See https://groups.google.com/a/lists.datastax.com/forum/#!topic/java-driver-user/Z8HrCDX47Q0// We aren't reading any resources from the classpath, but this prevents errors running in the// server, where Thread.currentThread().getContextClassLoader() returns null// Ported from java-driver v3 PoolingOptions.setPoolTimeoutMillis as request timeout includes that// In java-driver v3, we used LatencyAwarePolicy(DCAwareRoundRobinPolicy|RoundRobinPolicy)//   where DCAwareRoundRobinPolicy was used if localDc != null// In java-driver v4, the default policy is token-aware and localDc is required. Hence, we// use the default load balancing policy//  * https://github.com/datastax/java-driver/blob/master/manual/core/load_balancing/README.md// Pooling options changed dramatically from v3->v4. This is a close match.// All Zipkin CQL writes are idempotent// Log categories can enable query logging// Only show bodies when TRACE is enabled// Don't warn: ensureSchema creates the keyspace. Hence, we need to "use" it later.identity(...)new AccumulateNextResults<T>(...)accumulator(...)finisher(...)supplier(...)AsyncResultSet resultSet, ...;this.resultSettoCompletableFuture(...)fetchNextPage(...)T pendingResults, ...;BiConsumer<Row,T> accumulator, ...;Function<T,T> finisher, ...;this.pendingResultsthis.accumulatorthis.finisher/** Iterates through the rows in each page, flatmapping on more results until exhausted */one(...)getPagingState(...)getExecutionInfo(...)hasMorePages(...)new FetchMoreResults(...)// Return collected results if there are no more pagesnew AccumulateTraceIdTsUuid(...)unixTimestamp(...)getUuid(...)new LinkedHashMap<K,V>(...)new AggregateIntoMap(...)import DelayLimiterDelayLimiter<I> delayLimiter, ...;cardinality(...)ttl(...)shouldInvoke(...)I input, ...;this.delayLimiterinvalidate(...)/** Same as {@code MoreExecutors.directExecutor()} except without a guava 18 dep */new DirectExecutor(...)DirectExecutor INSTANCE, ...;new DistinctSortedStrings(...)AccumulateAllResults<List<String>> INSTANCE, ...;new Supplier<List<String>>(...) { ... }SortDistinct.INSTANCEnew SortDistinct(...)SortDistinct INSTANCE, ...;new BiConsumer<Row,List<String>>(...) { ... }DeduplicatingInsert<>.Factory<Entry<String,String>>/** Cassandra v1 has deprecated support for indexTtl. */new InsertEntry(...)factory.delayLimitergetQuery(...)boolean firstInput, ...;retainAll(...)new IntersectMaps(...)import DriverExecutionExceptionimport RequestThrottlingExceptionimport BusyConnectionExceptionimport QueryConsistencyExceptionimport BiFunction// some copy/pasting is ok here as debugging is obscured when the type hierarchy gets deep.Call<>.Base<V>/** Defers I/O until {@link #enqueue(Callback)} or {@link #execute()} are called. */CompletableFuture<V> future, ...;getUninterruptibly(...)thenApply(...)newCompletionStage(...)handleAsync(...)new CallbackFunction<V>(...)CompletableFuture<V> maybeFutureisCancelled(...)Callback<V> callback, ...;// Avoid internal dependency on Datastax CompletableFutures and shaded Throwablesboolean interruptedExecutionException ecopy(...)new DriverExecutionException(...)/** Sets {@link zipkin2.storage.StorageComponent#isOverCapacity(java.lang.Throwable)} */// dispatched to Function so that toString is nicer vs a lambdaimport static Collections.singletonListimport static Assertions.entryimport static Assertions.tupleimport static TestObjects.BACKENDimport static InternalForTests.mockSessionCassandraSpanConsumer consumer, ...;Span spanWithoutAnnotationsOrTags, ...;Call<Void> callhasSameClassAs(...)AggregateCall<?,Void> calltuple(...)new Predicate<Call<?>>(...) { ... }entry(...)InsertSpan.classResultSetFutureCall<>.class/** To allow lookups w/o a span name, we index "". "" is used instead of null to avoid creating ... */new SessionFactory(...) { ... }mockSession(...)import FlatMapServicesToInputs// or possibly special-casing common transformations.// This could be made a little less complex if we scrub out map=>map to a list of transformations,// TODO: tests use toString because the call composition chain is complex (includes flat mapping)QueryRequest.Builder queryBuilder, ...;Call<List<List<Span>>> callFlatMapServicesToInputs.classCassandraSpanStore spanStore// no need to look at two indexes// works against the span table// needs to look at two indexesimport DefaultNodeMetricimport Metricsimport InvalidQueryExceptionimport static Assumptions.assumeTrueimport static ITCassandraStorage.SEARCH_TABLESnew CassandraContainer(...)CassandraStorageExtension.classCassandraContainer container, ...;CqlSession globalSession, ...;contactPoint(...)tryToInitializeSession(...)// Builds a session without trying to use a namespace or init UDTsCassandraStorage storagenewStorageBuilder(...)assumeTrue(...)CassandraSpanConsumer spanConsumerstorage.spanConsumerstorage.session.sessionstorage.sessionList<String> toTruncateString tableInvalidQueryException eblockWhileInFlight(...)boolean wasInFlightpoolInFlight(...)// https://groups.google.com/a/lists.datastax.com/g/java-driver-user/c/5um_yGNynow/m/cInH5I5jBgAJ// Use metrics to wait for in-flight requests to settle perCollection<Node> nodesOptional<Metrics> metricsgetMetrics(...)Node nodeint inFlightnew Function<Metrics,Optional<? extends Object>>(...) { ... }getNodeMetric(...)DefaultNodeMetric.IN_FLIGHTnew Function<Object,Integer>(...) { ... }// Clear any key cache// Now, block until writes complete, notably so we can read them.// give a little more to avoid flakey testsimport AllNodesFailedExceptionimport Authenticatorimport EndPointbuild(...).authProviderProgrammaticPlainTextAuthProvider authProviderAuthenticator authenticatornewAuthenticator(...)EndPoint.classbyte[] SASLhandshakeinitialResponse(...)new Function<ByteBuffer,byte[]>(...) { ... }AllNodesFailedException.classCassandraStorage cassandraimport static TimeUnit.DAYSQueryRequest requestString arn/** Sanity checks our bucketing scheme for numeric overflow */isNotNegative(...)Map<String,Long> inputnew LinkedHashMap<String,Long>(...)Set<String> sortedTraceIdsAssertionError enew ThrowingExtractor<LocalDate,Long,RuntimeException>(...) { ... }toEpochSecond(...)atStartOfDay(...)// example long value// example too long value// today isn't negative// neither is 10 years from nowimport Disabledimport Nestedimport TestInfoimport Builderimport static InternalForTests.writeDependencyLinksnew CassandraStorageExtension(...)List<String> SEARCH_TABLES, ...;CassandraStorageExtension cassandra, ...;CassandraStorage strictTraceId, ...;storage.contactPoints/** Ensures we can still lookup fully 128-bit traces when strict trace ID id disabled */getTraces_128BitTraceId(...)accept128BitTrace(...)/** Ensures data written before strict trace ID was enabled can be read */assertGetTraceReturns(...)/** The current implementation does not include dependency aggregation. It includes retrieval of ... */aggregateLinks(...)new BiConsumer<Long,List<DependencyLink>>(...) { ... }writeDependencyLinks(...)import static TestObjects.appendSuffiximport static TestObjects.newTraceimport static ITDependencies.aggregateLinks/** Large amounts of writes can make other tests flake. This can happen for reasons such as ... */CassandraStorageExtension backend, ...;String testSuffixtestSuffix(...)int localServiceCountrequestBuilder(...)appendSuffix(...)long deltanewTrace(...)clearAnnotations(...)new Consumer<Annotation>(...) { ... }new Span[]isGreaterThan(...)backend.globalSession// Intentionally don't clean up as each method runs in an isolated keyspace. This prevents// adding more load to the shared Cassandra instance used for all tests.// all timestamps happen a millisecond later// Index ends up containing more rows than services * trace count, and cannot be de-duped// in a server-side query.// Implementation over-fetches on the index to allow the user to receive unsurprising results.// Ensure we use serviceName so that trace_by_service_span is usedimport ITStorage/** This test is very slow as installing the schema can take 10s per method. */KeyspaceMetadata metadataString searchTable/** This tests we don't accidentally rely on new indexes such as autocomplete tags */// We need a different keyspace per test// don't check as it requires the keyspace which these tests install// Ensure the storage component is functional before proceeding// instead of an exception// Make sure there's an error if a query will return incorrectly vs returning invalid resultsimport IntStreamimport static Kind.SERVERimport static TestObjects.newClientSpanimport static TestObjects.spanBuilder/** {@link Span#timestamp()} == 0 is likely to be a mistake, and coerces to null. It is not helpful ... */spanBuilder(...)rowCountForTraceByServiceSpan(...)/** Simulates a trace with a step pattern, where each span starts a millisecond after the prior ... */Span[] traceCassandraSpanConsumer withoutStrictTraceIdnewClientSpan(...)range(...)new IntConsumer(...) { ... }rowCountForTags(...)getTagValue(...)/** It is easier to use a real Cassandra connection than mock a prepared statement. */Span clientSpanAggregateCall<?,?> acceptCallList<Call<?>> insertEntryCallsSchema.TABLE_TRACE_BY_SERVICE_SPANSchema.TABLE_AUTOCOMPLETE_TAGS// all peer span timestamps happen 1ms later/* strictTraceId */// sanity check base case// TODO: magic number// Since tag {a,b} are not in the whitelist// This test can use fake data as it is never written to cassandraimport MetadataCqlSession.classMetadata.classNode.classKeyspaceMetadata.classTableMetadata.classPreparedStatement preparedSchema.TABLE_DEPENDENCYLocalDate daysetLocalDate(...)getTestMethod(...)getTestClass(...)Node node1Node node2Map<UUID,Node> nodesnew LinkedHashMap<UUID,Node>(...)String schemaWithReadRepair, ...;Version.V4_0_0// literal used to show newlines etc are in-tactnew CassandraStorageBuilder<>(...) { ... }CassandraStorageBuilder<?> builder, ...;List<Function<CassandraStorageBuilder<?>,CassandraStorageBuilder<?>>> badArgumentsnew Function<CassandraStorageBuilder<?>,CassandraStorageBuilder<?>>(...) { ... }maxTraceCols(...)new Consumer<Function<CassandraStorageBuilder<?>,CassandraStorageBuilder<?>>>(...) { ... }/** Ensure NPE happens early. */List<Function<CassandraStorageBuilder<?>,CassandraStorageBuilder<?>>> nullPointersNullPointerException.class// Reuses inputs from com.google.common.net.HostAndPortTestimport static SessionBuilder.parseContactPointsTestFactory testFactorynew TestFactory(...)testFactory.valuesCallback<Void> assertFailOnError, ...;testFactory.failValueAssertionError.classDeduplicatingInsert<>.Factory<String>new AtomicReference<String>(...)List<String> values, ...;AtomicReference<String> failValue, ...;new TestDeduplicatingInsert(...)TestFactory factory, ...;factory.failValueCompletableFuture<AsyncResultSet> resultnew CompletableFuture<AsyncResultSet>(...)factory.valuesAsyncResultSet.class// invalidates on exceptionnew ResultSetFutureCall<AsyncResultSet>(...) { ... }ResultSetFutureCallTest.this.futureResultSetFutureCallTest.thisnew CompletableCallback<AsyncResultSet>(...)CompletableFuture<AsyncResultSet> future, ...;ResultSetFutureCall<AsyncResultSet> call, ...;CompletableCallback<AsyncResultSet> callback, ...;call.futureisCompletedExceptionally(...)hasCause(...)// below are load related exceptions which should result in a backoff of storage requestsnew RequestThrottlingException(...)new BusyConnectionException(...)QueryConsistencyException.class// this.future will be wrapped, so can't check if that is canceled.// ensure the callback received the exception// not applicable// Generated by com.google.auto.value.processor.AutoValueProcessorUUID ts_uuid, ...;String trace_id_high, ...;String trace_id, ...;String parent_id, ...;String kind, ...;String span, ...;long ts, ...;long duration, ...;Endpoint l_ep, ...;Endpoint r_ep, ...;String annotation_query, ...;boolean debug, ...;boolean shared, ...;this.ts_uuidthis.trace_id_highthis.tsthis.l_epthis.r_epthis.annotation_queryInput thatString remote_service, ...;int bucket, ...;UUID ts, ...;this.remote_servicethis.bucketUUID start_ts, ...;UUID end_ts, ...;this.start_tsthis.end_tsLong start_duration, ...;Long end_duration, ...;this.start_durationthis.end_durationSelectTraceIdsFromSpan.InputString l_service, ...;this.l_serviceimport JsonSerializersimport BodyConverterimport SearchResultConverterimport static JsonReaders.collectValuesNamednew BodyConverter<Object>(...) { ... }new BodyConverter<List<String>>(...) { ... }collectValuesNamed(...)JsonSerializers.SPAN_PARSERnew SearchResultConverter<DependencyLink>(...) { ... }JsonSerializers.DEPENDENCY_LINK_PARSERJsonSerializers.ObjectParser<DependencyLink>BodyConverter<Object> NULL, ...;BodyConverter<List<String>> KEYS, ...;BodyConverter<List<Span>> SPANS, ...;BodyConverter<List<DependencyLink>> DEPENDENCY_LINKS, ...;import IndexNameFormatterimport Aggregationimport SearchCallFactoryimport SearchRequestimport static VersionSpecificTemplates.TYPE_AUTOCOMPLETEIndexNameFormatter indexNameFormatter, ...;SearchCallFactory search, ...;int namesLookback, ...;this.searchnew SearchCallFactory(...)http(...)this.indexNameFormatterthis.namesLookbackthis.keysCalllong endMillislong beginMillisList<String> indicesformatTypeAndRange(...)SearchRequest.FiltersFilters filtersaddTerm(...)new Filters(...)SearchRequest requestaddAggregation(...)filters(...)terms(...)BodyConverters.KEYSimport BulkCallBuilderimport BulkIndexWriterimport static VersionSpecificTemplates.TYPE_SPANElasticsearchStorage es, ...;char indexTypeDelimiter, ...;DelayLimiter<AutocompleteContext> delayLimiter, ...;this.esthis.indexTypeDelimiterindexTypeDelimiter(...)formatTypeAndTimestampForInsert(...)BulkSpanIndexer indexernew BulkSpanIndexer(...)indexSpans(...)long indexTimestampaddAutocompleteValues(...)/** Mutable type used for each call to store spans */new ArrayList<AutocompleteContext>(...)BulkCallBuilder bulkCallBuilder, ...;ElasticsearchSpanConsumer consumer, ...;List<AutocompleteContext> pendingAutocompleteContexts, ...;BulkIndexWriter<Span> spanWriter, ...;this.bulkCallBuildernew BulkCallBuilder(...)consumer.esversion(...)this.spanWriterconsumer.searchEnabledBulkIndexWriter<>.SPANBulkIndexWriter<>.SPAN_SEARCH_DISABLEDString idxAutocompleteContext contextnew AutocompleteContext(...)consumer.autocompleteKeysconsumer.delayLimiterBulkIndexWriter<>.AUTOCOMPLETECall<Void> storeCallnew ErrorHandler<Void>(...) { ... }AutocompleteContext that// which index to store this span into// guessTimestamp is made for determining the span's authoritative timestamp. When choosing// the index bucket, any annotation is better than using current time.// If the autocomplete whitelist doesn't contain the key, skip storing its valueimport HttpCallimport static VersionSpecificTemplates.TYPE_DEPENDENCYlong EARLIEST_MS, ...;/** To not produce unnecessarily long queries, we don't look back further than first ES support */// March 2016...[] allSpanIndices, ...;this.allSpanIndicesformatType(...)Aggregation traceIdTimestamporderBy(...)addSubAggregation(...)SearchRequest esRequestHttpCall<List<String>> traceIdsCallnew GetSpansByTraceId(...)addRange(...)Entry<String,String> kvterm(...)BodyConverters.SPANSaggregatedFieldByServiceName(...)BodyConverters.DEPENDENCY_LINKSCall<>.FlatMapper<List<String>,List<Span>>List<String> indices, ...;this.indicesSearchRequest getTraces// We need to filter to traces that contain at least one span that matches the request,// but the zipkin API is supposed to order traces by first span, regardless of if it was// filtered or not. This is not possible without either multiple, heavyweight queries// or complex multiple indexing, defeating much of the elegance of using elasticsearch for this.// So we fudge and order on the first span among the filtered spans - in practice, there should// be no significant difference in user experience since span start times are usually very// close to each other in human time.// Elasticsearch lookup by trace ID is by the full 128-bit length, but there's still a chance of// clash on lower-64 bit. When strict trace ID is enabled, we only filter client-side on clash.// A span name is only valid on a local endpoint, as a span name is defined locally// We just return all dependencies in the days that fall within endTs and lookback as// dependency links themselves don't have timestamps.import Memoizedimport ResponseTimeoutExceptionimport static HttpMethod.GETimport static ElasticsearchVersion.V7_0import static ElasticsearchVersion.V7_8import static EnsureIndexTemplate.ensureIndexTemplateimport static JsonReaders.enterPathInternal.instancenew Internal(...) { ... }HttpCall<>.Factorynew BodyConverter<CheckResult>(...) { ... }JsonParser statusenterPath(...)/** This defers creation of an {@link WebClient}. This is needed because routinely, I/O occurs in ... *//** Lazily creates an instance of the http client configured to the correct elasticsearch host or ... *//** This should return the initial endpoints in a single-string without resolving them. *//** The lazy http client supplier will be closed on {@link #close()} */flushOnWrites(...)lazyHttpClient(...)$AutoValue_ElasticsearchStorage.Builder/** Only valid when the destination is Elasticsearch 5.x. Indicates the ingest pipeline used ... *//** Only return span and service names where all {@link zipkin2.Span#timestamp()} are at or after ... *//** Internal and visible only for testing. ... *//** The index prefix to use when generating daily index names. Defaults to zipkin. */indexNameFormatterBuilder(...)/** The date separator to use when generating daily index names. Defaults to '-'. ... *//** The number of shards to split the index into. Each shard and its replicas are assigned to a ... *//** The number of replica copies of each shard in the index. Each shard and its replicas are ... *//** False disables automatic index template installation. *//** Only valid when the destination is Elasticsearch >= 7.8. Indicates the index template ... *//** {@inheritDoc} */IndexNameFormatter.BuilderensureIndexTemplates(...)new ElasticsearchSpanStore(...)new ElasticsearchAutocompleteTags(...)new ElasticsearchSpanConsumer(...)/** Returns the Elasticsearch version of the connected cluster. Internal use only *//** This is an internal blocking call, only used in tests. */Set<String> toClearAggregatedHttpRequest deleteHttpMethod.DELETEBodyConverters.NULL/** Internal code and api responses coerce to {@link RejectedExecutionException} when work is ... *//** This is blocking so that we can determine if the cluster is healthy or not */ensureIndexTemplatesAndClusterReady(...)/** This allows the health check to display problems, such as access, installing the index ... */AggregatedHttpRequest requestboolean ensuredTemplates, ...;// synchronized since we don't want overlapping calls to apply the index templatesdoEnsureIndexTemplates(...)Factory httpIndexTemplates templatesversionSpecificTemplates(...)ensureIndexTemplate(...)buildUrl(...)dependency(...)autocomplete(...)new VersionSpecificTemplates(...)String indexPrefixBodyConverter<CheckResult> READ_STATUS, ...;// ensure the version is available (even if we already cached it)// called only once, so we have to double-check health// Wrapping interferes with humans intended to read this message:// Unwrap the marker exception as the health check is not relevant for the throttle component.// Unwrap any IOException from the first call to ensureIndexTemplates()// because deprecation warning on 6 to prepare for 7 :// [types removal] The parameter include_type_name should be explicitly specified in get// template requests to prepare for 7.0. In 7.0 include_type_name will default to 'false',// which means responses will omit the type name in mapping definitions."import Matcher/** Helps avoid problems comparing versions by number. Ex 7.10 should be > 7.9 */new ElasticsearchVersion(...)ElasticsearchVersion V5_0, ...;ElasticsearchVersion V6_0, ...;ElasticsearchVersion V7_0, ...;ElasticsearchVersion V7_8, ...;ElasticsearchVersion V8_0, ...;Parser.INSTANCEint major, ...;this.majorthis.minorother.majorcompare(...)other.minorElasticsearchVersion thatthat.majorthat.minorhash(...)HttpCall<>.BodyConverter<ElasticsearchVersion>new Parser(...)Parser INSTANCE, ...;Pattern REGEX, ...;AggregatedHttpRequest getNodeElasticsearchVersion versionString versionMatcher matchermatcher(...)Exception possiblyParseExceptionmatches(...)int majorint minorNumberFormatException eimport FileNotFoundException/** Ensures the index template exists and saves off the version *//** This is a blocking call, used inside a lazy. That's because no writes should occur until the ... */AggregatedHttpRequest getTemplateFileNotFoundException eAggregatedHttpRequest updateTemplateHttpMethod.PUT// TODO: handle 404 slightly more nicelyAutoValue_IndexTemplates.Builderimport static ElasticsearchVersion.V5_0import static ElasticsearchVersion.V6_0import static ElasticsearchVersion.V8_0// java -cp zipkin-storage-elasticsearch.jar zipkin2.elasticsearch.VersionSpecificTemplates 6.7 span// a parameter for the version, and a parameter for the index type. Ex.// TODO: make a main class that spits out the index template using ENV variables for the server,/** Returns version-specific index templates */String TYPE_AUTOCOMPLETE, ...;String TYPE_SPAN, ...;String TYPE_DEPENDENCY, ...;String KEYWORD, ...;/** In Zipkin search, we do exact match only (keyword). Norms is about scoring. We don't use that ... */String indexPrefix, ...;int indexReplicas, ...;this.indexPrefixuseComposableTemplate(...)indexProperties(...)indexTemplate(...)indexPattern(...)indexTemplateClosing(...)/** Templatized due to version differences. Only fields used in search are declared */beginTemplate(...)String traceIdMappingendTemplate(...)maybeWrap(...)// BodyConverters KEY// The key filed of a autocompleteKeys is intentionally names as tagKey since it clashes with theautocompleteTemplate(...)dependencyTemplate(...)spanIndexTemplate(...)/** This returns a delimiter based on what's supported by the Elasticsearch version. ... */// 6.x _all disabled https://www.elastic.co/guide/en/elasticsearch/reference/6.7/breaking-changes-6.0.html#_the_literal__all_literal_meta_field_is_now_disabled_by_default// 7.x _default disallowed https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.0.html#_the_literal__default__literal_mapping_is_no_longer_allowed// Supporting mixed trace ID length is expensive due to needing a special analyzer and// "fielddata" which consumes a lot of heap. Sites should only turn off strict trace ID when// in a transition, and keep trace ID length transitions as short time as possible.// ES 7.x defaults include_type_name to false https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking-changes-7.0.html#_literal_include_type_name_literal_now_defaults_to_literal_false_literalimport JsonNodeimport PooledByteBufAllocatorimport QueryStringEncoderimport ElasticsearchVersionimport static JsonSerializers.OBJECT_MAPPER// exposed to re-use for testing writes of dependency links// See https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.htmlnew ArrayList<IndexEntry<?>>(...)new BodyConverter<Void>(...) { ... }RuntimeException toThrowJsonNode rootreadTree(...)textValue(...)findPath(...)Number statusnumberValue(...)booleanValue(...)at(...)isObject(...)intValue(...)BodyConverter<Void> CHECK_FOR_ERRORS, ...;// https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html// status is success. The status codes expected to be returned were undocumented as of version 7.2// This mapper is invoked under the assumption that bulk requests return errors even when the httpString tag, ...;boolean shouldAddType, ...;HttpCall<>.Factory http, ...;boolean waitForRefresh, ...;List<IndexEntry<?>> entries, ...;// Mutated for each call to indexthis.tagnew AutoValue_BulkCallBuilder_IndexEntry<T>(...)newIndexEntry(...)/** Creates a bulk request when there is more than one object to store */QueryStringEncoder urlBuildernew QueryStringEncoder(...)ByteBufAllocator allocnew Function<RequestContext,ByteBufAllocator>(...) { ... }new Supplier<ByteBufAllocator>(...) { ... }PooledByteBufAllocator.DEFAULTHttpCall<>.RequestSupplierRequestSupplier requestnew BulkRequestSupplier(...)addParam(...)RequestHeaders headers, ...;ByteBufAllocator alloc, ...;this.entriesthis.shouldAddTypethis.headersthis.allocHttpCall<>.RequestStreamIndexEntry<?> entrytryWrite(...)serialize(...)ByteBuf documentheapBuffer(...)ByteBuf metadataString idwriteDocument(...)writer(...)input(...)ByteBuf payloadioBuffer(...)writeIndexMetadata(...)throwUnsafely(...)JsonGenerator writerjsonGenerator(...)typeName(...)// only throw when we know it is an error// All use of jackson throws// Stream aborted, no need to serialize anymore.// Fuzzily assume a general small span is 600 bytes to reduce resizing while building up the// JSON. Any extra bytes will be released back after serializing the document.// the _type parameter is needed for Elasticsearch < 6.x// No I/O writing to a Buffer.import ByteBufUtilimport MessageDigestnew BulkIndexWriter<Span>(...) { ... }new BulkIndexWriter<Entry<String,String>>(...) { ... }writeAutocompleteEntry(...)/** Write a complete json document according to index strategy and returns the ID field. */BulkIndexWriter<Span> SPAN, ...;BulkIndexWriter<Span> SPAN_SEARCH_DISABLED, ...;BulkIndexWriter<Entry<String,String>> AUTOCOMPLETE, ...;/** In order to allow systems like Kibana to search by timestamp, we add a field "timestamp_millis" ... */int startIndexwriterIndex(...)ByteBuf sliceslice(...)addSearchFields(...)writeFieldName(...)writeArrayFieldStart(...)Iterator<Entry<String,String>> tagsmd5(...)long timestampMillisMessageDigest messageDigestNoSuchAlgorithmException eupdate(...)hexDump(...)digest(...)// Id is used to dedupe server side as necessary. Arbitrarily same format as _q value.// get a slice representing the document we just wrote so that we can make a content hashimport DateTimeFormatterimport GregorianCalendarimport static LocalDateTime.ofInstantimport static Calendar.DAY_OF_MONTH/** <h3>Index-Prefix/type delimiter</h3> ... */AutoValue_IndexNameFormatter.Builderchar separatorString formatautoBuild(...)dateFormat(...)withZone(...)ofPattern(...)/** Returns a set of index patterns that represent the range provided. Notably, this compresses ... */GregorianCalendar currentGregorianCalendar endString prefixprefix(...)Calendar.JANUARYCalendar.MONTHCalendar.DAY_OF_YEARgetActualMaximum(...)Calendar.YEARformatIndexPattern(...)GregorianCalendar resultnew GregorianCalendar(...)/** On insert, require a version-specific index-type delimiter as ES 7+ dropped colons */ofInstant(...)// attempt to compress a year// rollover to next year// rollback to first of the year// attempt to compress a month// rollover to next month// try to compress days 0-9// rollover to day 10// set back to day 1// try to compress days 10-19// rollover to day 20// set back to day 10// try to compress days 20-29// rollover to day 30// set back to day 20// We use single-character wildcard here in order to read both : and - as starting in ES 7, :// is no longer permitted./** Escalate internal APIs so they can be used from outside packages. The only implementation is in ... */Internal instance, ...;/** Utilities used here aim to reduce allocation overhead for common requests. It does so by skipping ... *//** Navigates to a field of a JSON-serialized object. For example, ... */JsonToken valuecheckStartObject(...)JsonToken.END_OBJECTnextValue(...)getCurrentName(...)JsonToken.VALUE_NULLskipChildren(...)visitObject(...)visitNextOrSkip(...)currentToken(...)JsonToken tokenJsonToken.END_ARRAYJsonToken currentToken// End of input so ignore.// Skip current value.// The parser may not be at a token, yet. If that's the case advance.// If we are still not at the expected token, we could be an another or an empty body.// likely not jsonimport JsonIncludeimport ObjectMapper/** JSON serialization utilities and parsing code. */setSerializationInclusion(...)new ObjectMapper(...)JsonInclude.Include.NON_NULLJsonInclude.Includenew ObjectParser<Span>(...) { ... }parseSpan(...)new ObjectParser<DependencyLink>(...) { ... }isExpectedStartObjectToken(...)currentName(...)getLongValue(...)ObjectMapper OBJECT_MAPPER, ...;ObjectParser<Span> SPAN_PARSER, ...;parseEndpoint(...)JsonToken.START_ARRAYparseAnnotation(...)getValueAsString(...)getBooleanValue(...)String ipv4String ipv6getIntValue(...)ObjectParser<DependencyLink> DEPENDENCY_LINK_PARSER, ...;// SkipString field, ...;AggTerms terms, ...;Map<String,String> min, ...;Map<String,Aggregation> aggs, ...;this.fieldAggregation resultnew Aggregation(...)result.termsnew AggTerms(...)result.minthis.sizeMap<String,String> order, ...;new LinkedHashMap<String,Aggregation>(...)agg.fieldimport Clientsimport UnprocessedRequestExceptionimport HttpRequestWriterimport HttpStatusClassimport EventExecutorimport CompletionExceptionimport static JsonSerializers.JSON_FACTORY/** Prefer using the {@code parser} for request-scoped conversions. Typically, {@code ... *//** A request stream which can have {@link HttpData} of the request body written to it. *//** Writes the {@link HttpData} to the stream. Returns {@code false} if the stream has been ... *//** A supplier of {@linkplain HttpHeaders headers} and {@linkplain HttpData body} of a request to ... *//** Returns the {@linkplain HttpHeaders headers} for this request. *//** Writes the body of this request into the {@link RequestStream}. {@link ... */AggregatedHttpRequest request, ...;isPooled(...)trailers(...)WebClient httpClient, ...;this.httpClientnew HttpCall<V>(...)new AggregatedRequestSupplier(...)RequestSupplier request, ...;// Visible for benchmarksBodyConverter<V> bodyConverter, ...;CompletableFuture<AggregatedHttpResponse> responseFuture, ...;this.bodyConverterEventExecutor eventLoopeventLoopGroup(...)inEventLoop(...)sendRequest(...)CompletionException eparseResponse(...)V valueCompletableFuture<AggregatedHttpResponse> responseFuturethis.responseFuturenew HttpCall(...)new Function<RequestContext,CompletableFuture<AggregatedHttpResponse>>(...) { ... }new Supplier<CompletableFuture<AggregatedHttpResponse>>(...) { ... }SafeCloseable ignoredwithContextCustomizer(...)new Consumer<ClientRequestContext>(...) { ... }HttpRequestWriter httpRequeststreaming(...)writeBody(...)new RequestStream(...) { ... }exceptionally(...)new Function<Throwable,AggregatedHttpResponse>(...) { ... }HttpStatus statuscodeClass(...)HttpStatusClass.SUCCESSnew FileNotFoundException(...)HttpStatusClass.CLIENT_ERRORHttpStatusClass.SERVER_ERRORnew BodyConverter<V>(...) { ... }toInputStream(...)toStringUtf8(...)// Unfortunately it's not possible to use pooled objects in requests and support clone()// after sending the request.// TODO: testme// Unreachable// This should never be used in practice since the module runs in an Armeria server.// Go ahead and reduce the output in logs since this is usually a configuration or// infrastructure issue and the Armeria stack trace won't help debugging that.// Handle the case where there is no content, as that means we have no resources to release.// If this is a client or server error, we look for a json message.import JsonProcessingExceptionthis.httpHttpCall<>.BodyConverter<V>AggregatedHttpRequest httpRequestlenientSearch(...)request.indicesrequest.typewriteValueAsBytes(...)JsonProcessingException e/** Matches the behavior of {@code IndicesOptions#lenientExpandOpen()} */import JsonPropertynew SearchRequest(...)int MAX_RESULT_WINDOW, ...;/** The maximum results returned in a query. This only affects non-aggregation requests. ... */// the default elasticsearch allowed limitString type, ...;Integer size, ...;Boolean _source, ...;Object query, ...;new Range(...)new Term(...)query(...)new BoolQuery(...)new Terms(...)Map<String,String> term, ...;Map<String,Collection<String>> terms, ...;this.termsMap<String,Bounds> range, ...;new Bounds(...)long from, ...;Long to, ...;boolean include_lower, ...;boolean include_upper, ...;this.fromthis.toMap<String,Object> bool, ...;// we return aggs, not source dataimport ObjectParserHttpCall<>.BodyConverter<List<T>>ObjectParser<T> adapter, ...;new SearchResultConverter<T>(...)this.adapterJsonParser hitsList<T> resultisExpectedStartArrayToken(...)JsonParser sourceTestResponses.AUTOCOMPLETE_VALUESAggregatedHttpResponse SUCCESS_RESPONSE, ...;ElasticsearchAutocompleteTags tagStore, ...;new LazyHttpClient(...) { ... }// note: we don't enqueue a request!Endpoint WEB_ENDPOINT, ...;Endpoint APP_ENDPOINT, ...;SpanConsumer spanConsumer, ...;Span serverSpantoMicros(...)/** Much simpler template which doesn't write the timestamp_millis field *//** Less overhead as a span json isn't rewritten to include a millis timestamp */HttpStatus.INTERNAL_SERVER_ERRORRuntimeException expected// gets the index template so that each test doesn't have to// get span template// get dependency template// get tags template// get version// make sure that both timestamps are in the index/* 1971-01-01 */// sanity check data// index timestamp is the server timestamp, not current time!// put span template// for the bulk request// skip first// the tag is in the same date range as the other, so it should not write the tag again// different day == different context// We only cache when there was no error.. the second request should be same as the firstAggregatedHttpResponse EMPTY_RESPONSE, ...;ElasticsearchSpanStore spanStore, ...;TestResponses.SERVICE_NAMESrequestLimitedTo2DaysOfIndices_singleTypeIndex(...)TestResponses.SPAN_NAMESElasticsearchSpanStore spanStorelong todaylong yesterdayString indexesToSearch// skip template check// 24 hrs ago always will fall into 2 days (ex. if it is 4:00pm, 24hrs ago is a different day)import EndpointGroupExceptionHttpStatus.UNAUTHORIZEDtoEpochMilli(...)AggregatedHttpResponse HEALTH_RESPONSE, ...;AggregatedHttpResponse RESPONSE_UNAUTHORIZED, ...;AggregatedHttpResponse RESPONSE_VERSION_6, ...;// makes sure we don't NPEstorage.ensuredTemplates// TODO: when Armeria's mock server supports it, add a test for IOException/** See {@link HttpCallTest#unprocessedRequest()} which shows {@link UnprocessedRequestException} ... */new EndpointGroupException(...)/** Ensure that Zipkin uses the legacy resource path when priority is not set. *//** Ensure that Zipkin uses the correct resource path of /_index_template when creating index ... */// dependencies request// below is actual message from Amazon// Later checks do not redo index template requests// empty instead of version json// assume index templates called before// empty instead of success response// timeout// top-level// re-wrapped// get autocomplete template// cluster health// // get dependency template// Set up a new storage with priorityimport static ElasticsearchStorageTest.RESPONSE_UNAUTHORIZEDElasticsearchVersion V2_4, ...;ElasticsearchVersion V6_7, ...;AggregatedHttpResponse VERSION_RESPONSE_7, ...;AggregatedHttpResponse VERSION_RESPONSE_6, ...;AggregatedHttpResponse VERSION_RESPONSE_5, ...;AggregatedHttpResponse VERSION_RESPONSE_2, ...;/** Unsupported, but we should test that parsing works *//** Prove we compare better than a float. A float of 7.10 is the same as 7.1! *//** Package accessor for integration tests */new BulkIndexWriter<DependencyLink>(...) { ... }BulkCallBuilder indexerBulkIndexWriter<DependencyLink> DEPENDENCY_LINK_WRITER, ...;import JsonReaders// All elasticsearch results start with an object, not an array.List<String> resultimport static JsonSerializers.SPAN_PARSER/** This isn't a test of what we "should" accept as a span, rather that characters that trip-up ... */Endpoint eSpan worstSpanInTheWorldString with128BitTraceIdString withLower64bitsTraceIdJsonSerializers.ObjectParser<T>JsonParser jsonParserJsonSerializers.JSON_FACTORY// service name is surrounded by control characters// name is terrible// annotation value includes some json newline characters// binary annotation key includes a quote and value newlinesimport static TestResponses.SPANSSearchResultConverter<Span> converter, ...;long stableMicrosList<Span> stableTracenew Function<Span,Span>(...) { ... }fail(...)// to access package private stuff// Our normal test data has recent timestamps to make testing the server and dependency linker// work as there are values related to recency used in search defaults.// This test needs stable timestamps because items like MD5 need to match.// can't result in a zero value, so minimum ts of 1.String SPANS, ...;String SERVICE_NAMES, ...;String SPAN_NAMES, ...;String AUTOCOMPLETE_VALUES, ...;WebClient.classElasticsearchVersion V7_9, ...;IndexTemplates template// doesn't wrap in a type nameimport WebClientBuilderimport static IgnoredDeprecationWarnings.IGNORE_THESE_WARNINGSElasticsearchExtension.classElasticsearchContainer container, ...;new ElasticsearchContainer(...)WebClientBuilder buildernew Function<AggregatedHttpResponse,HttpResponse>(...) { ... }String warningHeadernoneMatch(...)new Predicate<Pattern>(...) { ... }parseBoolean(...)getenv(...)new ElasticsearchStorage.LazyHttpClient(...) { ... }ElasticsearchStorage.LazyHttpClientendpointGroup(...)// Elasticsearch 7 never returns a response when receiving an HTTP/2 preface instead of the// more valid behavior of returning a bad request response, so we can't use the preface.// ES will return a 'warning' response header when using deprecated api, detect this and// fail early so we can do something about it.// Example usage: https://github.com/elastic/elasticsearch/blob/3049e55f093487bb582a7e49ad624961415ba31c/x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/integration/IndexPrivilegeIntegTests.java#L559// Convert AggregatedHttpResponse back to HttpResponse.// When ES_DEBUG=true log full headers, request and response body to the category// com.linecorp.armeria.client.loggingimport InternalForTestsimport static ElasticsearchExtension.indexITElasticsearchStorage.classcomputeStorageBuilder(...)elasticsearch(...)aggregateDependencies(...)WebClient webClientcontentAscii(...)new ElasticsearchExtension(...)ElasticsearchExtension elasticsearch, ...;import static HttpHeaderNames.CONTENT_TYPEimport static HttpMethod.DELETEimport static HttpMethod.PUTimport static MediaType.JSON_UTF_8setUpCatchAllTemplate(...)checkStorage(...)assertGetTracesReturns(...)catchAllIndexPath(...)/** Create a "catch-all" index template with the lowest priority prior to running tests to ensure ... */catchAllTemplate(...)/** Catch-all template doesn't store source */// We need a different index pattern per test// Delete all templates in order to create the "catch-all" index template, because// ES does not allow multiple index templates of the same index_patterns and priority// Implicitly creates an index template// Get all templates. We don't assert on this at the moment. This is for logging on ES_DEBUG.// Now, add a span, which should be indexed differently than default.// Assert that Zipkin's templates work and source is returned// Delete "catch-all" index template so it does not interfere with any other testimport static Pattern.compile/** When ES emits a deprecation warning header in response to a method being called, the integration ... */List<Pattern> IGNORE_THESE_WARNINGS, ...;// warning header for it to be ignored// These will be matched using header.contains(ignored[i]), so find a unique substring of theimport static BulkCallBuilder.CHECK_FOR_ERRORSString responseSpan STABLE_SPAN, ...;// to have a fixed span here to avoid depending on business logic in test assertions.// Our usual test span depends on currentTime for testing span stores with TTL, but we'd preferByteBufOutputStream buffer, ...;StandardCharsets.UTF_8// ignores timestamp_millis fieldimport DateFormatimport ParseExceptionimport SimpleDateFormatnew SimpleDateFormat(...)IndexNameFormatter formatter, ...;DateFormat iso8601, ...;setTimeZone(...)long startgetTime(...)long endimport static MediaType.PLAIN_TEXT_UTF_8import static Assertions.failHttpCall<>.BodyConverter<Object> NULL, ...;HttpCall<>.BodyConverter<Object>AggregatedHttpRequest REQUEST, ...;HttpCall<String> callnew BodyConverter<String>(...) { ... }CompletableCallback<String> futurenew CompletableCallback<String>(...)LinkedBlockingQueue<Object> qnew LinkedBlockingQueue<Object>(...)new Callback<Object>(...) { ... }new LinkageError(...)Call<?> callFileNotFoundException.classByteBuf encodedBufHttpStatus.FORBIDDENHttpCall<Object> callrefCnt(...)// For simplicity, we also parse messages from AWS Elasticsearch, as it prevents copy/paste.Map<AggregatedHttpResponse,String> responseToMessagenew LinkedHashMap<AggregatedHttpResponse,String>(...)HttpStatus.BAD_GATEWAYEntry<AggregatedHttpResponse,String> entryMap<>.Entry<AggregatedHttpResponse,String>AtomicReference<RequestLog> lognew AtomicReference<RequestLog>(...)doesNotHaveValue(...)String bodyHttpStatus.BAD_REQUESTRequestSupplier suppliernew HttpCall<>.RequestSupplier(...) { ... }// TODO(adriancole): Find a home for this generic conversion between Call and Java 8.// to access package-private stuff// It can take some time for the HTTP response to process. Wait until we reach the parser// Wait a little longer for a callback to fire (it should never do this)// Force this to be a ref-counted response// Invoke the parser directly because using the fake server will not result in ref-counted// note: not json// In this case, we give request context// depending on JDK this is "OPENSSL_internal" or "not an SSL/TLS record"SearchCallFactory client, ...;/** Declaring queries alphabetically helps simplify amazon signature logic */SearchRequest request, ...;request.size/** Indices and type affect the request URI, not the json body */writeValueAsString(...)ElasticsearchStorage.LazyHttpClient lazyHttpClient, ...;boolean flushOnWrites, ...;int indexShards, ...;boolean ensureTemplates, ...;this.lazyHttpClientthis.flushOnWritesElasticsearchStorage thatBoolean flushOnWrites, ...;Boolean strictTraceId, ...;Boolean searchEnabled, ...;Integer autocompleteTtl, ...;Integer autocompleteCardinality, ...;IndexNameFormatter.Builder indexNameFormatterBuilder$, ...;Integer namesLookback, ...;Builder indexNameFormatter$buildernew AutoValue_ElasticsearchStorage(...)ElasticsearchVersion version, ...;String dependency, ...;String autocomplete, ...;this.versionthis.autocompleteIndexTemplates thatIndexTemplates.BuilderCharacter indexTypeDelimiter, ...;new AutoValue_IndexTemplates(...)BulkCallBuilder.IndexEntry<T>String typeName, ...;T input, ...;BulkIndexWriter<T> writer, ...;this.typeNamethis.writerBulkCallBuilder.IndexEntry<>BulkCallBuilder.IndexEntry<?>IndexEntry<?> thatchar dateSeparator, ...;DateTimeFormatter dateFormat, ...;this.dateFormatIndexNameFormatter thatCharacter dateSeparator, ...;new AutoValue_IndexNameFormatter(...)import Cursorimport DSLContextimport Recordimport Record1import SelectConditionStepimport static ZipkinAnnotations.ZIPKIN_ANNOTATIONSimport static ZipkinSpans.ZIPKIN_SPANSSchema schema, ...;long startTsBegin, ...;this.schemathis.startTsBeginthis.startTsEndSelectConditionStep<Record1<Long>> traceIDswhere(...)p20p21selectDistinct(...)ZIPKIN_SPANS.TRACE_IDlessOrEqual(...)between(...)ZIPKIN_SPANS.START_TSCursor<Record> cursorfetchLazy(...)groupBy(...)schema.dependencyLinkerGroupByFieldsin(...)and(...)schema.dependencyLinkerFieldson(...)leftJoin(...)ZIPKIN_ANNOTATIONS.TRACE_IDZIPKIN_SPANS.IDZIPKIN_ANNOTATIONS.SPAN_IDZIPKIN_ANNOTATIONS.A_KEYIterator<Iterator<Span>> tracesnew ByTraceId(...)DependencyLinkV2SpanIterator.ByTraceIdschema.hasTraceIdHighDependencyLinker linkerList<Span> nextTrace// Subquery on trace IDs to prevent only matching the part of the trace that exists within// the interval: we want all of the trace.// Lazy fetching the cursor prevents us from buffering the whole dataset in memory.// left joining allows us to keep a mapping of all span ids, not just ones that have// special annotations. We need all span ids to reconstruct the trace tree. We need// the whole trace tree so that we can accurately skip local spans.// NOTE: we are intentionally grouping only on the low-bits of trace id. This// buys time for applications to upgrade to 128-bit instrumentation.// Grouping so that later code knows when a span or trace is finished.import SQLDialectimport Settingsimport DSLimport DefaultConfigurationSettings settings, ...;ExecuteListenerProvider listenerProvider, ...;this.settingsthis.listenerProviderusing(...)SQLDialect.MYSQLnew DefaultConfiguration(...)import SQLException/** Uncancelable call built with an executor */DataSource datasource, ...;DSLContexts context, ...;this.datasourcenew DataSourceCall<V>(...)Function<DSLContext,V> queryFunction, ...;this.queryFunctionConnection conngetConnection(...)factory.datasourceDSLContext contextfactory.contextSQLException efactory.executornew CallbackRunnable(...)new DataSourceCall(...)// unwrap the exceptionimport TableFieldimport ZipkinSpansimport static Schema.maybeGet/** Lazy converts rows into {@linkplain Span} objects suitable for dependency links. This takes ... *//** Assumes the input records are sorted by trace id, span id */PeekingIterator<Record> delegate, ...;boolean hasTraceIdHigh, ...;long currentTraceIdHi, ...;new PeekingIterator<Record>(...)this.hasTraceIdHighZipkinSpans.ZIPKIN_SPANS.TRACE_IDZipkinSpans.ZIPKIN_SPANSnew DependencyLinkV2SpanIterator(...)long traceIdHi, ...;this.traceIdHithis.traceIdLoRecord rowlong spanIdZipkinSpans.ZIPKIN_SPANS.IDboolean errorString lcServiceString srServiceString csServiceString caServiceString saServiceString maServiceString mrServiceString msServicelong parentIdmaybeGet(...)ZipkinSpans.ZIPKIN_SPANS.PARENT_IDRecord nextZIPKIN_ANNOTATIONS.ENDPOINT_SERVICE_NAMEV1BinaryAnnotation.TYPE_STRINGZIPKIN_ANNOTATIONS.A_TYPEep(...)ZipkinSpans.ZIPKIN_SPANS.TRACE_ID_HIGH// there are more values for this trace// if we are in a new span// row for the same span// neither client nor server// a span is in error if it has a tag, not an annotation, of name "error"// The client address is more authoritative than the client send owner.// Finagle labels two sides of the same socket ("ca", "sa") with the same name.// Skip the client side, so it isn't mistaken for a loopback request/* actual value doesn't matter */// When span.kind is missing, the local endpoint is "lc" and the remote endpoint is "sa"import DataAccessExceptionimport static ZipkinDependencies.ZIPKIN_DEPENDENCIESHasErrorCount.classDSLContext dslfetchAny(...)select(...)ZIPKIN_DEPENDENCIES.ERROR_COUNTDataAccessException esqlState(...)problemReading(...)Level.WARNINGHasIpv6.classZIPKIN_ANNOTATIONS.ENDPOINT_IPV6import static DSL.count/** Returns true when the zipkin_dependencies table exists and has data in it, implying the spark job ... */HasPreAggregatedDependencies.classvalue1(...)HasRemoteServiceName.classString MESSAGE, ...;ZIPKIN_SPANS.REMOTE_SERVICE_NAMEHasTraceIdHigh.classZIPKIN_SPANS.TRACE_ID_HIGHDataSourceCall<>.Factory dataSourceCallFactory, ...;DataSourceCall<>.FactoryLinkedHashSet<String> autocompleteKeys, ...;this.dataSourceCallFactorystorage.dataSourceCallFactoryimport InsertSetMoreStepimport Query...[] ONE, ...;new BatchInsertSpans(...)List<Query> insertsnew ArrayList<Query>(...)V2SpanConverter v2SpanConverterSpan v2InsertSetMoreStep<Record> insertSpanZIPKIN_SPANS.DEBUGinsertInto(...)Map<TableField<Record,?>,Object> updateFieldsnew LinkedHashMap<TableField<Record,?>,Object>(...)long traceIdHighupdateName(...)ZIPKIN_SPANS.NAMEschema.hasRemoteServiceNameZIPKIN_SPANS.DURATIONZIPKIN_SPANS.PARENT_IDonDuplicateKeyIgnore(...)onDuplicateKeyUpdate(...)InsertSetMoreStep<Record> insertZIPKIN_ANNOTATIONS.A_TIMESTAMPZIPKIN_ANNOTATIONS.TRACE_ID_HIGHaddEndpoint(...)V1BinaryAnnotation batype(...)ZIPKIN_ANNOTATIONS.A_VALUEEndpoint nextEpbatch(...)ZIPKIN_ANNOTATIONS.ENDPOINT_IPV4schema.hasIpv6ZIPKIN_ANNOTATIONS.ENDPOINT_PORT// tentatively we can use even a shared timestamp// replace any tentative timestamp with the authoritative one.// add the address annotation// TODO: See if DSLContext.batchMerge() can be used to avoid some of the complexity// https://github.com/jOOQ/jOOQ/issues/3172// old code wrote empty service names// old code wrote empty span nameimport static DateUtil.epochDaysSelectSpansAndAnnotations.Factory selectFromSpansAndAnnotationsFactory, ...;SelectSpansAndAnnotations.FactoryDataSourceCall<List<String>> getServiceNamesCall, ...;this.selectFromSpansAndAnnotationsFactorythis.getServiceNamesCallnew SelectAnnotationServiceNames(...)DataSourceCall<List<Span>> resultSet<Pair> traceIdPairsnew LinkedHashSet<Pair>(...)String hexTraceIdschema.hasPreAggregatedDependenciesnew AggregateDependencies(...)withRenderSchema(...)new Settings(...)new MySQLStorage(...)MySQLStorage.Builderbuilder.executorbuilder.datasourcenew DSLContexts(...)builder.settingsbuilder.listenerProvider/** Returns the session in use by this storage component. *//** Lazy to avoid eager I/O */new Schema(...)new MySQLSpanStore(...)schema(...)new MySQLAutocompleteTags(...)new MySQLSpanConsumer(...)/** Visible for testing */truncate(...)// didn't open the DataSource or executorlong left, ...;/** adapted from guava's {@code com.google.common.collect.AbstractIterator}. */State.NOT_READYIterator<T> delegate, ...;PeekingIterator<>.State state, ...;PeekingIterator<>.StateT next, ...;endOfData(...)State.DONEtryToComputeNext(...)computeNext(...)State.READYnew State(...)State READY, ...;/** We have computed the next element and haven't returned it yet. */State NOT_READY, ...;/** We haven't yet computed or have already returned the element. */State DONE, ...;/** We have reached the end of the data and are finished. */import Fieldimport Resultimport Row2import SelectOffsetStepimport ZipkinAnnotationsimport static DSL.rowList<Field<?>> spanIdFields, ...;List<Field<?>> spanFields, ...;List<Field<?>> annotationFields, ...;List<Field<?>> dependencyLinkerFields, ...;List<Field<?>> dependencyLinkerGroupByFields, ...;List<Field<?>> dependencyLinkFields, ...;boolean hasPreAggregatedDependencies, ...;boolean hasIpv6, ...;boolean hasErrorCount, ...;boolean hasRemoteServiceName, ...;list(...)fields(...)new ArrayList<Field<?>>(...)annotationTable.TRACE_ID_HIGHannotationTable.TRACE_IDannotationTable.SPAN_ID/** Returns a mutable list */Result<? extends Record> resultfetch(...)List<Row2<Long,Long>> traceIdsnew ArrayList<Row2<Long,Long>>(...)Record rrow(...)List<Long> traceIdstraceIdCondition(...)boolean hasTraceIdHighPair traceIdtraceId.leftRow2<>[] resultnew Row2<>[]Pair traceId128traceId128.lefttraceId128.rightLong[] resultnew Long[]/** returns the default value if the column doesn't exist or the result was null */fieldsRow(...)T result// not used to recreate the spanlocalServiceNameCondition(...)ne(...)V1BinaryAnnotation.TYPE_BOOLEAN// exclude address annotationsimport Converternew Converter<byte[],String>(...) { ... }String autocompleteKey, ...;this.autocompleteKeyConverter<byte[],String> STRING_CONVERTER, ...;List<Long> epochDays, ...;this.epochDaysschema.dependencyLinkFieldsZIPKIN_DEPENDENCIES.DAYnew RecordMapper<Record,DependencyLink>(...) { ... }ZIPKIN_DEPENDENCIES.PARENTZIPKIN_DEPENDENCIES.CHILDZIPKIN_DEPENDENCIES.CALL_COUNTimport static SelectAnnotationServiceNames.localServiceNameConditionnotEqual(...)joinCondition(...)import Row3import SelectFieldimport TableOnConditionStepimport static Collectors.groupingByimport static DSL.maxlong finalTraceIdHighnew SelectSpansAndAnnotations(...) { ... }spanTraceIdCondition(...)toTraceIdQuery(...)Map<Pair,List<Builder>> spansWithoutAnnotationsMap<Row3<Long,Long,Long>,List<Record>> dbAnnotationsList<Span> allSpansgroupingBy(...)schema.spanFieldsnew Function<Record,Builder>(...) { ... }new Function<Builder,Pair>(...) { ... }new Supplier<LinkedHashMap<Pair,List<Builder>>>(...) { ... }asc(...)annotationsTraceIdCondition(...)schema.annotationFieldsnew Function<Record,Row3<Long,Long,Long>>(...) { ... }new Supplier<LinkedHashMap<Row3<Long,Long,Long>,List<Record>>>(...) { ... }List<Builder> spansBuilder spanRow3<Long,Long,Long> keyRecord aprocessAnnotationRecord(...)Integer typeString aKeybyte[] valuevalue.lengthTableOnConditionStep<?> tableList<SelectField<?>> distinctFieldsnew ArrayList<SelectField<?>>(...)schema.spanIdFieldsSelectConditionStep<Record> dslZipkinAnnotations aTablemaybeOnService(...)aTable.A_KEYaTable.A_TYPEaTable.A_VALUEgreaterOrEqual(...)desc(...)aTable.ENDPOINT_SERVICE_NAME// LinkedHashMap preserves order while grouping// address annotations require an endpoint// ensure we are only processing address annotations// address annotations are a single byte of 1// other values unsupportedimport Schemaimport CatalogImpl/** This class is generated by jOOQ. */Zipkin.ZIPKINnew DefaultCatalog(...)DefaultCatalog DEFAULT_CATALOG, ...;/** The reference instance of <code>DEFAULT_CATALOG</code> */Zipkin ZIPKIN, ...;/** The schema <code>zipkin</code>. *//** No further instances allowed *//* This file is generated by jOOQ. */import Indeximport OrderField/** A class modelling indexes of tables in zipkin. */createIndex(...)ZipkinAnnotations.ZIPKIN_ANNOTATIONSnew OrderField<>[]ZipkinAnnotations.ZIPKIN_ANNOTATIONS.A_KEYZipkinAnnotations.ZIPKIN_ANNOTATIONS.A_TYPEZipkinAnnotations.ZIPKIN_ANNOTATIONS.ENDPOINT_SERVICE_NAMEZipkinSpans.ZIPKIN_SPANS.NAMEZipkinSpans.ZIPKIN_SPANS.REMOTE_SERVICE_NAMEZipkinSpans.ZIPKIN_SPANS.START_TSZipkinAnnotations.ZIPKIN_ANNOTATIONS.TRACE_IDZipkinAnnotations.ZIPKIN_ANNOTATIONS.SPAN_IDZipkinAnnotations.ZIPKIN_ANNOTATIONS.TRACE_ID_HIGHZipkinAnnotations.ZIPKIN_ANNOTATIONS.A_TIMESTAMPIndex ZIPKIN_ANNOTATIONS_A_KEY, ...;// -------------------------------------------------------------------------// INDEX definitionsIndex ZIPKIN_ANNOTATIONS_A_TYPE, ...;Index ZIPKIN_ANNOTATIONS_ENDPOINT_SERVICE_NAME, ...;Index ZIPKIN_SPANS_NAME, ...;Index ZIPKIN_SPANS_REMOTE_SERVICE_NAME, ...;Index ZIPKIN_SPANS_START_TS, ...;Index ZIPKIN_ANNOTATIONS_TRACE_ID, ...;Index ZIPKIN_ANNOTATIONS_TRACE_ID_HIGH, ...;Index ZIPKIN_SPANS_TRACE_ID_HIGH, ...;Index ZIPKIN_ANNOTATIONS_TRACE_ID_HIGH_2, ...;Index ZIPKIN_ANNOTATIONS_TRACE_ID_HIGH_3, ...;import UniqueKeyimport ZipkinDependencies/** A class modelling foreign key relationships and constraints of tables in ... */createUniqueKey(...)new TableField<>[]ZipkinDependencies.ZIPKIN_DEPENDENCIESZipkinDependencies.ZIPKIN_DEPENDENCIES.DAYZipkinDependencies.ZIPKIN_DEPENDENCIES.PARENTZipkinDependencies.ZIPKIN_DEPENDENCIES.CHILDUniqueKey<Record> KEY_ZIPKIN_ANNOTATIONS_TRACE_ID_HIGH, ...;// UNIQUE and PRIMARY KEY definitionsUniqueKey<Record> KEY_ZIPKIN_DEPENDENCIES_PRIMARY, ...;UniqueKey<Record> KEY_ZIPKIN_SPANS_PRIMARY, ...;/** Convenience access to all tables in zipkin. */ZipkinAnnotations ZIPKIN_ANNOTATIONS, ...;/** The table <code>zipkin.zipkin_annotations</code>. */ZipkinDependencies ZIPKIN_DEPENDENCIES, ...;/** The table <code>zipkin.zipkin_dependencies</code>. */ZipkinSpans ZIPKIN_SPANS, ...;/** The table <code>zipkin.zipkin_spans</code>. */import Catalogimport Tableimport SchemaImplnew Zipkin(...)/** The reference instance of <code>zipkin</code> */DefaultCatalog.DEFAULT_CATALOGimport ForeignKeyimport Nameimport TableOptionsimport SQLDataTypeimport TableImplimport Indexesimport Keysimport ZipkincreateField(...)defaultValue(...)nullable(...)inline(...)SQLDataType.BIGINTVARCHAR(...)SQLDataType.BLOBSQLDataType.INTEGERBINARY(...)SQLDataType.SMALLINTnew ZipkinAnnotations(...)/** The reference instance of <code>zipkin.zipkin_annotations</code> *//** The class holding records for this type */Record.classTableField<Record,Long> TRACE_ID_HIGH, ...;/** The column <code>zipkin.zipkin_annotations.trace_id_high</code>. If non zero, this means the trace uses 128 bit traceIds instead of 64 bit */TableField<Record,Long> TRACE_ID, ...;/** The column <code>zipkin.zipkin_annotations.trace_id</code>. coincides with zipkin_spans.trace_id */TableField<Record,Long> SPAN_ID, ...;/** The column <code>zipkin.zipkin_annotations.span_id</code>. coincides with zipkin_spans.id */TableField<Record,String> A_KEY, ...;/** The column <code>zipkin.zipkin_annotations.a_key</code>. BinaryAnnotation.key or Annotation.value if type == -1 */TableField<Record,byte[]> A_VALUE, ...;/** The column <code>zipkin.zipkin_annotations.a_value</code>. BinaryAnnotation.value(), which must be smaller than 64KB */TableField<Record,Integer> A_TYPE, ...;/** The column <code>zipkin.zipkin_annotations.a_type</code>. BinaryAnnotation.type() or -1 if Annotation */TableField<Record,Long> A_TIMESTAMP, ...;/** The column <code>zipkin.zipkin_annotations.a_timestamp</code>. Used to implement TTL; Annotation.timestamp or zipkin_spans.timestamp */TableField<Record,Integer> ENDPOINT_IPV4, ...;/** The column <code>zipkin.zipkin_annotations.endpoint_ipv4</code>. Null when Binary/Annotation.endpoint is null */TableField<Record,byte[]> ENDPOINT_IPV6, ...;/** The column <code>zipkin.zipkin_annotations.endpoint_ipv6</code>. Null when Binary/Annotation.endpoint is null, or no IPv6 address */TableField<Record,Short> ENDPOINT_PORT, ...;/** The column <code>zipkin.zipkin_annotations.endpoint_port</code>. Null when Binary/Annotation.endpoint is null */TableField<Record,String> ENDPOINT_SERVICE_NAME, ...;/** The column <code>zipkin.zipkin_annotations.endpoint_service_name</code>. Null when Binary/Annotation.endpoint is null */comment(...)table(...)/** Create an aliased <code>zipkin.zipkin_annotations</code> table reference *//** Create a <code>zipkin.zipkin_annotations</code> table reference */Indexes.ZIPKIN_ANNOTATIONS_A_KEYIndexes.ZIPKIN_ANNOTATIONS_A_TYPEIndexes.ZIPKIN_ANNOTATIONS_ENDPOINT_SERVICE_NAMEIndexes.ZIPKIN_ANNOTATIONS_TRACE_IDIndexes.ZIPKIN_ANNOTATIONS_TRACE_ID_HIGHIndexes.ZIPKIN_ANNOTATIONS_TRACE_ID_HIGH_2Indexes.ZIPKIN_ANNOTATIONS_TRACE_ID_HIGH_3Keys.KEY_ZIPKIN_ANNOTATIONS_TRACE_ID_HIGH/** Rename this table */SQLDataType.LOCALDATEnew ZipkinDependencies(...)/** The reference instance of <code>zipkin.zipkin_dependencies</code> */TableField<Record,LocalDate> DAY, ...;/** The column <code>zipkin.zipkin_dependencies.day</code>. */TableField<Record,String> PARENT, ...;/** The column <code>zipkin.zipkin_dependencies.parent</code>. */TableField<Record,String> CHILD, ...;/** The column <code>zipkin.zipkin_dependencies.child</code>. */TableField<Record,Long> CALL_COUNT, ...;/** The column <code>zipkin.zipkin_dependencies.call_count</code>. */TableField<Record,Long> ERROR_COUNT, ...;/** The column <code>zipkin.zipkin_dependencies.error_count</code>. *//** Create an aliased <code>zipkin.zipkin_dependencies</code> table reference *//** Create a <code>zipkin.zipkin_dependencies</code> table reference */Keys.KEY_ZIPKIN_DEPENDENCIES_PRIMARYSQLDataType.BITnew ZipkinSpans(...)/** The reference instance of <code>zipkin.zipkin_spans</code> *//** The column <code>zipkin.zipkin_spans.trace_id_high</code>. If non zero, this means the trace uses 128 bit traceIds instead of 64 bit *//** The column <code>zipkin.zipkin_spans.trace_id</code>. */TableField<Record,Long> ID, ...;/** The column <code>zipkin.zipkin_spans.id</code>. */TableField<Record,String> NAME, ...;/** The column <code>zipkin.zipkin_spans.name</code>. */TableField<Record,String> REMOTE_SERVICE_NAME, ...;/** The column <code>zipkin.zipkin_spans.remote_service_name</code>. */TableField<Record,Long> PARENT_ID, ...;/** The column <code>zipkin.zipkin_spans.parent_id</code>. */TableField<Record,Boolean> DEBUG, ...;/** The column <code>zipkin.zipkin_spans.debug</code>. */TableField<Record,Long> START_TS, ...;/** The column <code>zipkin.zipkin_spans.start_ts</code>. Span.timestamp(): epoch micros used for endTs query and to implement TTL */TableField<Record,Long> DURATION, ...;/** The column <code>zipkin.zipkin_spans.duration</code>. Span.duration(): micros used for minDuration and maxDuration query *//** Create an aliased <code>zipkin.zipkin_spans</code> table reference *//** Create a <code>zipkin.zipkin_spans</code> table reference */Indexes.ZIPKIN_SPANS_NAMEIndexes.ZIPKIN_SPANS_REMOTE_SERVICE_NAMEIndexes.ZIPKIN_SPANS_START_TSIndexes.ZIPKIN_SPANS_TRACE_ID_HIGHKeys.KEY_ZIPKIN_SPANS_PRIMARYimport Record7import static V1BinaryAnnotation.TYPE_BOOLEANimport static V1BinaryAnnotation.TYPE_STRINGLong traceIdHigh, ...;long traceId, ...;Long parentId, ...;long spanId, ...;/** You cannot make a dependency link unless you know the the local or peer endpoint. */DependencyLinkV2SpanIterator iteratornewRecord(...)/** The linker is biased towards server spans, or client spans that know the peer localEndpoint(). *//** "sr" is only applied when the local span is acting as a server *//** "ca" indicates the peer, which is a client in the case of a server span *//** "cs" indicates the peer, which is a client in the case of a server span *//** "ca" is more authoritative than "cs" *//** Finagle labels two sides of the same socket "ca", V1BinaryAnnotation.TYPE_BOOLEAN, "sa" with ... *//** Dependency linker works backwards: it is easier to treat a "cs" as a server span lacking its ... *//** Service links to empty string are confusing and offer no value. */// When there's no "sr" annotation, we assume it is a client.// When there is an "sr" annotation, we know it is a serverimport ZoneIdnew MySQLExtension(...)MySQLExtension mysql, ...;storage.datasourcestorage.context// batch insert the rows at timestamp midnightimport MariaDbDataSourceimport ContainerLessJdbcDelegateimport static ScriptUtils.runInitScriptnew MySQLContainer(...)MySQLExtension.classMySQLContainer container, ...;MySQLStorage resultdropAndRecreateSchema(...)result.datasource/** MySQL doesn't auto-install schema. However, we may have changed it since the last time this ... */String[] scriptsString scriptPathrunInitScript(...)new ContainerLessJdbcDelegate(...)MariaDbDataSource dataSourcenew MariaDbDataSource(...)setUser(...)setProperties(...)// Drop all previously created tables in zipkin.*// Populate the schemaDataSource dataSourceDataSource.classnew SQLException(...)SQLException.classcontainsOnlyOnce(...)DataSource datasourceimport SQLSyntaxErrorExceptionDataSource dataSource, ...;SQLSyntaxErrorException sqlExceptionnew SQLSyntaxErrorException(...)new DataAccessException(...)/** This returns false instead of failing when the SQLState code doesn't imply the column is ... */schema.hasErrorCount// cheats to lower mock count: this exception is really thrown during execution of the queryimport Record4Record4<Integer,Long,String,byte[]> annotationRecordannotationRecord(...)usingRecursiveComparison(...)createString(...)createAddress(...)value4(...)value3(...)value2(...)Record4<String,Integer,Short,byte[]> endpointRecordendpointRecord(...)import ThreadLocalRandomimport static Kind.CLIENTmapToObj(...)longs(...)new LongFunction<Span>(...) { ... }new IntFunction<Span[]>(...) { ... }long DAY, ...;/** Notably, the cassandra implementation has day granularity */long TODAY, ...;// Use real time, as most span-stores have TTL logic which looks back several days.Endpoint FRONTEND, ...;Endpoint BACKEND, ...;Endpoint DB, ...;Endpoint KAFKA, ...;Span CLIENT_SPAN, ...;/** Only for unit tests, not integration tests. Integration tests should use random trace IDs. */// storage query units are milliseconds, while trace data is microsecondsstartTs(...)Span.Builder SPAN_BUILDER, ...;/** Reuse a builder as it is significantly slows tests to create 100000 of these! */...[] LOTS_OF_SPANS, ...;/** Zipkin trace ids are random 64bit numbers. This creates a relatively large input to avoid ... */clearTags(...)Endpoint frontendsuffixServiceName(...)newTraceId(...)String prefixedEndpoint backendEndpoint dbbyte[] traceIdWriteBuffer buffer/** Base test for when {@link StorageComponent.Builder#autocompleteKeys(List)} has values. ... */import static Collectors.toListimport static TestObjects.endTsimport static TestObjects.midnightUTCimport static TestObjects.newTraceIdimport static TestObjects.startTsimport static TestObjects.suffixServiceName/** Base test for {@link SpanStore} implementations that support dependency aggregation. Subtypes ... *//** Override if dependency processing is a separate job: it should complete before returning from ... *//** Normally, the root-span is where trace id == span id and parent id == null. The default is to ... */processDependencies(...)containsExactlyInAnyOrderElementsOf(...)links(...)/** This tests that dependency linking ignores the high-bits of the trace ID when grouping spans ... */TestObjects.FRONTENDTestObjects.BACKENDList<Span> mixedTrace/** It should be safe to run dependency link jobs twice *//** Edge-case when there are no spans, or instrumentation isn't logging annotations properly. *//** When all servers are instrumented, they all record {@link Kind#SERVER} and the {@link ... */String frontendString backendString dbTestObjects.DBEndpoint oneEndpoint onePort3001Endpoint twoEndpoint twoPort3002Endpoint threeList<Span> traceWithLoopback/** Some systems log a different trace id than the root span. This seems "headless", as we won't ... */ArrayList<Span> trace/** Ensure complete traces are aggregated, even if they complete after endTs *//** This test confirms that the span store can detect dependency indicated by local and remote ... */Endpoint kafkaTestObjects.KAFKA/** This tests we error prior to executing the call. */SpanStore store/** This shows a missing parent still results in a dependency link when local endpoints change *//** This test shows that dependency links can be filtered at daily granularity. This allows the UI ... */long lookbacksubtractDay(...)/** This test confirms that the span store can process trace with intermediate spans like the below ... *//** Span starts on one host and ends on the other. In both cases, a response is neither sent nor ... *//** A timeline annotation named error is not a failed span. A tag/binary annotation is. *//** Async span starts from an uninstrumented source. *//** rebases a trace backwards a day with different trace. */long randomBuilder b/** Returns links aggregated by midnight */Map<Long,DependencyLinker> midnightToLinkernew LinkedHashMap<Long,DependencyLinker>(...)Map<Long,List<DependencyLink>> resultnew LinkedHashMap<Long,List<DependencyLink>>(...)long midnightOfTraceflooredTraceTimestamp(...)new BiConsumer<Long,DependencyLinker>(...) { ... }/** Default links produced by {@link TestObjects#newTrace(String)} *//** gets the timestamp in milliseconds floored to midnight */long currentTs// Defaults are fine.// bug if it were!// the server dropped traceIdHigh// missing an intermediate span// Let's pretend we have two days of data processed//  - Note: calling this twice allows test implementations to consider timestamps// A user looks at today's links.//  - Note: Using the smallest lookback avoids bumping into implementation around windowing.// A user compares the links from those a day ago.// A user looks at all links since data started// note there is no empty string service namesimport static TestObjects.DB/** Base heavy tests for {@link SpanStore} implementations that support dependency aggregation. ... *//** Ensure there's no query limit problem around links */int countEndpoint webEndpoint appallSatisfy(...)new ThrowingExtractor<DependencyLink,Long,RuntimeException>(...) { ... }new Consumer<Long>(...) { ... }// Larger than 10, which is the default ES search limit that tripped this// web-? -> app-?, app-? -> db-?/** Base test for when {@link StorageComponent.Builder#searchEnabled(boolean) searchEnabled == ... */assertGetTracesReturnsEmpty(...)names(...)/** Base test for {@link ServiceAndSpanNames}. ... */rangeClosed(...)new IntFunction<Span>(...) { ... }String suffixnew Iterable<String>(...) { ... }new Function<Span,String>(...) { ... }/** Ensures the service name index returns distinct results */String uppercasetoUpperCase(...)/** Ensures the span name index returns distinct results */// Assure a default store limit isn't hit by assuming if 50 are returned, all are returned/** Base test for {@link SpanStore}. ... *//** This would only happen when the store layer is bootstrapping, or has been purged. */Builder q/** This is unlikely and means instrumentation sends empty spans by mistake. */allShouldWorkWhenEmpty(...)assertGetTraceReturnsEmpty(...)Span traceASpan1Span traceASpan2String traceId2Span traceBSpan1Span traceBSpan2Span span1Span span3List<Endpoint> endpointsnew IntFunction<Endpoint>(...) { ... }long gapBetweenSpansSpan[] earlySpanstoHexString(...)Span[] lateSpansList<Span>[] earlyTracesnew Function<Span,List<Span>>(...) { ... }new IntFunction<List<>[]>(...) { ... }new List<>[]List<Span>[] lateTracesassertGetTracesReturnsCount(...)getTraces_serviceNames(...)getTraces_spanName(...)// pretend we had a late update of only timestamp/duration infoSpan lateDuration/** The following skeletal span is used in dependency linking. ... */Span errorSpanBuilder requestBuilder/** While large spans are discouraged, and maybe not indexed, we should be able to read them back. */char[] kilobyteOfText/** This tests problematic data that can sometimes break storage: ... */Span part1Span part2/** Shows that duration queries go against the root span, not the child */setupDurationData(...)List<Span> trace1List<Span> trace2List<Span> trace3/** Spans and traces are meaningless unless they have a timestamp. While unlikely, this could ... */Span spanWithoutTimestamp/** Prevents subtle bugs which can result in mixed-length traces from linking. */Span fooSpan barAndFooSpan fooAndBazAndQuxSpan barAndFooAndBazAndQux/** This test makes sure that annotation queries pay attention to which host recorded data */Span trace1Span trace1ServerSpan trace2Span trace2Server/** limit should apply to traces closest to endTs *//** Traces whose root span has timestamps between (endTs - lookback) and endTs are returned */String traceId1String traceId3long offsetMicrosSpan targzSpan tarSpan gzSpan zip// Ensure the implementation didn't accidentally do I/O at assembly time.// no problem to clone a call// 64-bit trace ID// 128-bit trace ID prefixed by above// Different 128-bit trace ID prefixed by above// add a trace with the same trace ID truncated to 64 bits, except different service names.// add a trace with the same trace ID truncated to 64 bits, except the span name.// so this doesn't die on cassandra v1// Make a span that's over 1KiB in size// read back to ensure the data wasn't truncated// Intentionally store in two fragments to try to trigger storage problems with dots// instead of since epoch// Min duration is inclusive and is applied by service.// Duration bounds aren't limited to root spans: they apply to all spans by service in a trace// Remote service name should apply to the duration filter// Span name should apply to the duration filter// Max duration should filter our longer spans from the same service// Index the service name but no timestamp of any sort// now store the timestamped span// assertGetTracesReturns does recursive comparison// fetch by time based annotation, find trace// should find traces by a tag// would be foo bar, except lexicographically bar precedes foo// ensure we can search only by tag key// Sanity check// We only return traces where the service specified caused the data queried.// tags are returned on annotation queries// We only return traces where the service specified caused the tag queried.// to make sure queries look back properly/** Base heavy tests for {@link SpanStore} implementations. Subtypes should create a connection to a ... */// Bugs have happened in the past where trace limit was mistaken for span count.Span[] spansspans.length/** Formerly, a bug was present where cassandra didn't index more than bucket count traces per ... */Span[] tracestraces.lengthimport Traceimport static Boolean.TRUE/** Base class for all {@link StorageComponent} integration tests. */T storage, ...;initializeStoragePerTest(...)doInitializeStorage(...)T storageconfigureStorageForTest(...)/** Sets the test to initialise the {@link StorageComponent} before each test rather than the test ... *//** Returns a new {@link StorageComponent.Builder} for connecting to the backend for the test. *//** Configures a {@link StorageComponent.Builder} with parameters for the test being executed. */subList(...)// Blocks between writes of 100 spans to help avoid readback problems./** Clears store between tests. */usingRecursiveFieldByFieldElementComparator(...)sortTraces(...)sortTrace(...)List<Span> resultsList<List<Span>> resultsint countReturned/** Override for storage that does upserts and cannot return the original spans. *//** Used to help tests from colliding too much */returnsRawSpans(...)int traceIdint idint sharedint timestampint durationint name// TODO(anuraaga): It wouldn't be difficult to allow storage builders to be parameterized by// their storage type.// Sort so that tests aren't flakey. Spans are not required to be in any order by contract.// However, when writing tests, we shouldn't use data that can appear in random order./** Base test for when {@link StorageComponent.Builder#strictTraceId(boolean) strictTraceId == ... */acceptMixedTrace(...)retrievesBy64Or128BitTraceId(...)reverse(...)String downgraded/** current implementation cannot return exact form reported */Span with128BitId1Span with64BitId1Span with128BitId2Span with64BitId2Span with128BitId3Span with64BitId3List<Span>[] trace1And3// search by 128-bit side's service and data// search by 64-bit side's service and data// iterate after the outbound client span, emulating a server that downgraded/** Base test for {@link Traces}. ... */List<String> traceIdsList<String> shortTraceIdsnew Function<String,String>(...) { ... }/** Ideally, storage backends can deduplicate identical documents as this will prevent some ... */// assertGetTraceReturns does recursive comparison// simulate a re-processed messageimport Mockimport MockitoJUnitimport MockitoRuleimport static ArgumentMatchers.isAimport static ArgumentMatchers.isNullrule(...)MockitoRule mocks, ...;Callback<> callback, ...;Call<String> callisA(...)int tryCountAtomicInteger executeOrSubmitExecutorService execList<Runnable> triesnew ArrayList<Runnable>(...)new Callback<>(...) { ... }incrementAndGet(...)new Consumer<Runnable>(...) { ... }Call<List<String>> callisNotSameAs(...)Call<String> fooCallCall<String> fooBarCallnew Mapper<String,String>(...) { ... }Call<String> barCallnew FlatMapper<String,String>(...) { ... }Call<String> exceptionCallerrorCall(...)IllegalArgumentException exceptionCall<String> errorCallCall<String> resolvedCallnew ErrorHandler<String>(...) { ... }NoSuchElementException exceptionCall<List<String>> resolvedCallnew ErrorHandler<List<String>>(...) { ... }new Call<>.Base<T>(...) { ... }Call<>.Base<T>// to instantiate the chain./** Many getPort operations return -1 by default. Leniently coerse to null. */Builder newBuildergetByName(...)assertExpectedIpv4(...)/** This ensures we don't mistake IPv6 localhost for a mapped IPv4 0.0.0.1 *//** This is an unusable compat Ipv4 of 0.0.0.2. This makes sure it isn't mistaken for localhost *//** The integer arg of port should be a whole number *//** The integer arg of port should fit in a 16bit unsigned value *//** Catches common error when zero is passed instead of null for a port */Span span1, ...;Span span2, ...;decoderForMessage(...)UnsupportedOperationException.class/** Single-element reads were for legacy non-list encoding. Don't add new code that does this *//** We encoded incorrectly for years, so we have to read this data eventhough it is wrong. ... *//** There is no difference between a list of size one and a single element in proto3 */// We made a typo.. it should have been 12import ObjectInputStreamimport ObjectOutputStreamimport static MapEntry.entryimport static Span.normalizeTraceIdSpan base, ...;Span oneOfEach, ...;Span with128BitIdlocalEndpoint(...).localEndpointremoteEndpoint(...).remoteEndpointFRONTEND.serviceNameBACKEND.serviceNameSpan withParentBuilder builder2/** Catches common error when zero is passed instead of null for a timestamp */Span primitivesSpan objectsisEqualToComparingFieldByField(...)Span nullsSpan zerosSpan mergedoneOfEach.annotationsmerged.annotationscontainsAllEntriesOf(...)oneOfEach.tagsmerged.tags/** Test serializable as used in spark jobs. Careful to include all non-standard fields */ByteArrayOutputStream bufferwriteObject(...)new ObjectOutputStream(...)readObject(...)new ObjectInputStream(...)/** Some tools like rsocket redundantly pass high bits as zero. *//** Prevents processing tools from looping */base.idrandomUUID(...)// note: annotations don't also have endpoints, as it is implicit to Span.localEndpointList<byte[]> encoded// an entry in a list is a repeated field// per ListOfSpans in zipkin2.proto/* [] *//* , */import Kryoimport Serializerimport Inputimport Outputimport JavaSerializerKryo kryonew Kryo(...)Output outputnew Output(...)getBuffer(...)new JavaSerializer(...)new Input(...)DependencyLink.class/** Example test for how to use Kryo and reuse our encoders */byte[] jsonjson.lengthnew JsonV2SpanSerializer(...)import static SpanBytesEncoderTest.ERROR_SPANimport static SpanBytesEncoderTest.LOCAL_SPANimport static SpanBytesEncoderTest.NO_ANNOTATIONS_ROOT_SERVER_SPANimport static SpanBytesEncoderTest.SPANimport static SpanBytesEncoderTest.UTF8_SPANimport static SpanBytesEncoderTest.UTF_8byte[] encodedcopyOfRange(...)/** Particulary, thrift can mistake malformed content as a huge list. Let's not blow up. */ByteBuffer bufallocateDirect(...)flip(...)byte[] arrayList<Span> tenClientSpansnCopies(...)byte[] with128BitTraceIdbyte[] withLower64bitsTraceId// instead of throwing an exceptionimport Proto3SpanWriterTest/** This test is intentionally sensitive to ensure our custom encoders do not break in subtle ways. ... */Span SPAN, ...;/** Similar to {@link TestObjects#CLIENT_SPAN} except with fixed timestamps to ensure easy testing ... */Span UTF8_SPAN, ...;Span NO_ANNOTATIONS_ROOT_SERVER_SPAN, ...;Span LOCAL_SPAN, ...;Span ERROR_SPAN, ...;/** the following skeletal span is used in dependency linking */// tag key includes a quote and value newlines/** V1 tests for {@link SpanBytesDecoderTest} */byte[] emptyListLiteralSpan decoded/* TYPE_STRUCT *//* zero length */Call<Void> call1, ...;AggregateCall<>.AggregateVoidCall.classAggregateCall<>.AggregateVoidCallsuccessCallback(...)IllegalArgumentException ex/** This shows that regardless of success or error, we block on completion */CountDownLatch callsLatchAtomicReference<Object> resultnew AtomicReference<Object>(...)boolean fail, ...;this.failnew LatchCall(...)hasValue(...)errorCallback(...)new AggregateDependencyLinks(...)Callback<List<DependencyLink>> callback// this is the part we are testing, that we can peform a finish step// one down// two down// wait for threads to finishimport static DateUtil.midnightUTCDateFormat iso8601Date datelong midnightnew Date(...)/** Looking back earlier than 1970 is likely a bug */import AtomicLongimport LongStreamimport SuppressionFactoryimport static TimeUnit.SECONDSnew SuppressionFactory(...) { ... }new DelayLimiter<Long>(...)long NANOS_PER_SECOND, ...;long nanoTime, ...;DelayLimiter<Long> delayLimiter, ...;long countdelayLimiter.cardinalitylong ihasSameSizeAs(...)delayLimiter.suppressionsdelayLimiter.cacheAtomicLong trueCountnew AtomicLong(...)new LongConsumer(...) { ... }DelayLimiter<>.Builder// eldest evicted// youngest not evicted// verify internal stateDependencyLink abDependencyLink cdDependencies dependenciesByteBuffer bytestoThrift(...)fromThrift(...)new Logger(...) { ... }setLevel(...)Level.ALLLevel.FINE// in reverse order as reporting is more likely to occur this wayList<String> messages, ...;/** Trace id is not required to be a span id. For example, some instrumentation may create separate ... */List<Span> differentTraceId/** Some don't propagate the server's parent ID which creates a race condition. Try to unwind it. ... *//** In case of a late error, we should know which trace ID is being processed *//** This test shows that if a parent ID is stored late (ex because it wasn't propagated), the span ... */List<Span> withLateParentList<Span> lostClientOrphan/** Shows we don't assume there's a direct link between producer and consumer. *//** When a server is the child of a producer span, make a link as it is really an RPC *//** Servers most often join a span vs create a child. Make sure this works when a producer is used ... *//** Client might be used for historical reasons instead of PRODUCER. Don't link as the server-side ... *//** A root span can be a client-originated trace or a server receipt which knows its peer. In these ... */List<Span> validRootSpans/** Spans don't always include both the client and server service. When you know the kind, you can ... *//** Spans are sometimes intermediated by an unknown type of span. Prefer the nearest server when ... *//** Tag indicates a failed span, not an annotation *//** A loopback span is direction-agnostic, so can be linked properly regardless of kind. *//** A dependency link is between two services. We cannot link if we don't know both service names. */List<Span> incompleteRootSpansString missingParentId/** Client+Server spans that don't share IDs are treated as server spans missing their peer */List<Span> singleHostSpans/** Creates a link when there's a span missing, in this case 2L which is an RPC from web to app */// below the parent ID is null as it wasn't propagated// trace is actually reported in reverse order// client span never sent// possibly a local fan-out span// there's no remote here, so we shouldn't see any error countList<List<Span>> inputNumberFormatException.class// too long// too short// bad charset// uppercaseWriteBuffer.Writer<>new FooWriter(...)new Foo(...)// pretend there was a bug calculating size, ex it calculated incorrectly as to smallJsonCodec.JsonReader// cause the exception// wrote larger than size!// grab a real exception from the gson libraryimport BytesFieldimport Fixed64Fieldimport VarintFieldimport static Proto3Fields.Fieldimport static Proto3Fields.Fixed32Fieldimport static Proto3Fields.WIRETYPE_FIXED32WriteBuffer buf, ...;// bigger than needed to test sizeInBytes/** Shows we can reliably look at a byte zero to tell if we are decoding proto3 repeated fields. */Field fieldnew Field(...)field.keyfield.fieldNumberfield.wireTypeVarintField fieldBooleanField fieldUtf8Field fieldFixed64Field fieldFixed32Field fieldnew Fixed32Field(...)Integer.MIN_VALUEint unsupportedReadBuffer readBufferBytesField field// (field_number << 3) | wire_type = 1 << 3 | 2// for sanity of those looking at debugger, 4th bit + 2nd bit = 10/* tag of varint field */// max size of varint32// max size of varint64// size of 1/* tag of string field *//* len */// 12345678/* skip the key */// much larger than the buffer size/** proto messages always need a key, so the non-list form is just a single-field */import AnnotationFieldimport EndpointFieldimport TagFieldimport static Assertions.atIndex/** A map entry is an embedded messages: one for field the key and one for the value */TagField fieldAnnotationField fieldEndpointField fieldassertRoundTrip(...)atIndex(...)/* tag of embedded key field *//* tag of embedded value field *//* tag of map entry field *//* tag of timestamp field *//* 8 byte number *//* tag of value field *//* tag of annotation field *//* tag of servicename field *//* tag of ipv4 field */// octets in ipv4/* tag of ipv6 field */// octets in ipv6/* tag of port field *//* small varint *//* tag of endpoint field *//* span key *//* bytes for length of the span *//* trace ID key *//* bytes for 64-bit trace ID */// hex trace ID/* span ID key *//* bytes for 64-bit span ID */// hex span ID/* overhead of three fields *//* 64-bit fields */// easier math on the next test// (field_number << 3) | wire_type = 4 << 3 | 0// producer's index is 3// undefined kind// skips undefined kind instead of dying// serialized zero// (field_number << 3) | wire_type = 12 << 3 | 0// true// (field_number << 3) | wire_type = 13 << 3 | 0assertReadVarint32(...)ByteBuffer bufferasReadOnlyBuffer(...)ReadBuffer.Buff.classReadBuffer.BuffByteOrder.LITTLE_ENDIANassertReadVarint64(...)SpanNode a/** Ensures internal deduping occurs */SpanNode treetree.spannew ThrowingExtractor<SpanNode,Span,RuntimeException>(...) { ... }/** The following tree should traverse in alphabetical order ... */SpanNode bSpanNode cSpanNode dSpanNode eSpanNode fSpanNode gSpanNode htoIterable(...)new ThrowingExtractor<Span,String,RuntimeException>(...) { ... }/** Makes sure that the trace tree is constructed based on parent-child, not by parameter order. */assertAncestry(...)/** Same as {@link #constructsTraceTree()}, except with shared span ID */SpanNode rootbuildTree(...)current.childrencurrent.spanassertServerAncestry(...)SpanNode b_clientSpanNode b_server_barSpanNode b_server_fooList<Span> copyint treeSizeIterator<SpanNode> iterSpan s2Span s3Span s4// uses the same data as javascriptList<Span> httpTracenew ThrowingExtractor<SpanNode,String,RuntimeException>(...) { ... }// root(a) has children b, c, d// child(b) has children e, f, g// f has no children// child(g) has child h// TRACE is sorted with root span first, lets reverse them to make// sure the trace is stitched together by id.// TODO: see how spans like ^^ affect the node tree// null first// This trace was taken from the middle of a real broken one, IDs and timestamps changed// note the IP is differentcontainsExactlyInAnyOrder(...)usingFieldByFieldElementComparator(...)/** Some truncate an incoming trace ID to 64-bits. */flatExtracting(...)new ThrowingExtractor<Span,Object,RuntimeException>(...) { ... }/** Let's pretend people use crappy data, but only on the first hop. *//** If a client request is proxied by something that does transparent retried. It can be the case ... */// Same as above, but the late reported data has no parent id or endpoint// accidentally partitioned in a overly fine grain// not a good idea to send parts of a local endpoint separately, but this helps ensure data isn't// some instrumentation don't add shared flag to serversTrace.CLEANUP_COMPARATOR/** Comparators are meant to be transitive. This exploits edge cases to fool our comparator. */Endpoint aEndpointEndpoint bEndpointSpan templatenew Function<Span,Object>(...) { ... }// below the shared flag was forgotten// If there is a transitive ordering problem, TimSort will throw an IllegalArgumentException// when there are at least 32 elements.TracesAdapter adapter, ...;/** The contract for {@link zipkin2.storage.SpanStore#getTrace(java.lang.String)} is to return ... */V1JsonSpanWriter writer, ...;writesCoreAnnotations(...)writesCoreSendAnnotations(...)writesAddressBinaryAnnotation(...)import static Kind.CONSUMERimport static Kind.PRODUCER// bigger than needed to test sizeOf...[] endpointBytes, ...;int highPortbyte[] buffcontainsSequence(...)byte[] bytes2writesCoreAnnotationsNoEndpoint(...)writesBeginAnnotationNoEndpoint(...)ThriftField.TYPE_STRING/** For finagle compatibility *//** To match finagle */ThriftField.TYPE_BOOL// ipv4// port// short value of field number 1// member type of the list and an integer with the count// two annotations// timestamp// one annotation// one binary annotation// key// value// type 0 == boolean// duration// name (empty is 32 zero bits)// trace ID// trace ID high// parent ID// empty annotations// empty binary annotations// empty value// type 6 == string// serviceName (empty is 32 zero bits)// Adapted from http://stackoverflow.com/questions/8511490/calculating-length-in-utf-8-of-java-string-without-actually-encoding-itint codepointisDefined(...)String testtoChars(...)int expectedgetBytes(...).lengthint actual/** Uses test data and codepoint wrapping trick from okhttp3.FormBodyTest */char[] arrayString stringint encodedSizeString asciibyte[] emojiBytesString emojiemojiBytes.length// Test creating Buffer for a long stringlong numberByteBuffer byteBufferputLong(...)// https://developers.google.com/protocol-buffers/docs/encoding#varintsint number// skip surrogates// https://en.wikipedia.org/wiki/Mahjong_Tiles_(Unicode_block)// examples from http://utf8everywhere.org//* Long.MIN_VALUE */// largest to encode is a negative number// normal case// largest value to not require more than 2 bytes (14 bits set)// worst case is a byte longer than fixed 16// most bits// we have a total of 32 bits encodedimport Methodimport static Mockito.doNothing/** This test is intentionally brittle. It should break if we add new methods on {@link ... */getDeclaredMethods(...)ForwardingStorageComponent.classnew ThrowingExtractor<Method,String,RuntimeException>(...) { ... }concat(...)Component.classnew Function<Method,String>(...) { ... }StorageComponent forwarder, ...;CheckResult downException wayOverdoNothing(...)SpanStore spanStoreSpanStore.classAutocompleteTags autocompleteTagsAutocompleteTags.classServiceAndSpanNames serviceAndSpanNamesServiceAndSpanNames.classSpanConsumer spanConsumerSpanConsumer.classSpan oneOne, ...;Span twoOne, ...;Span zeroOne, ...;List<List<Span>> modifiable// This transform is used in cassandra v1 and filters when traces match on lower 64bits, but not// the higher ones.import static ITSpanStore.requestBuilderList<Span> earlySpansList<Span> lateSpans/** Ensures we don't overload a partition due to key equality being conflated with order */Span span4Span trace1Span1Span trace1Span2Span trace2Span1Span trace2Span2InMemoryStorage storage//sanity checksTestObjects.TODAYMap<String,String> queryparseAnnotationQuery(...).annotationQueryString annotationQuerycontainsEntry(...)TestObjects.DAYSpan foo, ...;Span barAndFoo, ...;Span fooAndBazAndQux, ...;Span barAndFooAndBazAndQux, ...;// spaces in http.path mixed with 'and'// http.path in the beginning, more spaces// @adriancole said this would be hard to parse, annotation containing spaces// annotation with spaces combined with tag// when a parameter is specified both as a tag and annotation, the tag wins because it's considered to be more// specific// also last tag winsSpan oneOneSpan oneTwonew ThrowingExtractor<List<Span>,Collection<Span>,RuntimeException>(...) { ... }Span twoOneSpan zeroOneEndpoint kafka, ...;V2SpanConverter v2SpanConverter, ...;V1SpanConverter v1SpanConverter, ...;/** This shows a historical finagle span, which has client-side socket info. *//** Buggy instrumentation can send data with missing endpoints. Make sure we can record it. *//** No special treatment for invalid core annotations: missing endpoint *//** Late flushed data on a v2 span *//** Late flushed data on a v1 v1 */Span clientV2Span serverV2/** The old v1 format had no means of saying it is shared or not. This uses lack of timestamp as a ... *//** Fix a v1 reported half in new style and half in old style, ex via a bridge *//** Intentionally create service loopback endpoints as dependency linker can correct it later if ... *//** On server spans, ignore service name on remote address binary annotation that appear loopback ... *//** shared v1 IDs for messaging spans isn't supported, but shouldn't break */Span producerSpan consumerSpan firstSpan second/** This emulates a situation in mysql where the row representing a span has the client's timestamp */// ts order retained// Sometimes, finagle does not add port info on binary annotations/tags, but does elsewhere// the v1 side owns timestamp and duration// notice v1 tags are different than the v1, and the v1's annotations aren't here// annotations as "1" instead of true// Following 3 tests show leniency for old versions of zipkin-ruby which serialized address binarycontainsOnlyNulls(...)addAnnotation(...).annotationsnew ThrowingExtractor<V1Annotation,Endpoint,RuntimeException>(...) { ... }addBinaryAnnotation(...).binaryAnnotationsnew ThrowingExtractor<V1BinaryAnnotation,Endpoint,RuntimeException>(...) { ... }HttpHeadersJsonDeserializer.classNone.classVoid.classHttpHeadersJsonSerializer.classMediaTypeJsonDeserializer.classMediaTypeJsonSerializer.classRequestHeadersJsonDeserializer.classResponseHeadersJsonDeserializer.classp22p23p24p25p26p27p28p29p30p31p32AdditionalHeaders.classConsumesGroup.classExceptionHandlers.classCorsDecoratorFactoryFunction.classCorsDecorators.classCorsDecoratorsFactoryFunction.classTypeSignatureJsonSerializer.classServer.classArmeriaSettings.classNonReactiveWebApplicationCondition.classTimedSet.classObject.classDEFAULT.classRegexAdapter.classLocaleAdapter.classSQLDialectAdapter.classStringAdapter.classExtensions.classConfiguration.classRegistrar.classAutoConfigurationImportSelector.classTypeExcludeFilter.classAutoConfigurationExcludeFilter.classBeanNameGenerator.classAnnotationScopeMetadataResolver.classComponentScan.classEnableAutoConfiguration.classOnClassCondition.classOnBeanCondition.classOnPropertyCondition.classEnableConfigurationPropertiesRegistrar.classSpringExtension.classSpringBootTestContextBootstrapper.classMockBeans.classComponentScans.classSelfTracingCondition.classThrottledStorageCondition.classThrottledStorageComponentEnhancer.classTracingStorageComponentEnhancer.classActiveMQUrlSet.classTracingSessionFactoryEnhancer.classKafkaBootstrapServersSet.classRabbitMQAddressesOrUriSet.class                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Z    L    